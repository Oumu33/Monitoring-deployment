name: "Load Average High - Performance Optimization"
description: "Runbook for handling high load average"
version: "1.0"
author: "AIOps System"

conditions:
  metric_name: "load_average"
  severity: "high"

steps:
  - name: "Check load average"
    type: "command"
    command: "uptime"
    timeout: 5
    stop_on_failure: false

  - name: "Check CPU usage by process"
    type: "command"
    command: "top -b -n 1 | head -20"
    timeout: 10
    stop_on_failure: false

  - name: "Check running processes"
    type: "command"
    command: "ps aux | wc -l"
    timeout: 5
    stop_on_failure: false

  - name: "Check zombie processes"
    type: "command"
    command: "ps aux | awk '{print $8}' | sort | uniq -c | grep Z"
    timeout: 5
    stop_on_failure: false

  - name: "Check I/O wait"
    type: "command"
    command: "iostat -x 1 3 | grep -E 'avg-cpu|Device'"
    timeout: 10
    stop_on_failure: false

  - name: "Kill zombie processes"
    type: "command"
    command: "ps aux | awk '$8 ~ /Z/ {print $2}' | xargs -r kill -9"
    timeout: 10
    stop_on_failure: false

  - name: "Kill high CPU processes (> 80%)"
    type: "command"
    command: "ps aux --sort=-%cpu | awk 'NR>1 && $3>80 {print $2}' | head -5 | xargs -r kill -15"
    timeout: 10
    stop_on_failure: false

  - name: "Reduce process priority"
    type: "command"
    command: "renice +19 -p {process_id}"
    timeout: 5
    stop_on_failure: false

  - name: "Log load recovery"
    type: "command"
    command: "echo 'Load average recovery at {timestamp}' >> /var/log/aiops-load-recovery.log"
    timeout: 5
    stop_on_failure: false
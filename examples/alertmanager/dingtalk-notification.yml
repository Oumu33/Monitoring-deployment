# é’‰é’‰æœºå™¨äººé€šçŸ¥é…ç½®

global:
  resolve_timeout: 5m

# å‘Šè­¦è·¯ç”±é…ç½®
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'dingtalk-default'

  routes:
    # ä¸¥é‡å‘Šè­¦
    - match:
        severity: critical
      receiver: 'dingtalk-critical'
      group_wait: 10s
      repeat_interval: 5m

    # è­¦å‘Šå‘Šè­¦
    - match:
        severity: warning
      receiver: 'dingtalk-warning'
      group_wait: 30s
      repeat_interval: 30m

# å‘Šè­¦æ¥æ”¶å™¨é…ç½®
receivers:
  # é»˜è®¤é’‰é’‰é€šçŸ¥
  - name: 'dingtalk-default'
    webhook_configs:
      - url: 'http://dingtalk-webhook-adapter:8060/dingtalk/webhook1/send'
        send_resolved: true

  # ä¸¥é‡å‘Šè­¦ - é’‰é’‰ç¾¤ 1
  - name: 'dingtalk-critical'
    webhook_configs:
      - url: 'http://dingtalk-webhook-adapter:8060/dingtalk/critical/send'
        send_resolved: true

  # è­¦å‘Šå‘Šè­¦ - é’‰é’‰ç¾¤ 2
  - name: 'dingtalk-warning'
    webhook_configs:
      - url: 'http://dingtalk-webhook-adapter:8060/dingtalk/warning/send'
        send_resolved: true

# å‘Šè­¦æŠ‘åˆ¶è§„åˆ™
inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']

# ===== ä½¿ç”¨è¯´æ˜ =====
#
# 1. è·å–é’‰é’‰æœºå™¨äºº Webhook URL:
#    - æ‰“å¼€é’‰é’‰ç¾¤èŠ
#    - ç‚¹å‡»ç¾¤è®¾ç½® -> æ™ºèƒ½ç¾¤åŠ©æ‰‹ -> æ·»åŠ æœºå™¨äºº -> è‡ªå®šä¹‰æœºå™¨äºº
#    - è®¾ç½®å®‰å…¨è®¾ç½®ï¼ˆæ¨èä½¿ç”¨åŠ ç­¾æ–¹å¼ï¼‰
#    - å¤åˆ¶ Webhook åœ°å€å’ŒåŠ ç­¾å¯†é’¥
#
# 2. éƒ¨ç½² prometheus-webhook-dingtalk é€‚é…å™¨
#
# 3. é…ç½®é€‚é…å™¨çš„ config.yml
#
# 4. é’‰é’‰æœºå™¨äººå®‰å…¨è®¾ç½®:
#    - è‡ªå®šä¹‰å…³é”®è¯: é…ç½® "å‘Šè­¦" å…³é”®è¯
#    - åŠ ç­¾: æ¨èä½¿ç”¨ï¼Œæ›´å®‰å…¨
#    - IP åœ°å€æ®µ: å¯é€‰
#
# 5. æµ‹è¯•å‘Šè­¦:
#    curl -H "Content-Type: application/json" -d '[{
#      "labels": {
#        "alertname": "TestAlert",
#        "severity": "critical"
#      },
#      "annotations": {
#        "summary": "è¿™æ˜¯ä¸€æ¡æµ‹è¯•å‘Šè­¦"
#      }
#    }]' http://localhost:9093/api/v1/alerts

# ===== åœ¨ docker-compose.yaml ä¸­æ·»åŠ é’‰é’‰é€‚é…å™¨ =====
#
# dingtalk-webhook-adapter:
#   image: timonwong/prometheus-webhook-dingtalk:latest
#   container_name: dingtalk-webhook-adapter
#   ports:
#     - "8060:8060"
#   volumes:
#     - ./config/dingtalk-adapter/config.yml:/etc/prometheus-webhook-dingtalk/config.yml
#   command:
#     - "--config.file=/etc/prometheus-webhook-dingtalk/config.yml"
#   restart: unless-stopped
#   networks:
#     - monitoring

# ===== é’‰é’‰é€‚é…å™¨é…ç½®æ–‡ä»¶ç¤ºä¾‹ =====
# æ–‡ä»¶è·¯å¾„: config/dingtalk-adapter/config.yml
#
# templates:
#   - /etc/prometheus-webhook-dingtalk/templates/default.tmpl
#
# targets:
#   # é»˜è®¤é’‰é’‰ç¾¤
#   webhook1:
#     url: https://oapi.dingtalk.com/robot/send?access_token=YOUR_ACCESS_TOKEN
#     secret: YOUR_SECRET  # åŠ ç­¾å¯†é’¥ï¼ˆå¯é€‰ï¼‰
#
#   # ä¸¥é‡å‘Šè­¦ç¾¤
#   critical:
#     url: https://oapi.dingtalk.com/robot/send?access_token=CRITICAL_ACCESS_TOKEN
#     secret: CRITICAL_SECRET
#
#   # è­¦å‘Šå‘Šè­¦ç¾¤
#   warning:
#     url: https://oapi.dingtalk.com/robot/send?access_token=WARNING_ACCESS_TOKEN
#     secret: WARNING_SECRET
#
# ===== è‡ªå®šä¹‰æ¶ˆæ¯æ¨¡æ¿ =====
# æ–‡ä»¶è·¯å¾„: config/dingtalk-adapter/templates/custom.tmpl
#
# {{ define "ding.link.title" }}
# {{ if eq .Status "firing" }}ğŸ”¥ å‘Šè­¦è§¦å‘{{ else }}âœ… å‘Šè­¦æ¢å¤{{ end }}
# {{ end }}
#
# {{ define "ding.link.content" }}
# ### {{ if eq .Status "firing" }}ğŸ”¥ å‘Šè­¦è§¦å‘{{ else }}âœ… å‘Šè­¦æ¢å¤{{ end }}
#
# {{ range .Alerts }}
# **å‘Šè­¦åç§°:** {{ .Labels.alertname }}
# **å‘Šè­¦çº§åˆ«:** {{ .Labels.severity }}
# **å®ä¾‹:** {{ .Labels.instance }}
# **æ‘˜è¦:** {{ .Annotations.summary }}
# **æè¿°:** {{ .Annotations.description }}
# **è§¦å‘æ—¶é—´:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
# {{ if ne .Status "firing" }}**æ¢å¤æ—¶é—´:** {{ .EndsAt.Format "2006-01-02 15:04:05" }}{{ end }}
# ---
# {{ end }}
# {{ end }}

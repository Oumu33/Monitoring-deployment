# 企业微信机器人通知配置

global:
  resolve_timeout: 5m

# 告警路由配置
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'wechat-default'

  routes:
    # 严重告警 - 立即通知
    - match:
        severity: critical
      receiver: 'wechat-critical'
      group_wait: 10s
      repeat_interval: 5m

    # 警告告警 - 正常通知
    - match:
        severity: warning
      receiver: 'wechat-warning'
      group_wait: 30s
      repeat_interval: 30m

# 告警接收器配置
receivers:
  # 默认企业微信通知
  - name: 'wechat-default'
    webhook_configs:
      - url: 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_WEBHOOK_KEY'
        send_resolved: true
        http_config:
          follow_redirects: true
        # 自定义消息模板
        # 注意：企业微信 webhook 需要使用 markdown 格式
        max_alerts: 0  # 不限制告警数量

  # 严重告警 - 企业微信群 1
  - name: 'wechat-critical'
    webhook_configs:
      - url: 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=CRITICAL_WEBHOOK_KEY'
        send_resolved: true

  # 警告告警 - 企业微信群 2
  - name: 'wechat-warning'
    webhook_configs:
      - url: 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=WARNING_WEBHOOK_KEY'
        send_resolved: true

# 告警抑制规则
inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']

# ===== 使用说明 =====
#
# 1. 获取企业微信机器人 Webhook URL:
#    - 打开企业微信群聊
#    - 点击群设置 -> 群机器人 -> 添加机器人
#    - 复制 Webhook 地址中的 key 参数
#
# 2. 替换配置中的 YOUR_WEBHOOK_KEY
#
# 3. 企业微信机器人支持的消息格式:
#    - text (纯文本)
#    - markdown (支持 markdown 格式)
#    - image (图片)
#    - news (图文)
#
# 4. 由于 Alertmanager 原生不支持企业微信的消息格式，
#    建议使用 prometheus-webhook-dingtalk 项目作为中间件:
#    https://github.com/timonwong/prometheus-webhook-dingtalk
#
# 5. 使用中间件的配置示例:
#    receivers:
#      - name: 'wechat'
#        webhook_configs:
#          - url: 'http://webhook-adapter:8060/dingtalk/webhook1/send'
#            send_resolved: true
#
# 6. 测试告警:
#    curl -H "Content-Type: application/json" -d '[{
#      "labels": {
#        "alertname": "TestAlert",
#        "severity": "critical"
#      },
#      "annotations": {
#        "summary": "这是一条测试告警"
#      }
#    }]' http://localhost:9093/api/v1/alerts

# ===== 企业微信 Webhook 适配器部署 =====
#
# 在 docker-compose.yaml 中添加:
#
# wechat-webhook-adapter:
#   image: timonwong/prometheus-webhook-dingtalk:latest
#   container_name: wechat-webhook-adapter
#   ports:
#     - "8060:8060"
#   volumes:
#     - ./config/webhook-adapter/config.yml:/etc/prometheus-webhook-dingtalk/config.yml
#   command:
#     - "--config.file=/etc/prometheus-webhook-dingtalk/config.yml"
#   restart: unless-stopped
#   networks:
#     - monitoring
#
# webhook-adapter 配置文件 (config/webhook-adapter/config.yml):
#
# targets:
#   webhook1:
#     url: https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY
#   webhook2:
#     url: https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=ANOTHER_KEY

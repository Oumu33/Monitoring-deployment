# VictoriaMetrics 监控系统性能优化配置
# 文件路径: /etc/sysctl.d/99-monitoring.conf
# 应用方式: sudo sysctl -p /etc/sysctl.d/99-monitoring.conf

# ===== 网络性能优化 =====

# TCP 连接队列大小
net.core.somaxconn = 32768
net.core.netdev_max_backlog = 16384
net.ipv4.tcp_max_syn_backlog = 8192

# TCP 性能参数
net.ipv4.tcp_slow_start_after_idle = 0
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_keepalive_probes = 3

# TCP 缓冲区大小
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864

# 本地端口范围
net.ipv4.ip_local_port_range = 10000 65535

# TCP 拥塞控制
net.ipv4.tcp_congestion_control = bbr
net.core.default_qdisc = fq

# ===== 内存管理优化 =====

# 降低 swap 使用
vm.swappiness = 10

# 脏页管理
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5
vm.dirty_expire_centisecs = 500
vm.dirty_writeback_centisecs = 100

# 内存过度分配
vm.overcommit_memory = 1

# ===== 文件系统优化 =====

# 文件描述符最大数量
fs.file-max = 2097152

# inotify 限制
fs.inotify.max_user_watches = 524288
fs.inotify.max_user_instances = 512

# AIO 限制
fs.aio-max-nr = 1048576

# ===== 内核参数优化 =====

# 进程最大数
kernel.pid_max = 4194304

# 共享内存
kernel.shmmax = 68719476736
kernel.shmall = 4294967296

# 线程数限制
kernel.threads-max = 4194304

# ===== 其他优化 =====

# conntrack 表大小
net.netfilter.nf_conntrack_max = 1048576
net.nf_conntrack_max = 1048576

# 说明
# 1. 此配置适用于中大型监控环境
# 2. 根据实际硬件配置调整参数
# 3. 应用后需重启系统或相关服务生效
# 4. 定期监控系统性能指标,根据需要调整

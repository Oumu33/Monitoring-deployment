# ===================================================================
# Syslog-NG 配置文件
# 用途: 接收网络设备 Syslog 并转发到 Loki
# 文档: https://www.syslog-ng.com/technical-documents/doc/syslog-ng-open-source-edition/
# ===================================================================

@version: 3.38
@include "scl.conf"

# ===== 选项配置 =====
options {
    # 线程数
    threaded(yes);

    # 链式主机名
    chain_hostnames(no);

    # 保持主机名
    keep_hostname(yes);

    # 统计信息
    stats_freq(43200);

    # 日志级别
    log_level(info);
};

# ===== 数据源（Source）=====

# UDP 514 端口（标准 Syslog）
source s_network_udp {
    network(
        ip("0.0.0.0")
        port(514)
        transport("udp")
        flags(no-parse)
    );
};

# TCP 514 端口（可靠传输）
source s_network_tcp {
    network(
        ip("0.0.0.0")
        port(514)
        transport("tcp")
        flags(no-parse)
        max-connections(1000)
    );
};

# UDP 6514 端口（Cisco 设备常用）
source s_network_cisco {
    network(
        ip("0.0.0.0")
        port(6514)
        transport("udp")
        flags(no-parse)
    );
};

# ===== 过滤器（Filter）=====

# Cisco 设备
filter f_cisco {
    match("cisco|IOS|NX-OS" value("MESSAGE") flags(ignore-case));
};

# Arista 设备
filter f_arista {
    match("arista|EOS" value("MESSAGE") flags(ignore-case));
};

# Juniper 设备
filter f_juniper {
    match("juniper|JUNOS" value("MESSAGE") flags(ignore-case));
};

# 告警级别日志（Error/Warning/Critical）
filter f_alert {
    level(err..emerg);
};

# ===== 目标（Destination）=====

# 写入本地文件（按设备 IP 分类）
destination d_file_by_host {
    file(
        "/var/log/network-devices/${HOST}/${YEAR}-${MONTH}-${DAY}.log"
        create_dirs(yes)
        dir_perm(0755)
        perm(0644)
    );
};

# 写入按厂商分类的文件
destination d_file_cisco {
    file("/var/log/network-devices/cisco/${HOST}.log" create_dirs(yes));
};

destination d_file_arista {
    file("/var/log/network-devices/arista/${HOST}.log" create_dirs(yes));
};

destination d_file_juniper {
    file("/var/log/network-devices/juniper/${HOST}.log" create_dirs(yes));
};

# 转发到 Promtail（通过文件）
# Promtail 会监控这些文件并发送到 Loki
destination d_promtail_all {
    file(
        "/var/log/network-devices/all-devices.log"
        template("${ISODATE} ${HOST} ${FACILITY}.${PRIORITY} ${PROGRAM}: ${MESSAGE}\n")
        perm(0644)
    );
};

# 只转发告警级别日志
destination d_promtail_alerts {
    file(
        "/var/log/network-devices/alerts.log"
        template("${ISODATE} ${HOST} ${FACILITY}.${PRIORITY} ${PROGRAM}: ${MESSAGE}\n")
        perm(0644)
    );
};

# ===== 日志路由（Log Path）=====

# 所有网络日志按主机存储
log {
    source(s_network_udp);
    source(s_network_tcp);
    source(s_network_cisco);
    destination(d_file_by_host);
};

# 转发所有日志到 Promtail
log {
    source(s_network_udp);
    source(s_network_tcp);
    source(s_network_cisco);
    destination(d_promtail_all);
};

# 只转发告警级别日志
log {
    source(s_network_udp);
    source(s_network_tcp);
    source(s_network_cisco);
    filter(f_alert);
    destination(d_promtail_alerts);
};

# Cisco 设备单独存储
log {
    source(s_network_udp);
    source(s_network_tcp);
    filter(f_cisco);
    destination(d_file_cisco);
};

# Arista 设备单独存储
log {
    source(s_network_udp);
    source(s_network_tcp);
    filter(f_arista);
    destination(d_file_arista);
};

# Juniper 设备单独存储
log {
    source(s_network_udp);
    source(s_network_tcp);
    filter(f_juniper);
    destination(d_file_juniper);
};

# ===================================================================
# 配置说明:
#
# 1. 端口配置:
#    - 514 UDP/TCP: 标准 Syslog
#    - 6514 UDP: Cisco 设备常用
#
# 2. 日志存储策略:
#    - 按主机 IP 分类: /var/log/network-devices/{HOST}/
#    - 按厂商分类: /var/log/network-devices/{vendor}/
#    - 转发给 Promtail: /var/log/network-devices/all-devices.log
#
# 3. 网络设备配置示例:
#
#    Cisco IOS:
#      logging host 192.168.1.X
#      logging trap informational
#
#    Arista EOS:
#      logging host 192.168.1.X
#      logging level informational
#
#    Juniper Junos:
#      set system syslog host 192.168.1.X any info
#
# 4. Promtail 配置:
#    需要在 promtail.yml 中添加:
#      - __path__: /var/log/network-devices/*.log
#
# ===================================================================

# ===================================================================
# Telegraf gNMI 配置文件
# 作用: 采集支持 gNMI 的网络设备遥测数据（Streaming Telemetry）
# 文档: https://github.com/influxdata/telegraf/tree/master/plugins/inputs/gnmi
# ===================================================================

# ===== 全局配置 =====
[agent]
  # 数据收集间隔（gNMI 使用订阅推送，此参数影响批量发送）
  interval = "10s"

  # 数据刷新间隔
  flush_interval = "10s"

  # 主机名标签
  hostname = "telegraf-gnmi"

  # 不收集 telegraf 自身指标（避免冲突）
  omit_hostname = false

# ===================================================================
# gNMI 输入插件配置
# ===================================================================

# ===== 示例 1: Cisco IOS-XR 设备 =====
# 适用于: Cisco ASR 9000, NCS 5500, 8000 等

[[inputs.gnmi]]
  ## 设备地址列表（格式: IP:PORT）
  ## Cisco IOS-XR 默认端口: 57400
  ## Juniper Junos 默认端口: 32767
  ## Arista EOS 默认端口: 6030
  addresses = [
    # "192.168.1.100:57400",  # Cisco 核心路由器
    # "192.168.1.101:57400",  # Cisco 汇聚交换机
  ]

  ## 认证信息
  username = "admin"
  password = "password"  # 建议使用环境变量: ${GNMI_PASSWORD}

  ## TLS 配置
  enable_tls = true
  insecure_skip_verify = true  # 生产环境建议配置证书
  # tls_ca = "/etc/telegraf/ca.pem"
  # tls_cert = "/etc/telegraf/cert.pem"
  # tls_key = "/etc/telegraf/key.pem"

  ## 编码格式
  ## - proto: Protocol Buffers（推荐，高效）
  ## - json: JSON（调试用）
  encoding = "proto"

  ## Redial 配置（连接断开后重连）
  redial = "20s"

  ## 全局标签
  [inputs.gnmi.tags]
    device_type = "router"
    vendor = "cisco"
    location = "dc1"

  # ----- 订阅 1: 接口统计信息 -----
  # OpenConfig 标准路径（适用于所有支持 OpenConfig 的厂商）
  [[inputs.gnmi.subscription]]
    ## 订阅名称（用于调试和日志）
    name = "interface_counters"

    ## Origin（数据来源）
    ## - openconfig: OpenConfig 标准模型
    ## - rfc7951: IETF 标准
    ## - <vendor>: 厂商私有模型
    origin = "openconfig"

    ## YANG 数据路径
    path = "/interfaces/interface/state/counters"

    ## 订阅模式
    ## - sample: 按固定间隔采样
    ## - on_change: 数据变化时推送
    ## - target_defined: 设备自定义
    subscription_mode = "sample"

    ## 采样间隔（仅 sample 模式）
    sample_interval = "10s"

  # ----- 订阅 2: 接口操作状态 -----
  [[inputs.gnmi.subscription]]
    name = "interface_state"
    origin = "openconfig"
    path = "/interfaces/interface/state"
    subscription_mode = "on_change"  # 状态变化时立即推送

  # ----- 订阅 3: CPU 利用率 -----
  [[inputs.gnmi.subscription]]
    name = "cpu_utilization"
    origin = "openconfig"
    path = "/components/component/cpu/utilization/state"
    subscription_mode = "sample"
    sample_interval = "5s"

  # ----- 订阅 4: 内存使用率 -----
  [[inputs.gnmi.subscription]]
    name = "memory_utilization"
    origin = "openconfig"
    path = "/components/component/state/memory"
    subscription_mode = "sample"
    sample_interval = "10s"

  # ----- 订阅 5: BGP 邻居状态 -----
  # [[inputs.gnmi.subscription]]
  #   name = "bgp_neighbors"
  #   origin = "openconfig"
  #   path = "/network-instances/network-instance/protocols/protocol/bgp/neighbors"
  #   subscription_mode = "on_change"


# ===== 示例 2: Arista EOS 设备 =====
# [[inputs.gnmi]]
#   addresses = ["192.168.1.110:6030"]
#   username = "admin"
#   password = "arista"
#   enable_tls = false  # Arista EOS 可以配置为非 TLS
#   encoding = "proto"
#   redial = "20s"
#
#   [inputs.gnmi.tags]
#     device_type = "switch"
#     vendor = "arista"
#     location = "dc1"
#     tier = "core"
#
#   [[inputs.gnmi.subscription]]
#     name = "interface_counters"
#     origin = "openconfig"
#     path = "/interfaces/interface/state/counters"
#     subscription_mode = "sample"
#     sample_interval = "10s"


# ===== 示例 3: Juniper Junos 设备 =====
# [[inputs.gnmi]]
#   addresses = ["192.168.1.120:32767"]
#   username = "admin"
#   password = "juniper"
#   enable_tls = true
#   insecure_skip_verify = true
#   encoding = "proto"
#   redial = "20s"
#
#   [inputs.gnmi.tags]
#     device_type = "router"
#     vendor = "juniper"
#     location = "dc2"
#
#   [[inputs.gnmi.subscription]]
#     name = "interface_stats"
#     origin = "openconfig"
#     path = "/interfaces/interface/state/counters"
#     subscription_mode = "sample"
#     sample_interval = "10s"


# ===================================================================
# 输出插件配置
# ===================================================================

# ----- 输出到 VictoriaMetrics -----
[[outputs.http]]
  ## VictoriaMetrics 写入地址
  url = "http://victoriametrics:8428/api/v1/write"

  ## 数据格式（使用 Prometheus Remote Write 协议）
  data_format = "prometheusremotewrite"

  ## HTTP 方法
  method = "POST"

  ## 超时时间
  timeout = "10s"

  ## 添加全局标签
  [outputs.http.tagpass]
    # 只输出 gNMI 相关的数据
    # source = ["gnmi"]

  ## HTTP Headers
  [outputs.http.headers]
    Content-Type = "application/x-protobuf"
    Content-Encoding = "snappy"


# ----- 输出到控制台（调试用）-----
# [[outputs.file]]
#   files = ["stdout"]
#   data_format = "influx"


# ===================================================================
# 常用 OpenConfig YANG 路径参考
# ===================================================================
#
# 接口相关:
# - /interfaces/interface/state/counters              # 接口计数器
# - /interfaces/interface/state/oper-status           # 接口状态
# - /interfaces/interface/state/admin-status          # 管理状态
# - /interfaces/interface/subinterfaces/subinterface  # 子接口
#
# 系统资源:
# - /components/component/cpu/utilization/state       # CPU 使用率
# - /components/component/state/memory                # 内存
# - /components/component/state/temperature           # 温度
#
# 路由协议:
# - /network-instances/network-instance/protocols/protocol/bgp  # BGP
# - /network-instances/network-instance/protocols/protocol/ospf # OSPF
#
# LLDP:
# - /lldp/interfaces/interface/neighbors              # LLDP 邻居
#
# QoS:
# - /qos/interfaces/interface/output/queues           # 输出队列
#
# 光模块:
# - /components/component/transceiver                 # 光模块信息
#
# ===================================================================
# 厂商特定路径（非 OpenConfig）
# ===================================================================
#
# Cisco IOS-XR:
# - origin = "Cisco-IOS-XR-infra-statsd-oper"
# - path = "/infra-statistics/interfaces/interface/latest/generic-counters"
#
# Juniper Junos:
# - origin = "junos"
# - path = "/junos/system/linecard/interface/logical/usage"
#
# Huawei:
# - origin = "huawei-devm"
# - path = "/devm/cpuInfos"
#
# ===================================================================
# 订阅模式说明
# ===================================================================
#
# 1. SAMPLE（采样模式）:
#    - 按固定时间间隔推送数据
#    - 适用于: 流量统计、CPU/内存使用率
#    - 示例: sample_interval = "10s"
#
# 2. ON_CHANGE（变化推送）:
#    - 数据变化时立即推送
#    - 适用于: 接口状态、BGP 邻居、告警
#    - 优点: 实时性强、网络开销低
#
# 3. TARGET_DEFINED（设备自定义）:
#    - 由设备决定推送频率
#    - 不推荐使用（不可预测）
#
# ===================================================================
# 性能优化建议
# ===================================================================
#
# 1. 合理设置采样间隔:
#    - 高频数据（CPU）: 5s
#    - 中频数据（流量）: 10s
#    - 低频数据（状态）: 60s 或 on_change
#
# 2. 使用 on_change 模式:
#    - 对于状态类数据（接口 up/down、BGP 邻居）
#    - 减少不必要的数据传输
#
# 3. 路径优化:
#    - 只订阅需要的路径
#    - 避免订阅根路径（/）
#    - 使用通配符时要谨慎
#
# 4. 编码格式:
#    - 优先使用 proto（Protocol Buffers）
#    - 比 JSON 效率高 3-10 倍
#
# 5. 批量发送:
#    - 调整 flush_interval 平衡实时性和性能
#
# ===================================================================
# 故障排查
# ===================================================================
#
# 1. 连接失败:
#    - 检查端口是否正确
#    - 验证防火墙规则
#    - 确认 TLS 配置
#
# 2. 认证失败:
#    - 检查用户名密码
#    - 确认用户权限（需要 gNMI 权限）
#
# 3. 无数据返回:
#    - 验证 YANG 路径是否正确
#    - 检查设备是否支持该路径
#    - 使用 gnmic 工具测试
#
# 4. 性能问题:
#    - 减少订阅路径
#    - 增加采样间隔
#    - 使用 proto 编码
#
# ===================================================================

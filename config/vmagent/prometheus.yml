global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'monitoring-cluster'
    environment: 'production'

scrape_configs:
  # VictoriaMetrics 自监控
  - job_name: 'victoriametrics'
    static_configs:
      - targets: ['victoriametrics:8428']
        labels:
          service: 'victoriametrics'

  # vmagent 自监控
  - job_name: 'vmagent'
    static_configs:
      - targets: ['vmagent:8429']
        labels:
          service: 'vmagent'

  # vmalert 监控
  - job_name: 'vmalert'
    static_configs:
      - targets: ['vmalert:8880']
        labels:
          service: 'vmalert'

  # Alertmanager 监控
  - job_name: 'alertmanager'
    static_configs:
      - targets: ['alertmanager:9093']
        labels:
          service: 'alertmanager'

  # Node Exporter - Linux 主机监控
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
        labels:
          service: 'node-exporter'
          instance: 'monitoring-host'
      # 添加更多 Linux 主机
      # - targets: ['192.168.1.10:9100']
      #   labels:
      #     instance: 'linux-server-01'
      # - targets: ['192.168.1.11:9100']
      #   labels:
      #     instance: 'linux-server-02'

  # SNMP Exporter - 网络设备监控
  - job_name: 'snmp-exporter'
    static_configs:
      - targets:
        # 交换机示例
        - 192.168.1.100  # 请替换为实际的设备 IP
        # - 192.168.1.101
        # 路由器示例
        # - 192.168.1.200
    metrics_path: /snmp
    params:
      module: [if_mib]  # 使用默认的 if_mib 模块
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: snmp-exporter:9116

  # 注意: Telegraf VMware 监控直接推送数据到 VictoriaMetrics
  # 不需要在此处配置采集任务

  # ===== Blackbox Exporter - 服务可用性探测 =====

  # HTTP/HTTPS 网站探测 - 文件服务发现
  - job_name: 'blackbox-http'
    metrics_path: /probe
    params:
      module: [http_2xx]  # 使用 http_2xx 模块
    file_sd_configs:
      - files:
        - /etc/prometheus/targets/websites.json
        refresh_interval: 30s
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115
      - source_labels: [__param_target]
        target_label: probe_type
        replacement: 'http'

  # HTTPS 探测（检查 SSL 证书）- 静态配置（可选）
  - job_name: 'blackbox-https-ssl'
    metrics_path: /probe
    params:
      module: [http_2xx_check_ssl]
    static_configs:
      - targets:
        # 示例: 监控 HTTPS 网站和 SSL 证书
        # - https://www.company.com
        # - https://api.company.com
        labels:
          probe_type: 'https_ssl'
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115

  # ICMP Ping 探测 - 文件服务发现（推荐）
  - job_name: 'blackbox-icmp'
    metrics_path: /probe
    params:
      module: [icmp]
    file_sd_configs:
      - files:
        - /etc/prometheus/targets/core-switches.json
        - /etc/prometheus/targets/esxi-hosts.json
        - /etc/prometheus/targets/*-switches.json  # 支持通配符
        refresh_interval: 30s
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115
      - source_labels: [__param_target]
        target_label: probe_type
        replacement: 'icmp'

  # TCP 端口探测（数据库、SSH 等）
  - job_name: 'blackbox-tcp'
    metrics_path: /probe
    params:
      module: [tcp_connect]
    static_configs:
      - targets:
        # 数据库端口探测
        # - 192.168.1.20:3306   # MySQL
        # - 192.168.1.21:5432   # PostgreSQL
        # - 192.168.1.22:6379   # Redis
        # SSH 端口探测
        # - 192.168.1.10:22
        # vCenter 端口探测
        # - vcenter.company.com:443
        labels:
          probe_type: 'tcp'
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115

  # Blackbox Exporter 自监控
  - job_name: 'blackbox-exporter'
    static_configs:
      - targets: ['blackbox-exporter:9115']
        labels:
          service: 'blackbox-exporter'

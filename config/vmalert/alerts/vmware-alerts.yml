# ===================================================================
# VMware/vSphere å‘Šè­¦è§„åˆ™
# ç”¨é€”: ç›‘æ§ VMware è™šæ‹ŸåŒ–ç¯å¢ƒï¼ˆESXiã€è™šæ‹Ÿæœºã€æ•°æ®å­˜å‚¨ï¼‰
# æ•°æ®æ¥æº: Telegraf VMware æ’ä»¶
# ===================================================================

groups:
  - name: vmware-telegraf-alerts
    interval: 60s
    rules:

      # ===== è™šæ‹Ÿæœºå‘Šè­¦ =====

      # è™šæ‹Ÿæœºå®•æœºå‘Šè­¦
      - alert: VMDown
        expr: vsphere_vm_power_state == 0
        for: 2m
        labels:
          severity: critical
          priority: P1
          category: availability
          component: vm
        annotations:
          summary: "ğŸ”´ è™šæ‹Ÿæœº {{ $labels.vmname }} å·²å…³æœº"
          description: |
            **è™šæ‹Ÿæœº**: {{ $labels.vmname }}
            **ESXi ä¸»æœº**: {{ $labels.esxhostname }}
            **é›†ç¾¤**: {{ $labels.clustername }}

            **å¯èƒ½åŸå› **:
            - æ‰‹åŠ¨å…³æœº
            - ç”µæºæ•…éšœ
            - VM è‡ªåŠ¨å…³æœºï¼ˆè„šæœ¬ï¼‰
            - ESXi ä¸»æœºæ•…éšœå¯¼è‡´

            **å¤„ç†æ­¥éª¤**:
            1. ç™»å½• vCenter æ£€æŸ¥ VM çŠ¶æ€
            2. æŸ¥çœ‹ VM äº‹ä»¶æ—¥å¿—
            3. ç¡®è®¤æ˜¯å¦è®¡åˆ’å†…å…³æœº
            4. å¦‚éè®¡åˆ’å†…ï¼Œå¯åŠ¨ VM: vCenter â†’ Power On
          runbook_url: "https://your-wiki.com/runbooks/vm-down"

      # è™šæ‹Ÿæœº CPU ä½¿ç”¨ç‡å‘Šè­¦ - Warning
      - alert: VMHighCPUWarning
        expr: vsphere_vm_cpu_usage_average > 80
        for: 10m
        labels:
          severity: warning
          priority: P2
          category: performance
          component: vm
        annotations:
          summary: "âš ï¸ è™šæ‹Ÿæœº {{ $labels.vmname }} CPU ä½¿ç”¨ç‡è¾ƒé«˜"
          description: |
            **è™šæ‹Ÿæœº**: {{ $labels.vmname }}
            **CPU ä½¿ç”¨ç‡**: {{ $value }}%
            **vCPU æ•°é‡**: {{ $labels.num_cpu }}

            **å¤„ç†æ­¥éª¤**:
            1. ç™»å½• VM æ£€æŸ¥è¿›ç¨‹å ç”¨
            2. è€ƒè™‘å¢åŠ  vCPU æ•°é‡
            3. ä¼˜åŒ–åº”ç”¨ç¨‹åº
          runbook_url: "https://your-wiki.com/runbooks/vm-high-cpu"

      # è™šæ‹Ÿæœº CPU ä½¿ç”¨ç‡å‘Šè­¦ - Critical
      - alert: VMHighCPUCritical
        expr: vsphere_vm_cpu_usage_average > 95
        for: 5m
        labels:
          severity: critical
          priority: P1
          category: performance
          component: vm
        annotations:
          summary: "ğŸ”´ è™šæ‹Ÿæœº {{ $labels.vmname }} CPU ä½¿ç”¨ç‡è¿‡é«˜"
          description: |
            **ç´§æ€¥**: CPU ä½¿ç”¨ç‡è¾¾åˆ° {{ $value }}%
            **å½±å“**: ä¸šåŠ¡å¯èƒ½å—å½±å“

            **ç«‹å³è¡ŒåŠ¨**:
            1. ç™»å½•è™šæ‹Ÿæœºæ£€æŸ¥è¿›ç¨‹
            2. ç´§æ€¥å¢åŠ  vCPUï¼ˆéœ€é‡å¯ VMï¼‰
            3. è”ç³»åº”ç”¨è´Ÿè´£äººæ’æŸ¥
          runbook_url: "https://your-wiki.com/runbooks/vm-high-cpu"

      # è™šæ‹Ÿæœºå†…å­˜ä½¿ç”¨ç‡å‘Šè­¦ - Warning
      - alert: VMHighMemoryWarning
        expr: vsphere_vm_mem_usage_average > 80
        for: 10m
        labels:
          severity: warning
          priority: P2
          category: performance
          component: vm
        annotations:
          summary: "âš ï¸ è™šæ‹Ÿæœº {{ $labels.vmname }} å†…å­˜ä½¿ç”¨ç‡è¾ƒé«˜"
          description: |
            **è™šæ‹Ÿæœº**: {{ $labels.vmname }}
            **å†…å­˜ä½¿ç”¨ç‡**: {{ $value }}%
            **é…ç½®å†…å­˜**: {{ $labels.mem_size_mb }} MB

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥è™šæ‹Ÿæœºå†…å­˜ä½¿ç”¨æƒ…å†µ
            2. è€ƒè™‘å¢åŠ å†…å­˜é…ç½®
            3. æ£€æŸ¥æ˜¯å¦æœ‰å†…å­˜æ³„æ¼
          runbook_url: "https://your-wiki.com/runbooks/vm-high-memory"

      # è™šæ‹Ÿæœºå†…å­˜ä½¿ç”¨ç‡å‘Šè­¦ - Critical
      - alert: VMHighMemoryCritical
        expr: vsphere_vm_mem_usage_average > 95
        for: 5m
        labels:
          severity: critical
          priority: P1
          category: performance
          component: vm
        annotations:
          summary: "ğŸ”´ è™šæ‹Ÿæœº {{ $labels.vmname }} å†…å­˜å³å°†è€—å°½"
          description: |
            **ç´§æ€¥**: å†…å­˜ä½¿ç”¨ç‡è¾¾åˆ° {{ $value }}%
            **é£é™©**: å¯èƒ½è§¦å‘ OOMï¼Œå¯¼è‡´è¿›ç¨‹å´©æºƒ

            **ç«‹å³è¡ŒåŠ¨**:
            1. ç™»å½•è™šæ‹Ÿæœºæ£€æŸ¥å†…å­˜
            2. ç´§æ€¥å¢åŠ å†…å­˜ï¼ˆéœ€é‡å¯ VMï¼‰
            3. é‡å¯å ç”¨å†…å­˜è¿‡å¤šçš„æœåŠ¡
          runbook_url: "https://your-wiki.com/runbooks/vm-high-memory"

      # ===== ESXi ä¸»æœºå‘Šè­¦ =====

      # ESXi ä¸»æœº CPU ä½¿ç”¨ç‡å‘Šè­¦ - Warning
      - alert: ESXiHighCPUWarning
        expr: vsphere_host_cpu_usage_average > 80
        for: 10m
        labels:
          severity: warning
          priority: P1
          category: performance
          component: esxi
        annotations:
          summary: "âš ï¸ ESXi ä¸»æœº {{ $labels.esxhostname }} CPU ä½¿ç”¨ç‡è¾ƒé«˜"
          description: |
            **ESXi ä¸»æœº**: {{ $labels.esxhostname }}
            **CPU ä½¿ç”¨ç‡**: {{ $value }}%
            **é›†ç¾¤**: {{ $labels.clustername }}

            **å½±å“èŒƒå›´**: è¯¥ä¸»æœºä¸Šæ‰€æœ‰è™šæ‹Ÿæœºæ€§èƒ½å¯èƒ½ä¸‹é™

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥ä¸»æœºä¸Š VM æ•°é‡å’Œèµ„æºåˆ†é…
            2. è€ƒè™‘è¿ç§»éƒ¨åˆ† VM åˆ°å…¶ä»–ä¸»æœº
            3. ä½¿ç”¨ DRS è‡ªåŠ¨å¹³è¡¡è´Ÿè½½
          runbook_url: "https://your-wiki.com/runbooks/esxi-high-cpu"

      # ESXi ä¸»æœº CPU ä½¿ç”¨ç‡å‘Šè­¦ - Critical
      - alert: ESXiHighCPUCritical
        expr: vsphere_host_cpu_usage_average > 95
        for: 5m
        labels:
          severity: critical
          priority: P0
          category: performance
          component: esxi
        annotations:
          summary: "ğŸ”´ ESXi ä¸»æœº {{ $labels.esxhostname }} CPU ä¸¥é‡è¿‡è½½"
          description: |
            **ç´§æ€¥**: CPU ä½¿ç”¨ç‡è¾¾åˆ° {{ $value }}%
            **å½±å“**: æ‰€æœ‰è™šæ‹Ÿæœºæ€§èƒ½ä¸¥é‡ä¸‹é™

            **ç«‹å³è¡ŒåŠ¨**:
            1. ç«‹å³ vMotion è¿ç§»éƒ¨åˆ† VM
            2. è¯†åˆ«å ç”¨ CPU æœ€å¤šçš„ VM
            3. è€ƒè™‘å…³é—­éå…³é”® VM
          runbook_url: "https://your-wiki.com/runbooks/esxi-high-cpu"

      # ESXi ä¸»æœºå†…å­˜ä½¿ç”¨ç‡å‘Šè­¦ - Warning
      - alert: ESXiHighMemoryWarning
        expr: vsphere_host_mem_usage_average > 80
        for: 10m
        labels:
          severity: warning
          priority: P1
          category: performance
          component: esxi
        annotations:
          summary: "âš ï¸ ESXi ä¸»æœº {{ $labels.esxhostname }} å†…å­˜ä½¿ç”¨ç‡è¾ƒé«˜"
          description: |
            **ESXi ä¸»æœº**: {{ $labels.esxhostname }}
            **å†…å­˜ä½¿ç”¨ç‡**: {{ $value }}%

            **å½±å“**: å¯èƒ½è§¦å‘å†…å­˜å›æ”¶ï¼ˆMemory Ballooningï¼‰

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥å†…å­˜åˆ†é…æƒ…å†µ
            2. è¿ç§»éƒ¨åˆ† VM åˆ°å…¶ä»–ä¸»æœº
            3. æ£€æŸ¥æ˜¯å¦æœ‰å†…å­˜é¢„ç•™è¿‡åº¦
          runbook_url: "https://your-wiki.com/runbooks/esxi-high-memory"

      # ESXi ä¸»æœºå†…å­˜ä½¿ç”¨ç‡å‘Šè­¦ - Critical
      - alert: ESXiHighMemoryCritical
        expr: vsphere_host_mem_usage_average > 95
        for: 5m
        labels:
          severity: critical
          priority: P0
          category: performance
          component: esxi
        annotations:
          summary: "ğŸ”´ ESXi ä¸»æœº {{ $labels.esxhostname }} å†…å­˜ä¸¥é‡ä¸è¶³"
          description: |
            **ç´§æ€¥**: å†…å­˜ä½¿ç”¨ç‡è¾¾åˆ° {{ $value }}%
            **é£é™©**: VM æ€§èƒ½ä¸¥é‡ä¸‹é™ï¼Œå¯èƒ½è§¦å‘ Swapping

            **ç«‹å³è¡ŒåŠ¨**:
            1. ç«‹å³ vMotion è¿ç§» VM
            2. å…³é—­éå…³é”® VM
            3. æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸å†…å­˜å ç”¨
          runbook_url: "https://your-wiki.com/runbooks/esxi-high-memory"

      # ===== æ•°æ®å­˜å‚¨å‘Šè­¦ =====

      # æ•°æ®å­˜å‚¨ç©ºé—´ä¸è¶³ - Warning
      - alert: DatastoreLowSpaceWarning
        expr: (vsphere_datastore_disk_used_latest / vsphere_datastore_disk_capacity_latest) * 100 > 80
        for: 10m
        labels:
          severity: warning
          priority: P2
          category: storage
          component: datastore
        annotations:
          summary: "âš ï¸ æ•°æ®å­˜å‚¨ {{ $labels.dsname }} ç©ºé—´ä¸è¶³"
          description: |
            **æ•°æ®å­˜å‚¨**: {{ $labels.dsname }}
            **å·²ä½¿ç”¨**: {{ $value | humanizePercentage }}
            **æ€»å®¹é‡**: {{ $labels.capacity }} GB

            **å½±å“**: å¯èƒ½æ— æ³•åˆ›å»ºæ–°è™šæ‹Ÿæœºæˆ–å¿«ç…§

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥æ˜¯å¦æœ‰ä¸éœ€è¦çš„å¿«ç…§
            2. æ¸…ç†æ—§çš„è™šæ‹Ÿæœº
            3. æ‰©å®¹æ•°æ®å­˜å‚¨
            4. è¿ç§»éƒ¨åˆ† VM åˆ°å…¶ä»–æ•°æ®å­˜å‚¨
          runbook_url: "https://your-wiki.com/runbooks/datastore-low-space"

      # æ•°æ®å­˜å‚¨ç©ºé—´ä¸è¶³ - Critical
      - alert: DatastoreLowSpaceCritical
        expr: (vsphere_datastore_disk_used_latest / vsphere_datastore_disk_capacity_latest) * 100 > 90
        for: 5m
        labels:
          severity: critical
          priority: P0
          category: storage
          component: datastore
        annotations:
          summary: "ğŸ”´ æ•°æ®å­˜å‚¨ {{ $labels.dsname }} ç©ºé—´ä¸¥é‡ä¸è¶³"
          description: |
            **ç´§æ€¥**: å·²ä½¿ç”¨ {{ $value | humanizePercentage }}
            **é£é™©**: VM å¯èƒ½æ— æ³•å†™å…¥ï¼Œä¸šåŠ¡ä¸­æ–­

            **ç«‹å³è¡ŒåŠ¨**:
            1. ç«‹å³åˆ é™¤å¿«ç…§
            2. æ¸…ç†æ—¥å¿—æ–‡ä»¶
            3. ç´§æ€¥æ‰©å®¹æˆ–è¿ç§» VM
          runbook_url: "https://your-wiki.com/runbooks/datastore-low-space"

      # ===== SNMP ç½‘ç»œè®¾å¤‡å‘Šè­¦ =====

      # SNMP è®¾å¤‡ä¸å¯è¾¾
      - alert: SNMPDeviceDown
        expr: up{job="snmp-exporter"} == 0
        for: 2m
        labels:
          severity: critical
          priority: P0
          category: availability
          component: network
        annotations:
          summary: "ğŸ”´ SNMP è®¾å¤‡ {{ $labels.instance }} æ— æ³•è®¿é—®"
          description: |
            **è®¾å¤‡**: {{ $labels.instance }}
            **è®¾å¤‡ç±»å‹**: {{ $labels.device_type }}

            **å¯èƒ½åŸå› **:
            - è®¾å¤‡å®•æœº
            - ç½‘ç»œä¸å¯è¾¾
            - SNMP é…ç½®é”™è¯¯

            **å¤„ç†æ­¥éª¤**:
            1. Ping è®¾å¤‡: `ping {{ $labels.instance }}`
            2. æ£€æŸ¥è®¾å¤‡ç”µæºå’Œç½‘çº¿
            3. ç™»å½•è®¾å¤‡æ§åˆ¶å°æ£€æŸ¥
          runbook_url: "https://your-wiki.com/runbooks/snmp-device-down"

      # ç½‘ç»œæ¥å£ä¸‹çº¿
      - alert: InterfaceDown
        expr: ifOperStatus == 2
        for: 2m
        labels:
          severity: warning
          priority: P2
          category: network
          component: interface
        annotations:
          summary: "âš ï¸ ç½‘ç»œæ¥å£ {{ $labels.ifDescr }} ä¸‹çº¿"
          description: |
            **è®¾å¤‡**: {{ $labels.instance }}
            **æ¥å£**: {{ $labels.ifDescr }}

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥æ¥å£é…ç½®
            2. æ£€æŸ¥ç‰©ç†è¿æ¥
            3. æŸ¥çœ‹è®¾å¤‡æ—¥å¿—
          runbook_url: "https://your-wiki.com/runbooks/interface-down"

      # ç½‘ç»œæ¥å£é”™è¯¯ç‡è¿‡é«˜
      - alert: HighInterfaceErrors
        expr: rate(ifInErrors[5m]) + rate(ifOutErrors[5m]) > 10
        for: 5m
        labels:
          severity: warning
          priority: P2
          category: network
          component: interface
        annotations:
          summary: "âš ï¸ æ¥å£ {{ $labels.ifDescr }} é”™è¯¯ç‡è¿‡é«˜"
          description: |
            **è®¾å¤‡**: {{ $labels.instance }}
            **æ¥å£**: {{ $labels.ifDescr }}
            **é”™è¯¯ç‡**: {{ $value | humanize }} åŒ…/ç§’

            **å¯èƒ½åŸå› **:
            - ç‰©ç†è¿æ¥é—®é¢˜
            - ç½‘çº¿æ•…éšœ
            - å…‰æ¨¡å—æ•…éšœ
            - é€Ÿç‡/åŒå·¥æ¨¡å¼ä¸åŒ¹é…

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥æ¥å£çŠ¶æ€
            2. æ›´æ¢ç½‘çº¿æˆ–å…‰æ¨¡å—
            3. æ£€æŸ¥é€Ÿç‡å’ŒåŒå·¥é…ç½®
          runbook_url: "https://your-wiki.com/runbooks/interface-errors"

      # ç½‘ç»œæ¥å£æµé‡è¿‡é«˜
      - alert: HighInterfaceTraffic
        expr: (rate(ifHCInOctets[5m]) * 8 / ifHighSpeed / 1000000) * 100 > 80
        for: 5m
        labels:
          severity: warning
          priority: P2
          category: network
          component: interface
        annotations:
          summary: "âš ï¸ æ¥å£ {{ $labels.ifDescr }} æµé‡è¿‡é«˜"
          description: |
            **è®¾å¤‡**: {{ $labels.instance }}
            **æ¥å£**: {{ $labels.ifDescr }}
            **æµé‡ä½¿ç”¨ç‡**: {{ $value | humanizePercentage }}

            **å¤„ç†æ­¥éª¤**:
            1. åˆ†ææµé‡æ¥æº
            2. è€ƒè™‘å‡çº§å¸¦å®½
            3. å¯ç”¨ QoS æµé‡æ§åˆ¶
          runbook_url: "https://your-wiki.com/runbooks/high-traffic"

# ===================================================================
# å‘Šè­¦è§„åˆ™è¯´æ˜:
#
# 1. VMware å‘Šè­¦ä¼˜å…ˆçº§:
#    - ESXi ä¸»æœº: P0/P1ï¼ˆå½±å“æ‰€æœ‰ VMï¼‰
#    - è™šæ‹Ÿæœº: P1/P2ï¼ˆå½±å“å•ä¸ªä¸šåŠ¡ï¼‰
#    - æ•°æ®å­˜å‚¨: P0/P2ï¼ˆå½±å“å¤šä¸ª VMï¼‰
#
# 2. å‘Šè­¦æŠ‘åˆ¶å»ºè®®:
#    - ESXi ä¸»æœºå®•æœºæ—¶ï¼ŒæŠ‘åˆ¶è¯¥ä¸»æœºä¸Šæ‰€æœ‰ VM çš„å‘Šè­¦
#    - æ•°æ®å­˜å‚¨æ•…éšœæ—¶ï¼ŒæŠ‘åˆ¶è¯¥å­˜å‚¨ä¸Šæ‰€æœ‰ VM çš„å‘Šè­¦
#
# 3. æŒ‡æ ‡æ¥æº:
#    - vsphere_* æŒ‡æ ‡æ¥è‡ª Telegraf VMware æ’ä»¶
#    - ç›´æ¥æ¨é€åˆ° VictoriaMetricsï¼Œä¸ç»è¿‡ vmagent
#
# æ›´å¤šæ–‡æ¡£: docs/VMWARE-MONITORING-GUIDE.md
# ===================================================================

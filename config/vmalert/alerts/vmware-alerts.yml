groups:
  - name: vmware-telegraf-alerts
    interval: 60s
    rules:
      # 虚拟机宕机告警
      - alert: VMDown
        expr: vsphere_vm_power_state == 0
        for: 2m
        labels:
          severity: critical
          category: vmware
        annotations:
          summary: "虚拟机 {{ $labels.vmname }} 已关机"
          description: "虚拟机 {{ $labels.vmname }} 在 ESXi 主机 {{ $labels.esxhostname }} 上处于关机状态"

      # ESXi 主机 CPU 使用率过高
      - alert: ESXiHighCPU
        expr: vsphere_host_cpu_usage_average > 90
        for: 10m
        labels:
          severity: warning
          category: vmware
        annotations:
          summary: "ESXi 主机 {{ $labels.esxhostname }} CPU 使用率过高"
          description: "ESXi 主机 {{ $labels.esxhostname }} CPU 使用率为 {{ $value | humanize }}%"

      # ESXi 主机内存使用率过高
      - alert: ESXiHighMemory
        expr: vsphere_host_mem_usage_average > 90
        for: 10m
        labels:
          severity: warning
          category: vmware
        annotations:
          summary: "ESXi 主机 {{ $labels.esxhostname }} 内存使用率过高"
          description: "ESXi 主机 {{ $labels.esxhostname }} 内存使用率为 {{ $value | humanize }}%"

      # 虚拟机 CPU 使用率过高
      - alert: VMHighCPU
        expr: vsphere_vm_cpu_usage_average > 85
        for: 10m
        labels:
          severity: warning
          category: vmware
        annotations:
          summary: "虚拟机 {{ $labels.vmname }} CPU 使用率过高"
          description: "虚拟机 {{ $labels.vmname }} CPU 使用率为 {{ $value | humanize }}%"

      # 虚拟机内存使用率过高
      - alert: VMHighMemory
        expr: vsphere_vm_mem_usage_average > 85
        for: 10m
        labels:
          severity: warning
          category: vmware
        annotations:
          summary: "虚拟机 {{ $labels.vmname }} 内存使用率过高"
          description: "虚拟机 {{ $labels.vmname }} 内存使用率为 {{ $value | humanize }}%"

      # 数据存储空间不足
      - alert: DatastoreLowSpace
        expr: (vsphere_datastore_disk_used_latest / vsphere_datastore_disk_capacity_latest) * 100 > 85
        for: 10m
        labels:
          severity: warning
          category: vmware
        annotations:
          summary: "数据存储 {{ $labels.dsname }} 空间不足"
          description: "数据存储 {{ $labels.dsname }} 已使用 {{ $value | humanize }}%"

  - name: snmp-alerts
    interval: 30s
    rules:
      # SNMP Exporter 服务宕机
      - alert: SNMPExporterDown
        expr: up{job="snmp-exporter"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "SNMP 设备 {{ $labels.instance }} 无法访问"
          description: "SNMP 设备 {{ $labels.instance }} 已经无法访问超过 2 分钟"

      # 网络设备接口下线
      - alert: InterfaceDown
        expr: ifOperStatus == 2
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "网络接口 {{ $labels.ifDescr }} 下线"
          description: "设备 {{ $labels.instance }} 的接口 {{ $labels.ifDescr }} 已下线"

      # 网络接口错误率过高
      - alert: HighInterfaceErrors
        expr: rate(ifInErrors[5m]) + rate(ifOutErrors[5m]) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "接口 {{ $labels.ifDescr }} 错误率过高"
          description: "设备 {{ $labels.instance }} 接口 {{ $labels.ifDescr }} 每秒错误包数为 {{ $value | humanize }}"

      # 网络接口流量过高
      - alert: HighInterfaceTraffic
        expr: (rate(ifHCInOctets[5m]) * 8 / ifHighSpeed / 1000000) * 100 > 80 or (rate(ifHCOutOctets[5m]) * 8 / ifHighSpeed / 1000000) * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "接口 {{ $labels.ifDescr }} 流量过高"
          description: "设备 {{ $labels.instance }} 接口 {{ $labels.ifDescr }} 流量使用率为 {{ $value | humanize }}%"

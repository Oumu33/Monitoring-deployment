# ===================================================================
# Node Exporter å‘Šè­¦è§„åˆ™
# ç”¨é€”: ç›‘æ§ Linux ä¸»æœºçš„ CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œç­‰èµ„æº
# æ–‡æ¡£: https://github.com/prometheus/node_exporter
# ===================================================================

groups:
  - name: node-exporter-alerts
    interval: 30s
    rules:

      # ===== ä¸»æœºå¯ç”¨æ€§å‘Šè­¦ =====

      # ä¸»æœºå®•æœºå‘Šè­¦ï¼ˆCriticalï¼‰
      - alert: HostDown
        expr: up{job="node-exporter"} == 0
        for: 1m
        labels:
          severity: critical
          priority: P0                        # æœ€é«˜ä¼˜å…ˆçº§
          category: availability
          component: host
        annotations:
          summary: "ğŸ”´ ä¸»æœº {{ $labels.instance }} å®•æœº"
          description: |
            **å½±å“èŒƒå›´**: ä¸»æœº {{ $labels.instance }} å·²ç»å®•æœºè¶…è¿‡ 1 åˆ†é’Ÿ
            **å¯èƒ½åŸå› **:
            - ä¸»æœºå…³æœºæˆ–é‡å¯
            - ç½‘ç»œä¸å¯è¾¾
            - Node Exporter è¿›ç¨‹å´©æºƒ

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥ä¸»æœºæ˜¯å¦å¯ Ping é€š: `ping {{ $labels.instance }}`
            2. æ£€æŸ¥ä¸»æœºæ§åˆ¶å°æ˜¯å¦æœ‰è¾“å‡º
            3. æ£€æŸ¥ Node Exporter æœåŠ¡: `systemctl status node_exporter`
            4. æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—: `journalctl -xe`
          runbook_url: "https://your-wiki.com/runbooks/host-down"

      # ===== CPU å‘Šè­¦ï¼ˆåˆ†çº§ï¼‰=====

      # CPU ä½¿ç”¨ç‡å‘Šè­¦ - Warningï¼ˆ85%ï¼‰
      - alert: HighCPUUsageWarning
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 85
        for: 5m
        labels:
          severity: warning
          priority: P2
          category: performance
          component: cpu
        annotations:
          summary: "âš ï¸ ä¸»æœº {{ $labels.instance }} CPU ä½¿ç”¨ç‡è¾ƒé«˜"
          description: |
            **å½“å‰çŠ¶æ€**: CPU ä½¿ç”¨ç‡ä¸º {{ $value | humanizePercentage }}
            **æŒç»­æ—¶é—´**: å·²æŒç»­ 5 åˆ†é’Ÿ

            **å¯èƒ½åŸå› **:
            - ä¸šåŠ¡æµé‡å¢åŠ 
            - è¿›ç¨‹å¼‚å¸¸å ç”¨ CPU
            - åå°ä»»åŠ¡è¿è¡Œ

            **å¤„ç†æ­¥éª¤**:
            1. æŸ¥çœ‹ CPU å ç”¨è¿›ç¨‹: `top -c` æˆ– `htop`
            2. æŸ¥çœ‹è´Ÿè½½: `uptime`
            3. æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸è¿›ç¨‹
            4. è€ƒè™‘æ‰©å®¹æˆ–ä¼˜åŒ–åº”ç”¨
          runbook_url: "https://your-wiki.com/runbooks/high-cpu"

      # CPU ä½¿ç”¨ç‡å‘Šè­¦ - Criticalï¼ˆ95%ï¼‰
      - alert: HighCPUUsageCritical
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 95
        for: 3m
        labels:
          severity: critical
          priority: P1
          category: performance
          component: cpu
        annotations:
          summary: "ğŸ”´ ä¸»æœº {{ $labels.instance }} CPU ä½¿ç”¨ç‡è¿‡é«˜"
          description: |
            **ç´§æ€¥**: CPU ä½¿ç”¨ç‡è¾¾åˆ° {{ $value | humanizePercentage }}
            **å½±å“**: å¯èƒ½å¯¼è‡´æœåŠ¡å“åº”ç¼“æ…¢æˆ–ä¸å¯ç”¨

            **ç«‹å³è¡ŒåŠ¨**:
            1. ç™»å½•ä¸»æœº: `ssh {{ $labels.instance }}`
            2. æŸ¥çœ‹ CPU å ç”¨: `top -c`
            3. æ€æ­»å¼‚å¸¸è¿›ç¨‹: `kill -9 <PID>`
            4. é‡å¯æœåŠ¡æˆ–æ‰©å®¹
          runbook_url: "https://your-wiki.com/runbooks/high-cpu"

      # ===== å†…å­˜å‘Šè­¦ï¼ˆåˆ†çº§ï¼‰=====

      # å†…å­˜ä½¿ç”¨ç‡å‘Šè­¦ - Warningï¼ˆ85%ï¼‰
      - alert: HighMemoryUsageWarning
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
          priority: P2
          category: performance
          component: memory
        annotations:
          summary: "âš ï¸ ä¸»æœº {{ $labels.instance }} å†…å­˜ä½¿ç”¨ç‡è¾ƒé«˜"
          description: |
            **å½“å‰çŠ¶æ€**: å†…å­˜ä½¿ç”¨ç‡ä¸º {{ $value | humanizePercentage }}
            **å¯ç”¨å†…å­˜**: {{ with query "node_memory_MemAvailable_bytes{instance='$labels.instance'}" }}{{ . | first | value | humanize1024 }}B{{ end }}

            **å¯èƒ½åŸå› **:
            - åº”ç”¨ç¨‹åºå†…å­˜æ³„æ¼
            - ç¼“å­˜å ç”¨è¿‡å¤š
            - ä¸šåŠ¡è´Ÿè½½å¢åŠ 

            **å¤„ç†æ­¥éª¤**:
            1. æŸ¥çœ‹å†…å­˜ä½¿ç”¨: `free -h`
            2. æŸ¥çœ‹è¿›ç¨‹å†…å­˜: `ps aux --sort=-%mem | head -20`
            3. æ¸…ç†ç¼“å­˜: `sync && echo 3 > /proc/sys/vm/drop_caches`ï¼ˆè°¨æ…æ“ä½œï¼‰
            4. é‡å¯å ç”¨å†…å­˜è¿‡å¤šçš„æœåŠ¡
          runbook_url: "https://your-wiki.com/runbooks/high-memory"

      # å†…å­˜ä½¿ç”¨ç‡å‘Šè­¦ - Criticalï¼ˆ95%ï¼‰
      - alert: HighMemoryUsageCritical
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 95
        for: 2m
        labels:
          severity: critical
          priority: P0
          category: performance
          component: memory
        annotations:
          summary: "ğŸ”´ ä¸»æœº {{ $labels.instance }} å†…å­˜å³å°†è€—å°½"
          description: |
            **ç´§æ€¥**: å†…å­˜ä½¿ç”¨ç‡è¾¾åˆ° {{ $value | humanizePercentage }}
            **é£é™©**: å¯èƒ½è§¦å‘ OOM Killerï¼Œå¯¼è‡´è¿›ç¨‹è¢«æ€æ­»

            **ç«‹å³è¡ŒåŠ¨**:
            1. ç™»å½•ä¸»æœºæ£€æŸ¥: `free -h`
            2. æŸ¥çœ‹æœ€å å†…å­˜çš„è¿›ç¨‹: `ps aux --sort=-%mem | head`
            3. è€ƒè™‘é‡å¯æœåŠ¡æˆ–æ‰©å®¹
            4. æ£€æŸ¥ dmesg æ˜¯å¦æœ‰ OOM æ—¥å¿—: `dmesg | grep -i oom`
          runbook_url: "https://your-wiki.com/runbooks/high-memory"

      # ===== ç£ç›˜å‘Šè­¦ï¼ˆåˆ†çº§ï¼‰=====

      # ç£ç›˜ç©ºé—´ä¸è¶³å‘Šè­¦ - Warningï¼ˆå‰©ä½™ 15%ï¼‰
      - alert: DiskSpaceLowWarning
        expr: (node_filesystem_avail_bytes{fstype!~"tmpfs|fuse.lxcfs|squashfs|vfat"} / node_filesystem_size_bytes{fstype!~"tmpfs|fuse.lxcfs|squashfs|vfat"}) * 100 < 15
        for: 5m
        labels:
          severity: warning
          priority: P2
          category: storage
          component: disk
        annotations:
          summary: "âš ï¸ ä¸»æœº {{ $labels.instance }} ç£ç›˜ç©ºé—´ä¸è¶³"
          description: |
            **æŒ‚è½½ç‚¹**: {{ $labels.mountpoint }}
            **å‰©ä½™ç©ºé—´**: {{ $value | humanizePercentage }}
            **å¯ç”¨å®¹é‡**: {{ with query "node_filesystem_avail_bytes{instance='$labels.instance',mountpoint='$labels.mountpoint'}" }}{{ . | first | value | humanize1024 }}B{{ end }}

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥ç£ç›˜ä½¿ç”¨: `df -h`
            2. æŸ¥æ‰¾å¤§æ–‡ä»¶: `du -sh /* | sort -rh | head -10`
            3. æ¸…ç†æ—¥å¿—: `journalctl --vacuum-time=7d`
            4. æ¸…ç†ä¸´æ—¶æ–‡ä»¶: `rm -rf /tmp/*`
            5. è€ƒè™‘æ‰©å®¹ç£ç›˜
          runbook_url: "https://your-wiki.com/runbooks/low-disk-space"

      # ç£ç›˜ç©ºé—´ä¸è¶³å‘Šè­¦ - Criticalï¼ˆå‰©ä½™ 5%ï¼‰
      - alert: DiskSpaceLowCritical
        expr: (node_filesystem_avail_bytes{fstype!~"tmpfs|fuse.lxcfs|squashfs|vfat"} / node_filesystem_size_bytes{fstype!~"tmpfs|fuse.lxcfs|squashfs|vfat"}) * 100 < 5
        for: 1m
        labels:
          severity: critical
          priority: P0
          category: storage
          component: disk
        annotations:
          summary: "ğŸ”´ ä¸»æœº {{ $labels.instance }} ç£ç›˜ç©ºé—´ä¸¥é‡ä¸è¶³"
          description: |
            **ç´§æ€¥**: æŒ‚è½½ç‚¹ {{ $labels.mountpoint }} ä»…å‰© {{ $value | humanizePercentage }} ç©ºé—´
            **é£é™©**: å¯èƒ½å¯¼è‡´æœåŠ¡æ— æ³•å†™å…¥ï¼Œç³»ç»Ÿå´©æºƒ

            **ç«‹å³è¡ŒåŠ¨**:
            1. ç«‹å³æ£€æŸ¥ç£ç›˜: `df -h {{ $labels.mountpoint }}`
            2. æŸ¥æ‰¾æœ€å¤§æ–‡ä»¶: `find {{ $labels.mountpoint }} -type f -exec du -h {} + | sort -rh | head -20`
            3. æ¸…ç†æ—¥å¿—å’Œä¸´æ—¶æ–‡ä»¶
            4. ç´§æ€¥æ‰©å®¹ç£ç›˜
          runbook_url: "https://your-wiki.com/runbooks/low-disk-space"

      # ===== ç£ç›˜ I/O å‘Šè­¦ =====

      # ç£ç›˜ I/O ç­‰å¾…æ—¶é—´è¿‡é«˜
      - alert: HighDiskIOWait
        expr: rate(node_cpu_seconds_total{mode="iowait"}[5m]) * 100 > 10
        for: 5m
        labels:
          severity: warning
          priority: P2
          category: performance
          component: disk
        annotations:
          summary: "âš ï¸ ä¸»æœº {{ $labels.instance }} ç£ç›˜ I/O ç­‰å¾…æ—¶é—´è¿‡é«˜"
          description: |
            **I/O ç­‰å¾…**: {{ $value | humanizePercentage }}

            **å¯èƒ½åŸå› **:
            - ç£ç›˜æ€§èƒ½ä¸è¶³
            - å¤§é‡è¯»å†™æ“ä½œ
            - ç£ç›˜æ•…éšœ

            **å¤„ç†æ­¥éª¤**:
            1. æŸ¥çœ‹ I/O çŠ¶æ€: `iostat -x 1`
            2. æŸ¥çœ‹ç£ç›˜è¯»å†™: `iotop`
            3. æ£€æŸ¥ç£ç›˜å¥åº·: `smartctl -a /dev/sda`
            4. ä¼˜åŒ–åº”ç”¨ I/O æˆ–å‡çº§ç£ç›˜
          runbook_url: "https://your-wiki.com/runbooks/high-io-wait"

      # ===== ç½‘ç»œå‘Šè­¦ =====

      # ç½‘ç»œæ¥å£çŠ¶æ€å‘Šè­¦
      - alert: NetworkInterfaceDown
        expr: node_network_up{device!~"lo|docker.*|veth.*|br-.*"} == 0
        for: 1m
        labels:
          severity: warning
          priority: P2
          category: network
          component: interface
        annotations:
          summary: "âš ï¸ ä¸»æœº {{ $labels.instance }} ç½‘ç»œæ¥å£ {{ $labels.device }} ä¸‹çº¿"
          description: |
            **æ¥å£åç§°**: {{ $labels.device }}

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥ç½‘å¡çŠ¶æ€: `ip link show {{ $labels.device }}`
            2. æŸ¥çœ‹ç½‘ç»œé…ç½®: `ip addr show {{ $labels.device }}`
            3. å°è¯•å¯åŠ¨æ¥å£: `ip link set {{ $labels.device }} up`
            4. æ£€æŸ¥ç‰©ç†è¿æ¥ï¼ˆç½‘çº¿ã€å…‰çº¤ç­‰ï¼‰
          runbook_url: "https://your-wiki.com/runbooks/network-interface-down"

      # ===== ç³»ç»Ÿè´Ÿè½½å‘Šè­¦ï¼ˆåˆ†çº§ï¼‰=====

      # ç³»ç»Ÿè´Ÿè½½å‘Šè­¦ - Warning
      - alert: HighSystemLoadWarning
        expr: node_load15 / count(node_cpu_seconds_total{mode="idle"}) without(cpu, mode) > 1.5
        for: 10m
        labels:
          severity: warning
          priority: P2
          category: performance
          component: system
        annotations:
          summary: "âš ï¸ ä¸»æœº {{ $labels.instance }} ç³»ç»Ÿè´Ÿè½½è¾ƒé«˜"
          description: |
            **15åˆ†é’Ÿè´Ÿè½½**: {{ $value | humanize }}
            **CPU æ ¸å¿ƒæ•°**: {{ with query "count(node_cpu_seconds_total{instance='$labels.instance',mode='idle'}) without(cpu, mode)" }}{{ . | first | value }}{{ end }}

            **å¤„ç†æ­¥éª¤**:
            1. æŸ¥çœ‹è´Ÿè½½: `uptime`
            2. æŸ¥çœ‹è¿›ç¨‹: `top -c`
            3. æ£€æŸ¥æ˜¯å¦æœ‰åƒµå°¸è¿›ç¨‹: `ps aux | grep Z`
          runbook_url: "https://your-wiki.com/runbooks/high-load"

      # ç³»ç»Ÿè´Ÿè½½å‘Šè­¦ - Critical
      - alert: HighSystemLoadCritical
        expr: node_load15 / count(node_cpu_seconds_total{mode="idle"}) without(cpu, mode) > 2.5
        for: 5m
        labels:
          severity: critical
          priority: P1
          category: performance
          component: system
        annotations:
          summary: "ğŸ”´ ä¸»æœº {{ $labels.instance }} ç³»ç»Ÿè´Ÿè½½è¿‡é«˜"
          description: |
            **ç´§æ€¥**: 15åˆ†é’Ÿè´Ÿè½½è¾¾åˆ° {{ $value | humanize }}ï¼ˆCPU æ ¸å¿ƒæ•°çš„ {{ $value | humanize }} å€ï¼‰
            **å½±å“**: ç³»ç»Ÿå“åº”ä¸¥é‡å˜æ…¢

            **ç«‹å³è¡ŒåŠ¨**:
            1. æŸ¥çœ‹è¿è¡Œé˜Ÿåˆ—: `vmstat 1`
            2. è¯†åˆ«é«˜è´Ÿè½½è¿›ç¨‹: `ps -eo pid,ppid,cmd,%cpu,%mem --sort=-%cpu | head -20`
            3. æ€æ­»å¼‚å¸¸è¿›ç¨‹æˆ–é‡å¯æœåŠ¡
          runbook_url: "https://your-wiki.com/runbooks/high-load"

# ===================================================================
# å‘Šè­¦è§„åˆ™è¯´æ˜:
#
# 1. å‘Šè­¦åˆ†çº§ç­–ç•¥:
#    - Warning (P2): 85-95% é˜ˆå€¼ï¼Œç»™è¿ç»´æ—¶é—´å‡†å¤‡
#    - Critical (P0/P1): >95% é˜ˆå€¼ï¼Œéœ€è¦ç«‹å³å¤„ç†
#
# 2. æ ‡ç­¾ä½“ç³»:
#    - severity: warning/criticalï¼ˆä¸¥é‡ç¨‹åº¦ï¼‰
#    - priority: P0/P1/P2/P3ï¼ˆä¸šåŠ¡ä¼˜å…ˆçº§ï¼‰
#    - category: availability/performance/storage/network
#    - component: cpu/memory/disk/network
#
# 3. Annotations å†…å®¹:
#    - summary: ç®€çŸ­æ‘˜è¦ï¼ˆæ˜¾ç¤ºåœ¨é€šçŸ¥ä¸­ï¼‰
#    - description: è¯¦ç»†è¯´æ˜ï¼ˆå½±å“èŒƒå›´ã€å¯èƒ½åŸå› ã€å¤„ç†æ­¥éª¤ï¼‰
#    - runbook_url: å¤„ç†æ‰‹å†Œé“¾æ¥
#
# 4. å‘Šè­¦æŠ‘åˆ¶:
#    - é…ç½®åœ¨ Alertmanager ä¸­
#    - ä¸»æœºå®•æœºæ—¶ï¼Œè‡ªåŠ¨æŠ‘åˆ¶è¯¥ä¸»æœºçš„å…¶ä»–å‘Šè­¦
#
# æ›´å¤šæ–‡æ¡£: docs/ALERT-RULES-GUIDE.md
# ===================================================================

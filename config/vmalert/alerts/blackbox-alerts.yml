# ===================================================================
# Blackbox Exporter å‘Šè­¦è§„åˆ™
# ç”¨é€”: ç›‘æ§æœåŠ¡å¯ç”¨æ€§ï¼ˆHTTPã€ICMPã€TCPã€DNSï¼‰
# æ–‡æ¡£: https://github.com/prometheus/blackbox_exporter
# ===================================================================

groups:
  - name: blackbox-http-alerts
    interval: 30s
    rules:

      # HTTP/HTTPS æ¢æµ‹å¤±è´¥
      - alert: WebsiteDown
        expr: probe_success{job=~"blackbox-http|blackbox-https-ssl"} == 0
        for: 2m
        labels:
          severity: critical
          priority: P0
          category: availability
          component: website
        annotations:
          summary: "ğŸ”´ ç½‘ç«™ {{ $labels.instance }} æ— æ³•è®¿é—®"
          description: |
            **ç½‘ç«™**: {{ $labels.instance }}
            **æœåŠ¡åç§°**: {{ $labels.service_name }}
            **æ¢æµ‹ç±»å‹**: {{ $labels.probe_type }}

            **å¯èƒ½åŸå› **:
            - ç½‘ç«™æœåŠ¡å®•æœº
            - DNS è§£æå¤±è´¥
            - ç½‘ç»œä¸å¯è¾¾
            - é˜²ç«å¢™é˜»æ­¢

            **å¤„ç†æ­¥éª¤**:
            1. åœ¨æµè§ˆå™¨è®¿é—®ç¡®è®¤: {{ $labels.instance }}
            2. æ£€æŸ¥æœåŠ¡çŠ¶æ€: `systemctl status nginx/apache`
            3. æ£€æŸ¥ç«¯å£: `netstat -tuln | grep 80/443`
            4. æŸ¥çœ‹æœåŠ¡æ—¥å¿—
          runbook_url: "https://your-wiki.com/runbooks/website-down"

      # HTTP å“åº”æ—¶é—´è¿‡é•¿ - Warning
      - alert: WebsiteSlowWarning
        expr: probe_duration_seconds{job="blackbox-http"} > 2
        for: 5m
        labels:
          severity: warning
          priority: P2
          category: performance
          component: website
        annotations:
          summary: "âš ï¸ ç½‘ç«™ {{ $labels.instance }} å“åº”ç¼“æ…¢"
          description: |
            **ç½‘ç«™**: {{ $labels.instance }}
            **å“åº”æ—¶é—´**: {{ $value | humanizeDuration }}

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥æœåŠ¡å™¨è´Ÿè½½
            2. æ£€æŸ¥æ•°æ®åº“æ€§èƒ½
            3. åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
            4. ä¼˜åŒ–åº”ç”¨ä»£ç 
          runbook_url: "https://your-wiki.com/runbooks/website-slow"

      # HTTP å“åº”æ—¶é—´è¿‡é•¿ - Critical
      - alert: WebsiteSlowCritical
        expr: probe_duration_seconds{job="blackbox-http"} > 5
        for: 3m
        labels:
          severity: critical
          priority: P1
          category: performance
          component: website
        annotations:
          summary: "ğŸ”´ ç½‘ç«™ {{ $labels.instance }} å“åº”ä¸¥é‡ç¼“æ…¢"
          description: |
            **ç´§æ€¥**: å“åº”æ—¶é—´è¾¾åˆ° {{ $value | humanizeDuration }}
            **å½±å“**: ç”¨æˆ·ä½“éªŒä¸¥é‡ä¸‹é™

            **ç«‹å³è¡ŒåŠ¨**:
            1. é‡å¯ Web æœåŠ¡
            2. æ£€æŸ¥æ˜¯å¦å—åˆ°æ”»å‡»
            3. å¯ç”¨ç¼“å­˜æˆ– CDN
          runbook_url: "https://your-wiki.com/runbooks/website-slow"

      # HTTP çŠ¶æ€ç å¼‚å¸¸
      - alert: WebsiteHTTPStatusCode
        expr: probe_http_status_code{job="blackbox-http"} >= 400
        for: 2m
        labels:
          severity: warning
          priority: P2
          category: availability
          component: website
        annotations:
          summary: "âš ï¸ ç½‘ç«™ {{ $labels.instance }} è¿”å›å¼‚å¸¸çŠ¶æ€ç "
          description: |
            **ç½‘ç«™**: {{ $labels.instance }}
            **çŠ¶æ€ç **: {{ $value }}

            **å¸¸è§çŠ¶æ€ç **:
            - 400: é”™è¯¯è¯·æ±‚
            - 401/403: æƒé™é—®é¢˜
            - 404: é¡µé¢ä¸å­˜åœ¨
            - 500: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
            - 502: ç½‘å…³é”™è¯¯
            - 503: æœåŠ¡ä¸å¯ç”¨

            **å¤„ç†æ­¥éª¤**:
            1. æŸ¥çœ‹ Web æœåŠ¡æ—¥å¿—
            2. æ£€æŸ¥é…ç½®æ–‡ä»¶
            3. æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€
          runbook_url: "https://your-wiki.com/runbooks/http-status-code"

      # SSL è¯ä¹¦å³å°†è¿‡æœŸï¼ˆ30 å¤©å†…ï¼‰
      - alert: SSLCertificateExpiringSoon
        expr: (probe_ssl_earliest_cert_expiry{job="blackbox-https-ssl"} - time()) / 86400 < 30
        for: 1h
        labels:
          severity: warning
          priority: P2
          category: security
          component: ssl
        annotations:
          summary: "âš ï¸ {{ $labels.instance }} SSL è¯ä¹¦å³å°†è¿‡æœŸ"
          description: |
            **ç½‘ç«™**: {{ $labels.instance }}
            **å‰©ä½™å¤©æ•°**: {{ $value | humanize }} å¤©

            **å¤„ç†æ­¥éª¤**:
            1. å‡†å¤‡ç»­æœŸè¯ä¹¦
            2. è”ç³»è¯ä¹¦æä¾›å•†
            3. æ›´æ–°è¯ä¹¦å¹¶é‡å¯æœåŠ¡
          runbook_url: "https://your-wiki.com/runbooks/ssl-certificate-expiring"

      # SSL è¯ä¹¦å³å°†è¿‡æœŸï¼ˆ7 å¤©å†…ï¼‰
      - alert: SSLCertificateExpiringCritical
        expr: (probe_ssl_earliest_cert_expiry{job="blackbox-https-ssl"} - time()) / 86400 < 7
        for: 1h
        labels:
          severity: critical
          priority: P0
          category: security
          component: ssl
        annotations:
          summary: "ğŸ”´ {{ $labels.instance }} SSL è¯ä¹¦ç´§æ€¥è¿‡æœŸè­¦å‘Š"
          description: |
            **ç´§æ€¥**: è¯ä¹¦å°†åœ¨ {{ $value | humanize }} å¤©åè¿‡æœŸ
            **å½±å“**: ç½‘ç«™å°†æ˜¾ç¤ºä¸å®‰å…¨è­¦å‘Šï¼Œç”¨æˆ·æ— æ³•è®¿é—®

            **ç«‹å³è¡ŒåŠ¨**:
            1. ç´§æ€¥ç”³è¯·/ç»­æœŸè¯ä¹¦
            2. éƒ¨ç½²æ–°è¯ä¹¦
            3. éªŒè¯è¯ä¹¦æœ‰æ•ˆæ€§
          runbook_url: "https://your-wiki.com/runbooks/ssl-certificate-expiring"

      # SSL è¯ä¹¦å·²è¿‡æœŸ
      - alert: SSLCertificateExpired
        expr: probe_ssl_earliest_cert_expiry{job="blackbox-https-ssl"} < time()
        for: 1m
        labels:
          severity: critical
          priority: P0
          category: security
          component: ssl
        annotations:
          summary: "ğŸ”´ {{ $labels.instance }} SSL è¯ä¹¦å·²è¿‡æœŸ"
          description: |
            **ç´§æ€¥**: SSL è¯ä¹¦å·²ç»è¿‡æœŸ
            **å½±å“**: ç½‘ç«™æ— æ³•æ­£å¸¸è®¿é—®

            **ç«‹å³è¡ŒåŠ¨**:
            1. ç«‹å³éƒ¨ç½²æ–°è¯ä¹¦
            2. é‡å¯ Web æœåŠ¡
          runbook_url: "https://your-wiki.com/runbooks/ssl-certificate-expired"

  - name: blackbox-icmp-alerts
    interval: 30s
    rules:

      # ICMP Ping æ¢æµ‹å¤±è´¥ï¼ˆè®¾å¤‡ä¸å¯è¾¾ï¼‰
      - alert: HostDown
        expr: probe_success{job="blackbox-icmp"} == 0
        for: 2m
        labels:
          severity: critical
          priority: P0
          category: availability
          component: network
        annotations:
          summary: "ğŸ”´ ä¸»æœº {{ $labels.instance }} æ— æ³• Ping é€š"
          description: |
            **ä¸»æœº**: {{ $labels.instance }}
            **è®¾å¤‡åç§°**: {{ $labels.device_name }}
            **è®¾å¤‡ç±»å‹**: {{ $labels.device_type }}

            **å¯èƒ½åŸå› **:
            - è®¾å¤‡å®•æœº
            - ç½‘ç»œä¸å¯è¾¾
            - é˜²ç«å¢™é˜»æ­¢ ICMP

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥è®¾å¤‡ç”µæºå’Œè¿æ¥
            2. ç™»å½•è®¾å¤‡æ§åˆ¶å°
            3. æ£€æŸ¥ç½‘ç»œè·¯ç”±
            4. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
          runbook_url: "https://your-wiki.com/runbooks/host-down"

      # ICMP ä¸¢åŒ…ç‡è¿‡é«˜
      - alert: HighPacketLoss
        expr: probe_icmp_reply_packet_loss_percent{job="blackbox-icmp"} > 5
        for: 5m
        labels:
          severity: warning
          priority: P2
          category: network
          component: connectivity
        annotations:
          summary: "âš ï¸ ä¸»æœº {{ $labels.instance }} ä¸¢åŒ…ç‡è¿‡é«˜"
          description: |
            **ä¸»æœº**: {{ $labels.instance }}
            **ä¸¢åŒ…ç‡**: {{ $value | humanizePercentage }}

            **å¯èƒ½åŸå› **:
            - ç½‘ç»œæ‹¥å¡
            - é“¾è·¯è´¨é‡å·®
            - è®¾å¤‡è¿‡è½½

            **å¤„ç†æ­¥éª¤**:
            1. æŒç»­ Ping è§‚å¯Ÿ: `ping -c 100 {{ $labels.instance }}`
            2. æ£€æŸ¥ç½‘ç»œé“¾è·¯
            3. æ£€æŸ¥è®¾å¤‡è´Ÿè½½
          runbook_url: "https://your-wiki.com/runbooks/high-packet-loss"

      # ICMP å»¶è¿Ÿè¿‡é«˜
      - alert: HighICMPLatency
        expr: probe_icmp_duration_seconds{job="blackbox-icmp"} > 0.1
        for: 5m
        labels:
          severity: warning
          priority: P2
          category: network
          component: latency
        annotations:
          summary: "âš ï¸ ä¸»æœº {{ $labels.instance }} ç½‘ç»œå»¶è¿Ÿè¿‡é«˜"
          description: |
            **ä¸»æœº**: {{ $labels.instance }}
            **Ping å»¶è¿Ÿ**: {{ $value | humanizeDuration }}

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥ç½‘ç»œè·¯å¾„: `traceroute {{ $labels.instance }}`
            2. æ£€æŸ¥è®¾å¤‡è´Ÿè½½
            3. æ£€æŸ¥é“¾è·¯å¸¦å®½
          runbook_url: "https://your-wiki.com/runbooks/high-latency"

  - name: blackbox-tcp-alerts
    interval: 30s
    rules:

      # TCP ç«¯å£æ— æ³•è¿æ¥
      - alert: TCPPortDown
        expr: probe_success{job="blackbox-tcp"} == 0
        for: 2m
        labels:
          severity: critical
          priority: P1
          category: availability
          component: service
        annotations:
          summary: "ğŸ”´ TCP ç«¯å£ {{ $labels.instance }} æ— æ³•è¿æ¥"
          description: |
            **æœåŠ¡åœ°å€**: {{ $labels.instance }}

            **å¯èƒ½åŸå› **:
            - æœåŠ¡æœªå¯åŠ¨
            - ç«¯å£è¢«å ç”¨
            - é˜²ç«å¢™é˜»æ­¢

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
            2. æ£€æŸ¥ç«¯å£ç›‘å¬: `netstat -tuln`
            3. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
          runbook_url: "https://your-wiki.com/runbooks/tcp-port-down"

      # TCP è¿æ¥æ—¶é—´è¿‡é•¿
      - alert: TCPConnectionSlow
        expr: probe_duration_seconds{job="blackbox-tcp"} > 1
        for: 5m
        labels:
          severity: warning
          priority: P2
          category: performance
          component: service
        annotations:
          summary: "âš ï¸ TCP ç«¯å£ {{ $labels.instance }} è¿æ¥ç¼“æ…¢"
          description: |
            **æœåŠ¡åœ°å€**: {{ $labels.instance }}
            **è¿æ¥æ—¶é—´**: {{ $value | humanizeDuration }}

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥æœåŠ¡è´Ÿè½½
            2. æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿ
            3. ä¼˜åŒ–æœåŠ¡æ€§èƒ½
          runbook_url: "https://your-wiki.com/runbooks/tcp-connection-slow"

  - name: blackbox-exporter-health
    interval: 30s
    rules:

      # Blackbox Exporter æœåŠ¡å®•æœº
      - alert: BlackboxExporterDown
        expr: up{job="blackbox-exporter"} == 0
        for: 2m
        labels:
          severity: critical
          priority: P1
          category: monitoring
          component: blackbox
        annotations:
          summary: "ğŸ”´ Blackbox Exporter æœåŠ¡å®•æœº"
          description: |
            **å½±å“**: æ— æ³•è¿›è¡ŒæœåŠ¡å¯ç”¨æ€§æ¢æµ‹

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥å®¹å™¨çŠ¶æ€: `docker ps | grep blackbox`
            2. æŸ¥çœ‹æ—¥å¿—: `docker logs blackbox-exporter`
            3. é‡å¯æœåŠ¡: `docker-compose restart blackbox-exporter`
          runbook_url: "https://your-wiki.com/runbooks/blackbox-exporter-down"

# ===================================================================
# å‘Šè­¦è§„åˆ™è¯´æ˜:
#
# 1. Blackbox æ¢æµ‹ç±»å‹:
#    - HTTP: ç½‘ç«™å¯ç”¨æ€§ã€å“åº”æ—¶é—´ã€çŠ¶æ€ç 
#    - HTTPS SSL: SSL è¯ä¹¦æœ‰æ•ˆæœŸ
#    - ICMP: ç½‘ç»œè¿é€šæ€§ã€ä¸¢åŒ…ç‡ã€å»¶è¿Ÿ
#    - TCP: ç«¯å£å¯ç”¨æ€§ã€è¿æ¥æ—¶é—´
#
# 2. å‘Šè­¦ä¼˜å…ˆçº§:
#    - ç½‘ç«™å®•æœº: P0ï¼ˆå½±å“ç”¨æˆ·è®¿é—®ï¼‰
#    - SSL è¯ä¹¦è¿‡æœŸ: P0ï¼ˆå®‰å…¨é£é™©ï¼‰
#    - ç½‘ç»œå»¶è¿Ÿ/ä¸¢åŒ…: P2ï¼ˆæ€§èƒ½é—®é¢˜ï¼‰
#
# 3. SSL è¯ä¹¦ç›‘æ§:
#    - 30 å¤©: Warningï¼ˆæé†’å‡†å¤‡ï¼‰
#    - 7 å¤©: Criticalï¼ˆç´§æ€¥ç»­æœŸï¼‰
#    - å·²è¿‡æœŸ: Criticalï¼ˆç«‹å³å¤„ç†ï¼‰
#
# æ›´å¤šæ–‡æ¡£: docs/BLACKBOX-MONITORING-GUIDE.md
# ===================================================================

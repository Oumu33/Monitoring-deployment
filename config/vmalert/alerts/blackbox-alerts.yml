# ===================================================================
# Blackbox Exporter å‘Šè­¦è§„åˆ™
# ç”¨é€”: ç›‘æ§æœåŠ¡å¯ç”¨æ€§ï¼ˆHTTPã€ICMPã€TCPã€DNSï¼‰
# æ–‡æ¡£: https://github.com/prometheus/blackbox_exporter
# ===================================================================

groups:
  - name: blackbox-http-alerts
    interval: 30s
    rules:

      # HTTP/HTTPS æ¢æµ‹å¤±è´¥
      - alert: WebsiteDown
        expr: probe_success{job=~"blackbox-http|blackbox-https-ssl"} == 0
        for: 2m
        labels:
          severity: critical
          priority: P0
          category: availability
          component: website
        annotations:
          summary: "ğŸ”´ ç½‘ç«™ {{ $labels.instance }} æ— æ³•è®¿é—®"
          description: |
            **ç½‘ç«™**: {{ $labels.instance }}
            **æœåŠ¡åç§°**: {{ $labels.service_name }}
            **æ¢æµ‹ç±»å‹**: {{ $labels.probe_type }}

            **å¯èƒ½åŸå› **:
            - ç½‘ç«™æœåŠ¡å®•æœº
            - DNS è§£æå¤±è´¥
            - ç½‘ç»œä¸å¯è¾¾
            - é˜²ç«å¢™é˜»æ­¢

            **å¤„ç†æ­¥éª¤**:
            1. åœ¨æµè§ˆå™¨è®¿é—®ç¡®è®¤: {{ $labels.instance }}
            2. æ£€æŸ¥æœåŠ¡çŠ¶æ€: `systemctl status nginx/apache`
            3. æ£€æŸ¥ç«¯å£: `netstat -tuln | grep 80/443`
            4. æŸ¥çœ‹æœåŠ¡æ—¥å¿—
          runbook_url: "https://your-wiki.com/runbooks/website-down"

      # HTTP å“åº”æ—¶é—´è¿‡é•¿ - Warning
      - alert: WebsiteSlowWarning
        expr: probe_duration_seconds{job="blackbox-http"} > 2
        for: 5m
        labels:
          severity: warning
          priority: P2
          category: performance
          component: website
        annotations:
          summary: "âš ï¸ ç½‘ç«™ {{ $labels.instance }} å“åº”ç¼“æ…¢"
          description: |
            **ç½‘ç«™**: {{ $labels.instance }}
            **å“åº”æ—¶é—´**: {{ $value | humanizeDuration }}

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥æœåŠ¡å™¨è´Ÿè½½
            2. æ£€æŸ¥æ•°æ®åº“æ€§èƒ½
            3. åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
            4. ä¼˜åŒ–åº”ç”¨ä»£ç 
          runbook_url: "https://your-wiki.com/runbooks/website-slow"

      # HTTP å“åº”æ—¶é—´è¿‡é•¿ - Critical
      - alert: WebsiteSlowCritical
        expr: probe_duration_seconds{job="blackbox-http"} > 5
        for: 3m
        labels:
          severity: critical
          priority: P1
          category: performance
          component: website
        annotations:
          summary: "ğŸ”´ ç½‘ç«™ {{ $labels.instance }} å“åº”ä¸¥é‡ç¼“æ…¢"
          description: |
            **ç´§æ€¥**: å“åº”æ—¶é—´è¾¾åˆ° {{ $value | humanizeDuration }}
            **å½±å“**: ç”¨æˆ·ä½“éªŒä¸¥é‡ä¸‹é™

            **ç«‹å³è¡ŒåŠ¨**:
            1. é‡å¯ Web æœåŠ¡
            2. æ£€æŸ¥æ˜¯å¦å—åˆ°æ”»å‡»
            3. å¯ç”¨ç¼“å­˜æˆ– CDN
          runbook_url: "https://your-wiki.com/runbooks/website-slow"

      # HTTP çŠ¶æ€ç å¼‚å¸¸
      - alert: WebsiteHTTPStatusCode
        expr: probe_http_status_code{job="blackbox-http"} >= 400
        for: 2m
        labels:
          severity: warning
          priority: P2
          category: availability
          component: website
        annotations:
          summary: "âš ï¸ ç½‘ç«™ {{ $labels.instance }} è¿”å›å¼‚å¸¸çŠ¶æ€ç "
          description: |
            **ç½‘ç«™**: {{ $labels.instance }}
            **çŠ¶æ€ç **: {{ $value }}

            **å¸¸è§çŠ¶æ€ç **:
            - 400: é”™è¯¯è¯·æ±‚
            - 401/403: æƒé™é—®é¢˜
            - 404: é¡µé¢ä¸å­˜åœ¨
            - 500: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
            - 502: ç½‘å…³é”™è¯¯
            - 503: æœåŠ¡ä¸å¯ç”¨

            **å¤„ç†æ­¥éª¤**:
            1. æŸ¥çœ‹ Web æœåŠ¡æ—¥å¿—
            2. æ£€æŸ¥é…ç½®æ–‡ä»¶
            3. æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€
          runbook_url: "https://your-wiki.com/runbooks/http-status-code"

      # SSL è¯ä¹¦å³å°†è¿‡æœŸï¼ˆ30 å¤©å†…ï¼‰
      - alert: SSLCertificateExpiringSoon
        expr: (probe_ssl_earliest_cert_expiry{job="blackbox-https-ssl"} - time()) / 86400 < 30
        for: 1h
        labels:
          severity: warning
          priority: P2
          category: security
          component: ssl
        annotations:
          summary: "âš ï¸ {{ $labels.instance }} SSL è¯ä¹¦å³å°†è¿‡æœŸ"
          description: |
            **ç½‘ç«™**: {{ $labels.instance }}
            **å‰©ä½™å¤©æ•°**: {{ $value | humanize }} å¤©

            **å¤„ç†æ­¥éª¤**:
            1. å‡†å¤‡ç»­æœŸè¯ä¹¦
            2. è”ç³»è¯ä¹¦æä¾›å•†
            3. æ›´æ–°è¯ä¹¦å¹¶é‡å¯æœåŠ¡
          runbook_url: "https://your-wiki.com/runbooks/ssl-certificate-expiring"

      # SSL è¯ä¹¦å³å°†è¿‡æœŸï¼ˆ7 å¤©å†…ï¼‰
      - alert: SSLCertificateExpiringCritical
        expr: (probe_ssl_earliest_cert_expiry{job="blackbox-https-ssl"} - time()) / 86400 < 7
        for: 1h
        labels:
          severity: critical
          priority: P0
          category: security
          component: ssl
        annotations:
          summary: "ğŸ”´ {{ $labels.instance }} SSL è¯ä¹¦ç´§æ€¥è¿‡æœŸè­¦å‘Š"
          description: |
            **ç´§æ€¥**: è¯ä¹¦å°†åœ¨ {{ $value | humanize }} å¤©åè¿‡æœŸ
            **å½±å“**: ç½‘ç«™å°†æ˜¾ç¤ºä¸å®‰å…¨è­¦å‘Šï¼Œç”¨æˆ·æ— æ³•è®¿é—®

            **ç«‹å³è¡ŒåŠ¨**:
            1. ç´§æ€¥ç”³è¯·/ç»­æœŸè¯ä¹¦
            2. éƒ¨ç½²æ–°è¯ä¹¦
            3. éªŒè¯è¯ä¹¦æœ‰æ•ˆæ€§
          runbook_url: "https://your-wiki.com/runbooks/ssl-certificate-expiring"

      # SSL è¯ä¹¦å·²è¿‡æœŸ
      - alert: SSLCertificateExpired
        expr: probe_ssl_earliest_cert_expiry{job="blackbox-https-ssl"} < time()
        for: 1m
        labels:
          severity: critical
          priority: P0
          category: security
          component: ssl
        annotations:
          summary: "ğŸ”´ {{ $labels.instance }} SSL è¯ä¹¦å·²è¿‡æœŸ"
          description: |
            **ç´§æ€¥**: SSL è¯ä¹¦å·²ç»è¿‡æœŸ
            **å½±å“**: ç½‘ç«™æ— æ³•æ­£å¸¸è®¿é—®

            **ç«‹å³è¡ŒåŠ¨**:
            1. ç«‹å³éƒ¨ç½²æ–°è¯ä¹¦
            2. é‡å¯ Web æœåŠ¡
          runbook_url: "https://your-wiki.com/runbooks/ssl-certificate-expired"

# ===================================================================
# æœåŠ¡å¯ç”¨æ€§ + è‡ªåŠ¨æ•…éšœè½¬ç§»å‘Šè­¦è§„åˆ™
# ç”¨é€”: æœåŠ¡å®•æœºè‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Œæé«˜å¯ç”¨æ€§
# ===================================================================

  - name: availability-auto-failover-alerts
    interval: 30s
    rules:

      # æœåŠ¡å®•æœºè‡ªåŠ¨æ•…éšœè½¬ç§»
      - alert: ServiceDownAutoFailover
        expr: |
          probe_success{job=~"blackbox-http.*"} == 0
          and on(instance) (
            count(probe_success{job=~"blackbox-http.*"} == 1) by (service_group) > 1
          )
        for: 2m
        labels:
          severity: critical
          priority: P0
          category: availability
          component: service
          subcategory: failover
        annotations:
          summary: "ğŸ”´ æœåŠ¡ {{ $labels.instance }} å®•æœºï¼Œè§¦å‘è‡ªåŠ¨æ•…éšœè½¬ç§»"
          description: |
            **æœåŠ¡**: {{ $labels.instance }}
            **æœåŠ¡ç»„**: {{ $labels.service_group }}
            **æ•…éšœè½¬ç§»**: è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨å®ä¾‹

            **æ•…éšœè½¬ç§»ä¿¡æ¯**:
            - å¤‡ç”¨å®ä¾‹: {{ $labels.backup_instance }}
            - åˆ‡æ¢æ—¶é—´: {{ $value }}
            - é¢„è®¡æ¢å¤æ—¶é—´: 2 åˆ†é’Ÿ

            **å¤„ç†æ­¥éª¤**:
            1. ç¡®è®¤æ•…éšœè½¬ç§»å·²æ‰§è¡Œ
            2. æ£€æŸ¥ä¸»æœåŠ¡æ•…éšœåŸå› 
            3. ä¿®å¤ä¸»æœåŠ¡åæ‰‹åŠ¨åˆ‡æ¢å›ä¸»æœåŠ¡
          auto_failover: true
          failover_action: switch_to_backup
          backup_instance: "{{ $labels.backup_instance }}"
          runbook_url: "https://your-wiki.com/runbooks/auto-failover"

      # æ•°æ®åº“ä¸»ä»åˆ‡æ¢
      - alert: DatabaseMasterDownAutoFailover
        expr: |
          up{job="mysql", role="master"} == 0
          and on(instance) (
            up{job="mysql", role="slave"} == 1
          )
        for: 2m
        labels:
          severity: critical
          priority: P0
          category: database
          component: mysql
          subcategory: failover
        annotations:
          summary: "ğŸ”´ æ•°æ®åº“ä¸»åº“ {{ $labels.instance }} å®•æœºï¼Œè§¦å‘è‡ªåŠ¨æ•…éšœè½¬ç§»"
          description: |
            **ä¸»åº“**: {{ $labels.instance }}
            **ä»åº“**: {{ $labels.slave_instance }}
            **æ•…éšœè½¬ç§»**: è‡ªåŠ¨æå‡ä»åº“ä¸ºä¸»åº“

            **æ•…éšœè½¬ç§»ä¿¡æ¯**:
            - ä»åº“å®ä¾‹: {{ $labels.slave_instance }}
            - åˆ‡æ¢æ¨¡å¼: è‡ªåŠ¨æå‡
            - æ•°æ®ä¸€è‡´æ€§: å·²éªŒè¯

            **å¤„ç†æ­¥éª¤**:
            1. ç¡®è®¤ä»åº“å·²æå‡ä¸ºä¸»åº“
            2. æ£€æŸ¥ä¸»åº“æ•…éšœåŸå› 
            3. ä¿®å¤ä¸»åº“åé‡æ–°é…ç½®ä¸»ä»å¤åˆ¶
          auto_failover: true
          failover_action: promote_slave_to_master
          slave_instance: "{{ $labels.slave_instance }}"
          runbook_url: "https://your-wiki.com/runbooks/mysql-failover"

      # Redis ä¸»ä»åˆ‡æ¢
      - alert: RedisMasterDownAutoFailover
        expr: |
          up{job="redis", role="master"} == 0
          and on(instance) (
            up{job="redis", role="slave"} == 1
          )
        for: 2m
        labels:
          severity: critical
          priority: P0
          category: database
          component: redis
          subcategory: failover
        annotations:
          summary: "ğŸ”´ Redis ä¸»åº“ {{ $labels.instance }} å®•æœºï¼Œè§¦å‘è‡ªåŠ¨æ•…éšœè½¬ç§»"
          description: |
            **ä¸»åº“**: {{ $labels.instance }}
            **ä»åº“**: {{ $labels.slave_instance }}
            **æ•…éšœè½¬ç§»**: è‡ªåŠ¨æå‡ä»åº“ä¸ºä¸»åº“

            **æ•…éšœè½¬ç§»ä¿¡æ¯**:
            - ä»åº“å®ä¾‹: {{ $labels.slave_instance }}
            - åˆ‡æ¢æ¨¡å¼: Sentinel è‡ªåŠ¨åˆ‡æ¢
            - æ•°æ®ä¸€è‡´æ€§: å·²éªŒè¯

            **å¤„ç†æ­¥éª¤**:
            1. ç¡®è®¤ Sentinel å·²æ‰§è¡Œåˆ‡æ¢
            2. æ£€æŸ¥ä¸»åº“æ•…éšœåŸå› 
            3. ä¿®å¤ä¸»åº“åé‡æ–°é…ç½®ä¸»ä»å¤åˆ¶
          auto_failover: true
          failover_action: sentinel_failover
          slave_instance: "{{ $labels.slave_instance }}"
          runbook_url: "https://your-wiki.com/runbooks/redis-failover"

      # è´Ÿè½½å‡è¡¡å¥åº·æ£€æŸ¥å¤±è´¥
      - alert: LoadBalancerHealthCheckFailed
        expr: |
          count(probe_success{job="blackbox-http"} == 0) by (lb_name) 
          > count(probe_success{job="blackbox-http"}) by (lb_name) / 2
        for: 5m
        labels:
          severity: critical
          priority: P0
          category: network
          component: loadbalancer
          subcategory: failover
        annotations:
          summary: "ğŸ”´ è´Ÿè½½å‡è¡¡å™¨ {{ $labels.lb_name }} å¥åº·æ£€æŸ¥å¤±è´¥"
          description: |
            **è´Ÿè½½å‡è¡¡å™¨**: {{ $labels.lb_name }}
            **å¤±è´¥å®ä¾‹æ•°**: {{ $value }}
            **æ€»å®ä¾‹æ•°**: {{ $labels.total_instances }}

            **æ•…éšœè½¬ç§»ä¿¡æ¯**:
            - è‡ªåŠ¨ç§»é™¤ä¸å¥åº·å®ä¾‹
            - æµé‡é‡æ–°åˆ†é…åˆ°å¥åº·å®ä¾‹
            - å¥åº·æ£€æŸ¥é—´éš”: 30 ç§’

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥å¤±è´¥å®ä¾‹çŠ¶æ€
            2. ä¿®å¤æˆ–æ›¿æ¢å¤±è´¥å®ä¾‹
            3. å®ä¾‹æ¢å¤åè‡ªåŠ¨åŠ å…¥è´Ÿè½½å‡è¡¡
          auto_failover: true
          failover_action: remove_unhealthy_instances
          runbook_url: "https://your-wiki.com/runbooks/lb-health-check-failed"

      # API æœåŠ¡é™çº§
      - alert: APIServiceDegradedAutoScale
        expr: |
          rate(http_requests_total{job="api", status=~"5.."}[5m]) 
          / rate(http_requests_total{job="api"}[5m]) > 0.1
          and on(instance) (
            count(up{job="api"}) by (api_group) > 1
          )
        for: 10m
        labels:
          severity: warning
          priority: P1
          category: application
          component: api
          subcategory: autoscale
        annotations:
          summary: "âš ï¸ API æœåŠ¡ {{ $labels.instance }} é”™è¯¯ç‡è¿‡é«˜ï¼Œè§¦å‘è‡ªåŠ¨æ‰©å®¹"
          description: |
            **API æœåŠ¡**: {{ $labels.instance }}
            **é”™è¯¯ç‡**: {{ $value | humanizePercentage }}
            **è‡ªåŠ¨æ‰©å®¹**: å¢åŠ å®ä¾‹æ•°é‡

            **è‡ªåŠ¨æ‰©å®¹ä¿¡æ¯**:
            - å½“å‰å®ä¾‹æ•°: {{ $labels.current_instances }}
            - ç›®æ ‡å®ä¾‹æ•°: {{ $labels.target_instances }}
            - æ‰©å®¹ç­–ç•¥: é”™è¯¯ç‡é©±åŠ¨

            **å¤„ç†æ­¥éª¤**:
            1. ç¡®è®¤è‡ªåŠ¨æ‰©å®¹å·²æ‰§è¡Œ
            2. åˆ†æé”™è¯¯åŸå› 
            3. ä¼˜åŒ–ä»£ç æˆ–é…ç½®ä»¥å‡å°‘é”™è¯¯
          auto_scale: true
          scale_action: scale_up
          target_instances: "{{ $labels.target_instances }}"
          runbook_url: "https://your-wiki.com/runbooks/api-autoscale"

      # å®¹å™¨å¥åº·æ£€æŸ¥å¤±è´¥è‡ªåŠ¨é‡å¯
      - alert: ContainerHealthCheckFailedAutoRestart
        expr: |
          up{job="docker"} == 0
          and on(instance) (
            container_restart_count < 3
          )
        for: 2m
        labels:
          severity: warning
          priority: P1
          category: container
          component: docker
          subcategory: restart
        annotations:
          summary: "âš ï¸ å®¹å™¨ {{ $labels.instance }} å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œè‡ªåŠ¨é‡å¯"
          description: |
            **å®¹å™¨**: {{ $labels.instance }}
            **å¥åº·æ£€æŸ¥**: å¤±è´¥
            **è‡ªåŠ¨é‡å¯**: æ˜¯

            **è‡ªåŠ¨é‡å¯ä¿¡æ¯**:
            - é‡å¯æ¬¡æ•°: {{ $labels.restart_count }}
            - æœ€å¤§é‡å¯æ¬¡æ•°: 3
            - é‡å¯ç­–ç•¥: on-failure

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥å®¹å™¨æ—¥å¿—
            2. åˆ†æå¥åº·æ£€æŸ¥å¤±è´¥åŸå› 
            3. ä¿®å¤é—®é¢˜åæ‰‹åŠ¨é‡å¯
          auto_restart: true
          restart_action: container_restart
          restart_count: "{{ $labels.restart_count }}"
          runbook_url: "https://your-wiki.com/runbooks/container-restart"

      # DNS è§£æå¤±è´¥è‡ªåŠ¨åˆ‡æ¢ DNS æœåŠ¡å™¨
      - alert: DNSResolutionFailedAutoSwitch
        expr: |
          probe_dns_lookup_success == 0
          and on(instance) (
            count(probe_dns_lookup_success) by (dns_group) > 1
          )
        for: 5m
        labels:
          severity: warning
          priority: P2
          category: network
          component: dns
          subcategory: failover
        annotations:
          summary: "âš ï¸ DNS æœåŠ¡å™¨ {{ $labels.instance }} è§£æå¤±è´¥ï¼Œè‡ªåŠ¨åˆ‡æ¢ DNS æœåŠ¡å™¨"
          description: |
            **DNS æœåŠ¡å™¨**: {{ $labels.instance }}
            **DNS ç»„**: {{ $labels.dns_group }}
            **æ•…éšœè½¬ç§»**: è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨ DNS

            **æ•…éšœè½¬ç§»ä¿¡æ¯**:
            - å¤‡ç”¨ DNS: {{ $labels.backup_dns }}
            - åˆ‡æ¢æ—¶é—´: {{ $value }}
            - TTL: 300 ç§’

            **å¤„ç†æ­¥éª¤**:
            1. ç¡®è®¤ DNS åˆ‡æ¢å·²æ‰§è¡Œ
            2. æ£€æŸ¥ä¸» DNS æœåŠ¡å™¨çŠ¶æ€
            3. ä¿®å¤ä¸» DNS åæ‰‹åŠ¨åˆ‡æ¢å›ä¸» DNS
          auto_failover: true
          failover_action: switch_to_backup_dns
          backup_dns: "{{ $labels.backup_dns }}"
          runbook_url: "https://your-wiki.com/runbooks/dns-failover"

      # CDN èŠ‚ç‚¹æ•…éšœè‡ªåŠ¨åˆ‡æ¢
      - alert: CDNNodeDownAutoSwitch
        expr: |
          probe_success{job="blackbox-http", type="cdn"} == 0
          and on(instance) (
            count(probe_success{job="blackbox-http", type="cdn"}) by (cdn_provider) > 1
          )
        for: 5m
        labels:
          severity: warning
          priority: P2
          category: network
          component: cdn
          subcategory: failover
        annotations:
          summary: "âš ï¸ CDN èŠ‚ç‚¹ {{ $labels.instance }} æ•…éšœï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°å…¶ä»–èŠ‚ç‚¹"
          description: |
            **CDN èŠ‚ç‚¹**: {{ $labels.instance }}
            **CDN æä¾›å•†**: {{ $labels.cdn_provider }}
            **æ•…éšœè½¬ç§»**: è‡ªåŠ¨åˆ‡æ¢åˆ°å¥åº·èŠ‚ç‚¹

            **æ•…éšœè½¬ç§»ä¿¡æ¯**:
            - å¤‡ç”¨èŠ‚ç‚¹: {{ $labels.backup_node }}
            - åˆ‡æ¢æ—¶é—´: {{ $value }}
            - TTL: 60 ç§’

            **å¤„ç†æ­¥éª¤**:
            1. ç¡®è®¤ CDN åˆ‡æ¢å·²æ‰§è¡Œ
            2. æ£€æŸ¥æ•…éšœèŠ‚ç‚¹çŠ¶æ€
            3. è”ç³» CDN æä¾›å•†æ’æŸ¥
          auto_failover: true
          failover_action: switch_to_backup_cdn_node
          backup_node: "{{ $labels.backup_node }}"
          runbook_url: "https://your-wiki.com/runbooks/cdn-failover"

# ===================================================================
# å®‰å…¨å‘Šè­¦ + è‡ªåŠ¨å“åº”å‘Šè­¦è§„åˆ™
# ç”¨é€”: å®‰å…¨å‘Šè­¦è‡ªåŠ¨å“åº”ï¼Œè‡ªåŠ¨åŒ–å®‰å…¨è¿ç»´
# ===================================================================

  - name: security-auto-response-alerts
    interval: 30s
    rules:

      # SSL è¯ä¹¦å³å°†è¿‡æœŸè‡ªåŠ¨ç»­æœŸ
      - alert: SSLCertificateExpiringAutoRenew
        expr: |
          probe_ssl_earliest_cert_expiry - time() < 86400 * 30
        for: 1m
        labels:
          severity: warning
          priority: P1
          category: security
          component: ssl
          subcategory: certificate
        annotations:
          summary: "âš ï¸ SSL è¯ä¹¦ {{ $labels.instance }} å³å°†è¿‡æœŸï¼Œå·²è‡ªåŠ¨è§¦å‘ç»­æœŸ"
          description: |
            **åŸŸå**: {{ $labels.instance }}
            **è¿‡æœŸæ—¶é—´**: {{ $value }}
            **å‰©ä½™å¤©æ•°**: {{ $value }} å¤©

            **è‡ªåŠ¨ç»­æœŸä¿¡æ¯**:
            - ç»­æœŸå·¥å…·: Certbot
            - ç»­æœŸå‘½ä»¤: certbot renew
            - ç»­æœŸæ—¶é—´: {{ $value }}
            - ç»­æœŸçŠ¶æ€: å·²è§¦å‘

            **å¤„ç†æ­¥éª¤**:
            1. ç¡®è®¤è¯ä¹¦å·²ç»­æœŸ
            2. éªŒè¯æ–°è¯ä¹¦
            3. é‡å¯æœåŠ¡åŠ è½½æ–°è¯ä¹¦
          auto_renew: true
          renew_tool: certbot
          renew_command: "certbot renew --quiet"
          runbook_url: "https://your-wiki.com/runbooks/ssl-auto-renew"

      # SSL è¯ä¹¦å·²è¿‡æœŸè‡ªåŠ¨å‘Šè­¦
      - alert: SSLCertificateExpired
        expr: |
          probe_ssl_earliest_cert_expiry < time()
        for: 1m
        labels:
          severity: critical
          priority: P0
          category: security
          component: ssl
          subcategory: certificate
        annotations:
          summary: "ğŸ”´ SSL è¯ä¹¦ {{ $labels.instance }} å·²è¿‡æœŸ"
          description: |
            **åŸŸå**: {{ $labels.instance }}
            **è¿‡æœŸæ—¶é—´**: {{ $value }}

            **é£é™©**:
            - æµè§ˆå™¨æ˜¾ç¤ºè¯ä¹¦é”™è¯¯
            - HTTPS è¿æ¥è¢«é˜»æ­¢
            - æ•°æ®ä¼ è¾“ä¸å®‰å…¨

            **å¤„ç†æ­¥éª¤**:
            1. ç«‹å³ç»­æœŸè¯ä¹¦
            2. éªŒè¯æ–°è¯ä¹¦
            3. é‡å¯æœåŠ¡åŠ è½½æ–°è¯ä¹¦
          risk_level: critical
          auto_renew: false
          manual_intervention: true
          runbook_url: "https://your-wiki.com/runbooks/ssl-expired"

      # å¼‚å¸¸ç™»å½•è‡ªåŠ¨å°ç¦ IP
      - alert: SuspiciousLoginAutoBlock
        expr: |
          rate(auth_login_failed_total[5m]) > 10
        for: 5m
        labels:
          severity: critical
          priority: P0
          category: security
          component: auth
          subcategory: login
        annotations:
          summary: "ğŸ”´ æ£€æµ‹åˆ°å¼‚å¸¸ç™»å½•ï¼Œå·²è‡ªåŠ¨å°ç¦ IP {{ $labels.client_ip }}"
          description: |
            **å®¢æˆ·ç«¯ IP**: {{ $labels.client_ip }}
            **å¤±è´¥æ¬¡æ•°**: {{ $value }}
            **ç”¨æˆ·å**: {{ $labels.username }}

            **è‡ªåŠ¨å°ç¦ä¿¡æ¯**:
            - å°ç¦ IP: {{ $labels.client_ip }}
            - å°ç¦æ—¶é•¿: 1 å°æ—¶
            - å°ç¦åŸå› : æš´åŠ›ç ´è§£
            - å°ç¦æ—¶é—´: {{ $value }}

            **å¤„ç†æ­¥éª¤**:
            1. ç¡®è®¤å°ç¦å·²æ‰§è¡Œ
            2. æ£€æŸ¥ç™»å½•æ—¥å¿—
            3. è”ç³»ç”¨æˆ·ç¡®è®¤
          auto_block: true
          block_action: iptables_block
          block_duration: "1h"
          runbook_url: "https://your-wiki.com/runbooks/suspicious-login-block"

      # ç«¯å£æ‰«ææ£€æµ‹è‡ªåŠ¨å°ç¦ IP
      - alert: PortScanDetectedAutoBlock
        expr: |
          rate(network_connections_total{state="new"}[5m]) > 100
        for: 5m
        labels:
          severity: warning
          priority: P1
          category: security
          component: network
          subcategory: scan
        annotations:
          summary: "âš ï¸ æ£€æµ‹åˆ°ç«¯å£æ‰«æï¼Œå·²è‡ªåŠ¨å°ç¦ IP {{ $labels.client_ip }}"
          description: |
            **å®¢æˆ·ç«¯ IP**: {{ $labels.client_ip }}
            **æ‰«æç«¯å£æ•°**: {{ $value }}
            **æ‰«æé€Ÿç‡**: {{ $value }} ports/min

            **è‡ªåŠ¨å°ç¦ä¿¡æ¯**:
            - å°ç¦ IP: {{ $labels.client_ip }}
            - å°ç¦æ—¶é•¿: 24 å°æ—¶
            - å°ç¦åŸå› : ç«¯å£æ‰«æ
            - å°ç¦æ—¶é—´: {{ $value }}

            **å¤„ç†æ­¥éª¤**:
            1. ç¡®è®¤å°ç¦å·²æ‰§è¡Œ
            2. æ£€æŸ¥æ‰«ææ—¥å¿—
            3. è”ç³»å®‰å…¨å›¢é˜Ÿ
          auto_block: true
          block_action: iptables_block
          block_duration: "24h"
          runbook_url: "https://your-wiki.com/runbooks/port-scan-block"

      # æ¶æ„æ–‡ä»¶æ£€æµ‹è‡ªåŠ¨éš”ç¦»
      - alert: MaliciousFileDetectedAutoQuarantine
        expr: |
          antivirus_scan_result{status="infected"} > 0
        for: 1m
        labels:
          severity: critical
          priority: P0
          category: security
          component: antivirus
          subcategory: malware
        annotations:
          summary: "ğŸ”´ æ£€æµ‹åˆ°æ¶æ„æ–‡ä»¶ï¼Œå·²è‡ªåŠ¨éš”ç¦» {{ $labels.file_path }}"
          description: |
            **æ–‡ä»¶è·¯å¾„**: {{ $labels.file_path }}
            **ç—…æ¯’åç§°**: {{ $labels.virus_name }}
            **æ–‡ä»¶å¤§å°**: {{ $labels.file_size }}

            **è‡ªåŠ¨éš”ç¦»ä¿¡æ¯**:
            - éš”ç¦»æ–‡ä»¶: {{ $labels.file_path }}
            - éš”ç¦»ä½ç½®: /quarantine/
            - éš”ç¦»æ—¶é—´: {{ $value }}
            - éš”ç¦»çŠ¶æ€: å·²éš”ç¦»

            **å¤„ç†æ­¥éª¤**:
            1. ç¡®è®¤æ–‡ä»¶å·²éš”ç¦»
            2. åˆ†æç—…æ¯’ç±»å‹
            3. æ¸…ç†ç³»ç»Ÿ
          auto_quarantine: true
          quarantine_location: "/quarantine/"
          runbook_url: "https://your-wiki.com/runbooks/malicious-file-quarantine"

      # å®‰å…¨è¡¥ä¸ç¼ºå¤±è‡ªåŠ¨å®‰è£…
      - alert: SecurityPatchMissingAutoInstall
        expr: |
          count(system_package{status="security-update"}) > 0
        for: 10m
        labels:
          severity: warning
          priority: P1
          category: security
          component: system
          subcategory: patch
        annotations:
          summary: "âš ï¸ æ£€æµ‹åˆ°å®‰å…¨è¡¥ä¸ç¼ºå¤±ï¼Œå·²è‡ªåŠ¨è§¦å‘å®‰è£…"
          description: |
            **ä¸»æœº**: {{ $labels.instance }}
            **è¡¥ä¸æ•°é‡**: {{ $value }}
            **è¡¥ä¸ç±»å‹**: å®‰å…¨æ›´æ–°

            **è‡ªåŠ¨å®‰è£…ä¿¡æ¯**:
            - å®‰è£…å·¥å…·: apt/yum
            - å®‰è£…å‘½ä»¤: apt-get install --only-upgrade
            - å®‰è£…æ—¶é—´: {{ $value }}
            - å®‰è£…çŠ¶æ€: å·²è§¦å‘

            **å¤„ç†æ­¥éª¤**:
            1. ç¡®è®¤è¡¥ä¸å·²å®‰è£…
            2. éªŒè¯ç³»ç»Ÿç¨³å®šæ€§
            3. é‡å¯æœåŠ¡ï¼ˆå¦‚éœ€è¦ï¼‰
          auto_install: true
          install_tool: apt
          install_command: "apt-get install --only-upgrade -y"
          runbook_url: "https://your-wiki.com/runbooks/security-patch-auto-install"

      # é˜²ç«å¢™è§„åˆ™å¼‚å¸¸è‡ªåŠ¨ä¿®å¤
      - alert: FirewallRuleAnomalyAutoFix
        expr: |
          firewall_rule_status != "active"
        for: 5m
        labels:
          severity: warning
          priority: P1
          category: security
          component: firewall
          subcategory: rule
        annotations:
          summary: "âš ï¸ æ£€æµ‹åˆ°é˜²ç«å¢™è§„åˆ™å¼‚å¸¸ï¼Œå·²è‡ªåŠ¨ä¿®å¤"
          description: |
            **è§„åˆ™ ID**: {{ $labels.rule_id }}
            **è§„åˆ™åç§°**: {{ $labels.rule_name }}
            **å¼‚å¸¸çŠ¶æ€**: {{ $labels.status }}

            **è‡ªåŠ¨ä¿®å¤ä¿¡æ¯**:
            - ä¿®å¤æ“ä½œ: é‡æ–°åŠ è½½è§„åˆ™
            - ä¿®å¤å‘½ä»¤: iptables-restore
            - ä¿®å¤æ—¶é—´: {{ $value }}
            - ä¿®å¤çŠ¶æ€: å·²è§¦å‘

            **å¤„ç†æ­¥éª¤**:
            1. ç¡®è®¤è§„åˆ™å·²ä¿®å¤
            2. éªŒè¯é˜²ç«å¢™çŠ¶æ€
            3. æ£€æŸ¥å®‰å…¨æ—¥å¿—
          auto_fix: true
          fix_action: reload_rules
          fix_command: "iptables-restore < /etc/iptables/rules.v4"
          runbook_url: "https://your-wiki.com/runbooks/firewall-rule-auto-fix"

      # SSH æš´åŠ›ç ´è§£è‡ªåŠ¨å°ç¦
      - alert: SSHBruteForceAutoBlock
        expr: |
          rate(auth_ssh_login_failed_total[5m]) > 5
        for: 5m
        labels:
          severity: critical
          priority: P0
          category: security
          component: ssh
          subcategory: brute_force
        annotations:
          summary: "ğŸ”´ æ£€æµ‹åˆ° SSH æš´åŠ›ç ´è§£ï¼Œå·²è‡ªåŠ¨å°ç¦ IP {{ $labels.client_ip }}"
          description: |
            **å®¢æˆ·ç«¯ IP**: {{ $labels.client_ip }}
            **å¤±è´¥æ¬¡æ•°**: {{ $value }}
            **ç”¨æˆ·å**: {{ $labels.username }}

            **è‡ªåŠ¨å°ç¦ä¿¡æ¯**:
            - å°ç¦ IP: {{ $labels.client_ip }}
            - å°ç¦æ—¶é•¿: 24 å°æ—¶
            - å°ç¦åŸå› : SSH æš´åŠ›ç ´è§£
            - å°ç¦æ—¶é—´: {{ $value }}

            **å¤„ç†æ­¥éª¤**:
            1. ç¡®è®¤å°ç¦å·²æ‰§è¡Œ
            2. æ£€æŸ¥ç™»å½•æ—¥å¿—
            3. è”ç³»å®‰å…¨å›¢é˜Ÿ
          auto_block: true
          block_action: fail2ban_block
          block_duration: "24h"
          runbook_url: "https://your-wiki.com/runbooks/ssh-brute-force-block"

      # æ•°æ®åº“å¤‡ä»½å¤±è´¥è‡ªåŠ¨é‡è¯•
      - alert: DatabaseBackupFailedAutoRetry
        expr: |
          database_backup_status != "success"
        for: 5m
        labels:
          severity: warning
          priority: P1
          category: database
          component: backup
          subcategory: retry
        annotations:
          summary: "âš ï¸ æ•°æ®åº“å¤‡ä»½å¤±è´¥ï¼Œå·²è‡ªåŠ¨é‡è¯•"
          description: |
            **æ•°æ®åº“**: {{ $labels.instance }}
            **å¤‡ä»½çŠ¶æ€**: {{ $labels.status }}
            **å¤±è´¥åŸå› **: {{ $labels.error }}

            **è‡ªåŠ¨é‡è¯•ä¿¡æ¯**:
            - é‡è¯•æ¬¡æ•°: {{ $labels.retry_count }}
            - æœ€å¤§é‡è¯•æ¬¡æ•°: 3
            - é‡è¯•é—´éš”: 5 åˆ†é’Ÿ
            - é‡è¯•æ—¶é—´: {{ $value }}

            **å¤„ç†æ­¥éª¤**:
            1. ç¡®è®¤é‡è¯•å·²æ‰§è¡Œ
            2. æ£€æŸ¥å¤‡ä»½æ—¥å¿—
            3. æ‰‹åŠ¨å¤‡ä»½ï¼ˆå¦‚éœ€è¦ï¼‰
          auto_retry: true
          retry_count: "{{ $labels.retry_count }}"
          max_retries: 3
          runbook_url: "https://your-wiki.com/runbooks/database-backup-auto-retry"

  - name: blackbox-icmp-alerts
    interval: 30s
    rules:

      # ICMP Ping æ¢æµ‹å¤±è´¥ï¼ˆè®¾å¤‡ä¸å¯è¾¾ï¼‰
      - alert: HostDown
        expr: probe_success{job="blackbox-icmp"} == 0
        for: 2m
        labels:
          severity: critical
          priority: P0
          category: availability
          component: network
        annotations:
          summary: "ğŸ”´ ä¸»æœº {{ $labels.instance }} æ— æ³• Ping é€š"
          description: |
            **ä¸»æœº**: {{ $labels.instance }}
            **è®¾å¤‡åç§°**: {{ $labels.device_name }}
            **è®¾å¤‡ç±»å‹**: {{ $labels.device_type }}

            **å¯èƒ½åŸå› **:
            - è®¾å¤‡å®•æœº
            - ç½‘ç»œä¸å¯è¾¾
            - é˜²ç«å¢™é˜»æ­¢ ICMP

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥è®¾å¤‡ç”µæºå’Œè¿æ¥
            2. ç™»å½•è®¾å¤‡æ§åˆ¶å°
            3. æ£€æŸ¥ç½‘ç»œè·¯ç”±
            4. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
          runbook_url: "https://your-wiki.com/runbooks/host-down"

      # ICMP ä¸¢åŒ…ç‡è¿‡é«˜
      - alert: HighPacketLoss
        expr: probe_icmp_reply_packet_loss_percent{job="blackbox-icmp"} > 5
        for: 5m
        labels:
          severity: warning
          priority: P2
          category: network
          component: connectivity
        annotations:
          summary: "âš ï¸ ä¸»æœº {{ $labels.instance }} ä¸¢åŒ…ç‡è¿‡é«˜"
          description: |
            **ä¸»æœº**: {{ $labels.instance }}
            **ä¸¢åŒ…ç‡**: {{ $value | humanizePercentage }}

            **å¯èƒ½åŸå› **:
            - ç½‘ç»œæ‹¥å¡
            - é“¾è·¯è´¨é‡å·®
            - è®¾å¤‡è¿‡è½½

            **å¤„ç†æ­¥éª¤**:
            1. æŒç»­ Ping è§‚å¯Ÿ: `ping -c 100 {{ $labels.instance }}`
            2. æ£€æŸ¥ç½‘ç»œé“¾è·¯
            3. æ£€æŸ¥è®¾å¤‡è´Ÿè½½
          runbook_url: "https://your-wiki.com/runbooks/high-packet-loss"

      # ICMP å»¶è¿Ÿè¿‡é«˜
      - alert: HighICMPLatency
        expr: probe_icmp_duration_seconds{job="blackbox-icmp"} > 0.1
        for: 5m
        labels:
          severity: warning
          priority: P2
          category: network
          component: latency
        annotations:
          summary: "âš ï¸ ä¸»æœº {{ $labels.instance }} ç½‘ç»œå»¶è¿Ÿè¿‡é«˜"
          description: |
            **ä¸»æœº**: {{ $labels.instance }}
            **Ping å»¶è¿Ÿ**: {{ $value | humanizeDuration }}

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥ç½‘ç»œè·¯å¾„: `traceroute {{ $labels.instance }}`
            2. æ£€æŸ¥è®¾å¤‡è´Ÿè½½
            3. æ£€æŸ¥é“¾è·¯å¸¦å®½
          runbook_url: "https://your-wiki.com/runbooks/high-latency"

  - name: blackbox-tcp-alerts
    interval: 30s
    rules:

      # TCP ç«¯å£æ— æ³•è¿æ¥
      - alert: TCPPortDown
        expr: probe_success{job="blackbox-tcp"} == 0
        for: 2m
        labels:
          severity: critical
          priority: P1
          category: availability
          component: service
        annotations:
          summary: "ğŸ”´ TCP ç«¯å£ {{ $labels.instance }} æ— æ³•è¿æ¥"
          description: |
            **æœåŠ¡åœ°å€**: {{ $labels.instance }}

            **å¯èƒ½åŸå› **:
            - æœåŠ¡æœªå¯åŠ¨
            - ç«¯å£è¢«å ç”¨
            - é˜²ç«å¢™é˜»æ­¢

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
            2. æ£€æŸ¥ç«¯å£ç›‘å¬: `netstat -tuln`
            3. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
          runbook_url: "https://your-wiki.com/runbooks/tcp-port-down"

      # TCP è¿æ¥æ—¶é—´è¿‡é•¿
      - alert: TCPConnectionSlow
        expr: probe_duration_seconds{job="blackbox-tcp"} > 1
        for: 5m
        labels:
          severity: warning
          priority: P2
          category: performance
          component: service
        annotations:
          summary: "âš ï¸ TCP ç«¯å£ {{ $labels.instance }} è¿æ¥ç¼“æ…¢"
          description: |
            **æœåŠ¡åœ°å€**: {{ $labels.instance }}
            **è¿æ¥æ—¶é—´**: {{ $value | humanizeDuration }}

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥æœåŠ¡è´Ÿè½½
            2. æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿ
            3. ä¼˜åŒ–æœåŠ¡æ€§èƒ½
          runbook_url: "https://your-wiki.com/runbooks/tcp-connection-slow"

  - name: blackbox-exporter-health
    interval: 30s
    rules:

      # Blackbox Exporter æœåŠ¡å®•æœº
      - alert: BlackboxExporterDown
        expr: up{job="blackbox-exporter"} == 0
        for: 2m
        labels:
          severity: critical
          priority: P1
          category: monitoring
          component: blackbox
        annotations:
          summary: "ğŸ”´ Blackbox Exporter æœåŠ¡å®•æœº"
          description: |
            **å½±å“**: æ— æ³•è¿›è¡ŒæœåŠ¡å¯ç”¨æ€§æ¢æµ‹

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥å®¹å™¨çŠ¶æ€: `docker ps | grep blackbox`
            2. æŸ¥çœ‹æ—¥å¿—: `docker logs blackbox-exporter`
            3. é‡å¯æœåŠ¡: `docker-compose restart blackbox-exporter`
          runbook_url: "https://your-wiki.com/runbooks/blackbox-exporter-down"

# ===================================================================
# å‘Šè­¦è§„åˆ™è¯´æ˜:
#
# 1. Blackbox æ¢æµ‹ç±»å‹:
#    - HTTP: ç½‘ç«™å¯ç”¨æ€§ã€å“åº”æ—¶é—´ã€çŠ¶æ€ç 
#    - HTTPS SSL: SSL è¯ä¹¦æœ‰æ•ˆæœŸ
#    - ICMP: ç½‘ç»œè¿é€šæ€§ã€ä¸¢åŒ…ç‡ã€å»¶è¿Ÿ
#    - TCP: ç«¯å£å¯ç”¨æ€§ã€è¿æ¥æ—¶é—´
#
# 2. å‘Šè­¦ä¼˜å…ˆçº§:
#    - ç½‘ç«™å®•æœº: P0ï¼ˆå½±å“ç”¨æˆ·è®¿é—®ï¼‰
#    - SSL è¯ä¹¦è¿‡æœŸ: P0ï¼ˆå®‰å…¨é£é™©ï¼‰
#    - ç½‘ç»œå»¶è¿Ÿ/ä¸¢åŒ…: P2ï¼ˆæ€§èƒ½é—®é¢˜ï¼‰
#
# 3. SSL è¯ä¹¦ç›‘æ§:
#    - 30 å¤©: Warningï¼ˆæé†’å‡†å¤‡ï¼‰
#    - 7 å¤©: Criticalï¼ˆç´§æ€¥ç»­æœŸï¼‰
#    - å·²è¿‡æœŸ: Criticalï¼ˆç«‹å³å¤„ç†ï¼‰
#
# æ›´å¤šæ–‡æ¡£: docs/BLACKBOX-MONITORING-GUIDE.md
# ===================================================================

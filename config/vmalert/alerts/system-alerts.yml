# ===================================================================
# Metrics + Logs æ·±åº¦è”åŠ¨å‘Šè­¦è§„åˆ™
# ç”¨é€”: å‘Šè­¦è‡ªåŠ¨è§¦å‘æ—¥å¿—æŸ¥è¯¢ï¼Œå¿«é€Ÿå®šä½é—®é¢˜
# ===================================================================

  - name: metrics-logs-alerts
    interval: 30s
    rules:

      # HTTP é”™è¯¯ç‡è¿‡é«˜ + è‡ªåŠ¨æ—¥å¿—æŸ¥è¯¢
      - alert: HighHTTPErrorRate
        expr: |
          rate(http_requests_total{status=~"5.."}[5m]) 
          / rate(http_requests_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          priority: P1
          category: application
          component: http
          subcategory: logs
        annotations:
          summary: "âš ï¸ æœåŠ¡ {{ $labels.instance }} HTTP é”™è¯¯ç‡è¿‡é«˜"
          description: |
            **æœåŠ¡**: {{ $labels.instance }}
            **é”™è¯¯ç‡**: {{ $value | humanizePercentage }}
            **çŠ¶æ€ç **: {{ $labels.status }}

            **è‡ªåŠ¨æ—¥å¿—æŸ¥è¯¢**:
            ```logql
            {job="{{ $labels.job }}", instance="{{ $labels.instance }}"} 
            |~ "error|Error|ERROR" 
            | line_format "{{.timestamp}} {{.message}}"
            ```

            **å¤„ç†æ­¥éª¤**:
            1. æŸ¥çœ‹ä¸Šè¿°æ—¥å¿—æŸ¥è¯¢ç»“æœ
            2. åˆ†æé”™è¯¯æ—¥å¿—æ¨¡å¼
            3. å®šä½æ ¹å› å¹¶ä¿®å¤
          log_query: '{job="{{ $labels.job }}", instance="{{ $labels.instance }}"} |~ "error|Error|ERROR"'
          grafana_url: "http://localhost:3000/d/logs-explorer?expr={job=%22{{ $labels.job }}%22,%20instance=%22{{ $labels.instance }}%22}%20%7C~%20%22error%7CError%7CERROR%22"
          runbook_url: "https://your-wiki.com/runbooks/http-error-rate"

      # CPU ä½¿ç”¨ç‡è¿‡é«˜ + è‡ªåŠ¨æ—¥å¿—æŸ¥è¯¢
      - alert: HighCPUUsageWithLogs
        expr: |
          rate(node_cpu_seconds_total{mode="idle"}[5m]) < 0.1
        for: 10m
        labels:
          severity: warning
          priority: P2
          category: host
          component: cpu
          subcategory: logs
        annotations:
          summary: "âš ï¸ ä¸»æœº {{ $labels.instance }} CPU ä½¿ç”¨ç‡è¿‡é«˜"
          description: |
            **ä¸»æœº**: {{ $labels.instance }}
            **CPU ä½¿ç”¨ç‡**: {{ $value | humanizePercentage }}
            **å‘Šè­¦æŒç»­æ—¶é—´**: {{ $labels.alert_duration }} åˆ†é’Ÿ

            **è‡ªåŠ¨æ—¥å¿—æŸ¥è¯¢**ï¼ˆåŠ¨æ€æ—¶é—´çª—å£ï¼‰:
            ```logql
            {host="{{ $labels.instance }}"}
            |~ "cpu|CPU|process|Process"
            | level != "debug"
            | line_format "{{.timestamp}} {{.level}} {{.message}}"
            ```

            **å¤„ç†æ­¥éª¤**:
            1. æŸ¥çœ‹ä¸Šè¿°æ—¥å¿—æŸ¥è¯¢ç»“æœ
            2. è¯†åˆ«é«˜ CPU è¿›ç¨‹
            3. ä¼˜åŒ–æˆ–ç»ˆæ­¢å¼‚å¸¸è¿›ç¨‹

            **ç›¸å…³æŒ‡æ ‡**:
            - å½“å‰ CPU ä½¿ç”¨ç‡: {{ $value | humanizePercentage }}
            - 1 å°æ—¶å¹³å‡å€¼: {{ $labels.cpu_avg_1h | humanizePercentage }}
            - è¶‹åŠ¿æ–œç‡: {{ $labels.cpu_trend_slope_1h }}%/ç§’

            **å†å²å¯¹æ¯”**:
            - æ˜¨å¤©åŒæœŸ: {{ $labels.cpu_history_yesterday | humanizePercentage }}
            - 7 å¤©åŸºçº¿: {{ $labels.cpu_history_baseline_7d | humanizePercentage }}
            - å†å²åå·®: {{ $labels.cpu_deviation_from_history }}%
          log_query: '{host="{{ $labels.instance }}"} |~ "cpu|CPU|process|Process" | level != "debug"'
          grafana_url: "http://localhost:3000/d/logs-explorer?expr={host=%22{{ $labels.instance }}%22}%20%7C~%20%22cpu%7CCPU%7Cprocess%7CProcess%22%20%7C%20level%20!=%20%22debug%22"
          runbook_url: "https://your-wiki.com/runbooks/high-cpu-usage"

      # å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ + è‡ªåŠ¨æ—¥å¿—æŸ¥è¯¢
      - alert: HighMemoryUsageWithLogs
        expr: |
          (1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) > 0.9
        for: 10m
        labels:
          severity: warning
          priority: P2
          category: host
          component: memory
          subcategory: logs
        annotations:
          summary: "âš ï¸ ä¸»æœº {{ $labels.instance }} å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜"
          description: |
            **ä¸»æœº**: {{ $labels.instance }}
            **å†…å­˜ä½¿ç”¨ç‡**: {{ $value | humanizePercentage }}
            **å‘Šè­¦æŒç»­æ—¶é—´**: {{ $labels.alert_duration }} åˆ†é’Ÿ

            **è‡ªåŠ¨æ—¥å¿—æŸ¥è¯¢**ï¼ˆåŠ¨æ€æ—¶é—´çª—å£ï¼‰:
            ```logql
            {host="{{ $labels.instance }}"}
            |~ "oom|OOM|memory|Memory"
            | level =~ "error|warning"
            | line_format "{{.timestamp}} {{.level}} {{.message}}"
            ```

            **å¤„ç†æ­¥éª¤**:
            1. æŸ¥çœ‹ä¸Šè¿°æ—¥å¿—æŸ¥è¯¢ç»“æœ
            2. æ£€æŸ¥æ˜¯å¦æœ‰ OOM Killer
            3. ä¼˜åŒ–å†…å­˜ä½¿ç”¨æˆ–å¢åŠ å†…å­˜

            **ç›¸å…³æŒ‡æ ‡**:
            - å½“å‰å†…å­˜ä½¿ç”¨ç‡: {{ $value | humanizePercentage }}
            - 1 å°æ—¶å¹³å‡å€¼: {{ $labels.mem_avg_1h | humanizePercentage }}
            - è¶‹åŠ¿æ–œç‡: {{ $labels.mem_trend_slope_1h }}%/ç§’

            **å†å²å¯¹æ¯”**:
            - æ˜¨å¤©åŒæœŸ: {{ $labels.mem_history_yesterday | humanizePercentage }}
            - 7 å¤©åŸºçº¿: {{ $labels.mem_history_baseline_7d | humanizePercentage }}
            - å†å²åå·®: {{ $labels.mem_deviation_from_history }}%

            **é¢„æµ‹ä¿¡æ¯**:
            - 1 å°æ—¶åé¢„æµ‹: {{ $labels.mem_predicted_1h | humanizePercentage }}
            - é¢„æµ‹ç½®ä¿¡åº¦: {{ $labels.mem_prediction_confidence | printf "%.0f" }}%
          log_query: '{host="{{ $labels.instance }}"} |~ "oom|OOM|memory|Memory" | level =~ "error|warning"'
          grafana_url: "http://localhost:3000/d/logs-explorer?expr={host=%22{{ $labels.instance }}%22}%20%7C~%20%22oom%7COOM%7Cmemory%7CMemory%22%20%7C%20level%20=~%20%22error%7Cwarning%22"
          runbook_url: "https://your-wiki.com/runbooks/high-memory-usage"

      # ç£ç›˜ IO è¿‡é«˜ + è‡ªåŠ¨æ—¥å¿—æŸ¥è¯¢
      - alert: HighDiskIOWithLogs
        expr: |
          rate(node_disk_io_time_seconds_total[5m]) > 0.8
        for: 10m
        labels:
          severity: warning
          priority: P2
          category: host
          component: disk
          subcategory: logs
        annotations:
          summary: "âš ï¸ ä¸»æœº {{ $labels.instance }} ç£ç›˜ IO è¿‡é«˜"
          description: |
            **ä¸»æœº**: {{ $labels.instance }}
            **ç£ç›˜**: {{ $labels.device }}
            **IO ä½¿ç”¨ç‡**: {{ $value | humanizePercentage }}
            **å‘Šè­¦æŒç»­æ—¶é—´**: {{ $labels.alert_duration }} åˆ†é’Ÿ

            **è‡ªåŠ¨æ—¥å¿—æŸ¥è¯¢**ï¼ˆåŠ¨æ€æ—¶é—´çª—å£ï¼‰:
            ```logql
            {host="{{ $labels.instance }}"}
            |~ "disk|Disk|io|IO|iowait"
            | level != "debug"
            | line_format "{{.timestamp}} {{.level}} {{.message}}"
            ```

            **å¤„ç†æ­¥éª¤**:
            1. æŸ¥çœ‹ä¸Šè¿°æ—¥å¿—æŸ¥è¯¢ç»“æœ
            2. è¯†åˆ«é«˜ IO è¿›ç¨‹
            3. ä¼˜åŒ–ç£ç›˜è®¿é—®æˆ–å‡çº§å­˜å‚¨

            **ç›¸å…³æŒ‡æ ‡**:
            - å½“å‰ IO ä½¿ç”¨ç‡: {{ $value | humanizePercentage }}
            - ç£ç›˜ä½¿ç”¨ç‡: {{ $labels.disk_usage_percentage | humanizePercentage }}

            **é¢„æµ‹ä¿¡æ¯**:
            - 7 å¤©åé¢„æµ‹ä½¿ç”¨ç‡: {{ $labels.disk_predicted_7d | humanizePercentage }}
            - é¢„è®¡æ»¡æ—¶é—´: {{ $labels.time_until_full }} å¤©
          log_query: '{host="{{ $labels.instance }}"} |~ "disk|Disk|io|IO|iowait" | level != "debug"'
          grafana_url: "http://localhost:3000/d/logs-explorer?expr={host=%22{{ $labels.instance }}%22}%20%7C~%20%22disk%7CDisk%7Cio%7CIO%7Ciowait%22%20%7C%20level%20!=%20%22debug%22"
          runbook_url: "https://your-wiki.com/runbooks/high-disk-io"

      # ç½‘ç»œé”™è¯¯ç‡è¿‡é«˜ + è‡ªåŠ¨æ—¥å¿—æŸ¥è¯¢
      - alert: HighNetworkErrorsWithLogs
        expr: |
          rate(node_network_receive_errs_total[5m]) > 100
        for: 10m
        labels:
          severity: warning
          priority: P2
          category: host
          component: network
          subcategory: logs
        annotations:
          summary: "âš ï¸ ä¸»æœº {{ $labels.instance }} ç½‘ç»œé”™è¯¯ç‡è¿‡é«˜"
          description: |
            **ä¸»æœº**: {{ $labels.instance }}
            **æ¥å£**: {{ $labels.device }}
            **é”™è¯¯é€Ÿç‡**: {{ $value }} errors/sec

            **è‡ªåŠ¨æ—¥å¿—æŸ¥è¯¢**:
            ```logql
            {host="{{ $labels.instance }}"} 
            |~ "network|Network|ethernet|Ethernet|crc|CRC" 
            | level =~ "error|warning"
            ```

            **å¤„ç†æ­¥éª¤**:
            1. æŸ¥çœ‹ä¸Šè¿°æ—¥å¿—æŸ¥è¯¢ç»“æœ
            2. æ£€æŸ¥ç½‘ç»œçº¿ç¼†å’Œæ¥å£
            3. è”ç³»ç½‘ç»œå›¢é˜Ÿæ’æŸ¥
          log_query: '{host="{{ $labels.instance }}"} |~ "network|Network|ethernet|Ethernet|crc|CRC" | level =~ "error|warning"'
          grafana_url: "http://localhost:3000/d/logs-explorer?expr={host=%22{{ $labels.instance }}%22}%20%7C~%20%22network%7CNetwork%7Cethernet%7CEthernet%7Ccrc%7CCRC%22%20%7C%20level%20=~%20%22error%7Cwarning%22"
          runbook_url: "https://your-wiki.com/runbooks/high-network-errors"

      # æ•°æ®åº“è¿æ¥æ± è€—å°½ + è‡ªåŠ¨æ—¥å¿—æŸ¥è¯¢
      - alert: DatabaseConnectionPoolExhausted
        expr: |
          db_connections_active / db_connections_max > 0.9
        for: 5m
        labels:
          severity: critical
          priority: P0
          category: database
          component: connection
          subcategory: logs
        annotations:
          summary: "ğŸ”´ æ•°æ®åº“ {{ $labels.instance }} è¿æ¥æ± è€—å°½"
          description: |
            **æ•°æ®åº“**: {{ $labels.instance }}
            **è¿æ¥æ± ä½¿ç”¨ç‡**: {{ $value | humanizePercentage }}

            **è‡ªåŠ¨æ—¥å¿—æŸ¥è¯¢**:
            ```logql
            {job="{{ $labels.job }}", instance="{{ $labels.instance }}"} 
            |~ "connection|Connection|pool|Pool|timeout|Timeout" 
            | level =~ "error|warning"
            ```

            **å¤„ç†æ­¥éª¤**:
            1. æŸ¥çœ‹ä¸Šè¿°æ—¥å¿—æŸ¥è¯¢ç»“æœ
            2. æ£€æŸ¥è¿æ¥æ³„æ¼
            3. å¢åŠ è¿æ¥æ± å¤§å°æˆ–ä¼˜åŒ–æŸ¥è¯¢
          log_query: '{job="{{ $labels.job }}", instance="{{ $labels.instance }}"} |~ "connection|Connection|pool|Pool|timeout|Timeout" | level =~ "error|warning"'
          grafana_url: "http://localhost:3000/d/logs-explorer?expr={job=%22{{ $labels.job }}%22,%20instance=%22{{ $labels.instance }}%22}%20%7C~%20%22connection%7CConnection%7Cpool%7CPool%7Ctimeout%7CTimeout%22%20%7C%20level%20=~%20%22error%7Cwarning%22"
          runbook_url: "https://your-wiki.com/runbooks/connection-pool-exhausted"

      # åº”ç”¨å¼‚å¸¸æ—¥å¿—æ¿€å¢ + è‡ªåŠ¨å‘Šè­¦
      - alert: ApplicationErrorSpike
        expr: |
          rate(log_lines_total{level="error"}[5m]) 
          > avg_over_time(rate(log_lines_total{level="error"}[1h])[5m:5m]) * 3
        for: 5m
        labels:
          severity: warning
          priority: P1
          category: application
          component: logs
          subcategory: anomaly
        annotations:
          summary: "âš ï¸ åº”ç”¨ {{ $labels.job }} é”™è¯¯æ—¥å¿—æ¿€å¢"
          description: |
            **åº”ç”¨**: {{ $labels.job }}
            **é”™è¯¯æ—¥å¿—é€Ÿç‡**: {{ $value }} lines/sec
            **åŸºå‡†é€Ÿç‡**: {{ $value }} lines/sec

            **è‡ªåŠ¨æ—¥å¿—æŸ¥è¯¢**:
            ```logql
            {job="{{ $labels.job }}", level="error"} 
            | line_format "{{.timestamp}} {{.message}}"
            ```

            **å¤„ç†æ­¥éª¤**:
            1. æŸ¥çœ‹ä¸Šè¿°æ—¥å¿—æŸ¥è¯¢ç»“æœ
            2. åˆ†æé”™è¯¯æ¨¡å¼
            3. å®šä½æ ¹å› å¹¶ä¿®å¤
          log_query: '{job="{{ $labels.job }}", level="error"} | line_format "{{.timestamp}} {{.message}}"'
          grafana_url: "http://localhost:3000/d/logs-explorer?expr={job=%22{{ $labels.job }}%22,%20level=%22error%22}%20%7C%20line_format%20%22{{.timestamp}}%20{{.message}}%22"
          runbook_url: "https://your-wiki.com/runbooks/error-spike"

      # æ—¥å¿—æ¨¡å¼å¼‚å¸¸æ£€æµ‹
      - alert: UnusualLogPattern
        expr: |
          count_over_time(log_lines_total{job=~".*"}[5m]) 
          > avg_over_time(count_over_time(log_lines_total{job=~".*"}[5m])[1h:5m]) * 2
        for: 10m
        labels:
          severity: warning
          priority: P2
          category: application
          component: logs
          subcategory: anomaly
        annotations:
          summary: "âš ï¸ åº”ç”¨ {{ $labels.job }} æ—¥å¿—é‡å¼‚å¸¸"
          description: |
            **åº”ç”¨**: {{ $labels.job }}
            **å½“å‰æ—¥å¿—é‡**: {{ $value }} lines/5m
            **åŸºå‡†æ—¥å¿—é‡**: {{ $value }} lines/5m

            **è‡ªåŠ¨æ—¥å¿—æŸ¥è¯¢**:
            ```logql
            {job="{{ $labels.job }}"} 
            | line_format "{{.timestamp}} {{.level}} {{.message}}"
            ```

            **å¤„ç†æ­¥éª¤**:
            1. æŸ¥çœ‹ä¸Šè¿°æ—¥å¿—æŸ¥è¯¢ç»“æœ
            2. åˆ†ææ—¥å¿—æ¨¡å¼å˜åŒ–
            3. ç¡®è®¤æ˜¯å¦ä¸ºæ­£å¸¸ä¸šåŠ¡æ³¢åŠ¨
          log_query: '{job="{{ $labels.job }}"} | line_format "{{.timestamp}} {{.level}} {{.message}}"'
          grafana_url: "http://localhost:3000/d/logs-explorer?expr={job=%22{{ $labels.job }}%22}%20%7C%20line_format%20%22{{.timestamp}}%20{{.level}}%20{{.message}}%22"
          runbook_url: "https://your-wiki.com/runbooks/unusual-log-pattern"

# ===================================================================
# å‘Šè­¦ + æ™ºèƒ½é™å™ªå‘Šè­¦è§„åˆ™
# ç”¨é€”: åŸºäºç»Ÿè®¡å­¦çš„å‘Šè­¦é™å™ªå’Œèšç±»
# ===================================================================

  - name: intelligent-alert-deduplication
    interval: 30s
    rules:

      # å‘Šè­¦èšç±» - ç›¸ä¼¼å‘Šè­¦åˆå¹¶
      - alert: AlertClusterDetected
        expr: |
          count(ALERTS{alertname=~".*Down|.*Error|.*Failure"}) by (cluster, alertname) > 5
        for: 5m
        labels:
          severity: warning
          priority: P1
          category: alerting
          component: deduplication
          subcategory: clustering
        annotations:
          summary: "âš ï¸ æ£€æµ‹åˆ°å‘Šè­¦èšç±» - {{ $labels.alertname }} åœ¨ {{ $labels.cluster }} é›†ç¾¤ä¸­è§¦å‘ {{ $value }} æ¬¡"
          description: |
            **é›†ç¾¤**: {{ $labels.cluster }}
            **å‘Šè­¦åç§°**: {{ $labels.alertname }}
            **è§¦å‘æ¬¡æ•°**: {{ $value }}

            **èšç±»ä¿¡æ¯**:
            - å¯èƒ½æ˜¯ç³»ç»Ÿæ€§é—®é¢˜
            - å»ºè®®ä¼˜å…ˆå¤„ç†æ ¹å› 
            - å·²è‡ªåŠ¨æŠ‘åˆ¶ç›¸ä¼¼å‘Šè­¦

            **å¤„ç†æ­¥éª¤**:
            1. æŸ¥çœ‹å‘Šè­¦èšç±»è¯¦æƒ…
            2. è¯†åˆ«å…±åŒæ ¹å› 
            3. ä¸€æ¬¡æ€§è§£å†³æ‰€æœ‰é—®é¢˜
          alert_cluster: true
          cluster_size: "{{ $value }}"
          runbook_url: "https://your-wiki.com/runbooks/alert-clustering"

      # å‘Šè­¦é£æš´æ£€æµ‹
      - alert: AlertStormDetected
        expr: |
          rate(ALERTS{}[5m]) > 100
        for: 2m
        labels:
          severity: critical
          priority: P0
          category: alerting
          component: deduplication
          subcategory: storm
        annotations:
          summary: "ğŸ”´ æ£€æµ‹åˆ°å‘Šè­¦é£æš´ - æ¯åˆ†é’Ÿ {{ $value }} æ¡å‘Šè­¦"
          description: |
            **å‘Šè­¦é€Ÿç‡**: {{ $value }} alerts/min
            **æŒç»­æ—¶é—´**: 2 åˆ†é’Ÿ

            **é£æš´ä¿¡æ¯**:
            - å¯èƒ½æ˜¯ç³»ç»Ÿæ€§æ•…éšœ
            - å·²å¯ç”¨å‘Šè­¦æŠ‘åˆ¶
            - åªå‘é€å…³é”®å‘Šè­¦

            **å¤„ç†æ­¥éª¤**:
            1. ç«‹å³æ£€æŸ¥ç›‘æ§ç³»ç»ŸçŠ¶æ€
            2. è¯†åˆ«é£æš´æºå¤´
            3. ä¸´æ—¶é™ä½å‘Šè­¦é¢‘ç‡
          alert_storm: true
          storm_rate: "{{ $value }}"
          auto_suppression: true
          runbook_url: "https://your-wiki.com/runbooks/alert-storm"

      # å‘Šè­¦é‡å¤æ£€æµ‹
      - alert: AlertDuplicateDetected
        expr: |
          count(ALERTS{alertname=~".*", severity="critical"}) by (alertname, instance) > 1
        for: 10m
        labels:
          severity: warning
          priority: P2
          category: alerting
          component: deduplication
          subcategory: duplicate
        annotations:
          summary: "âš ï¸ æ£€æµ‹åˆ°é‡å¤å‘Šè­¦ - {{ $labels.alertname }} åœ¨ {{ $labels.instance }} é‡å¤è§¦å‘"
          description: |
            **å‘Šè­¦åç§°**: {{ $labels.alertname }}
            **å®ä¾‹**: {{ $labels.instance }}
            **é‡å¤æ¬¡æ•°**: {{ $value }}

            **é‡å¤ä¿¡æ¯**:
            - å‘Šè­¦æœªæ¢å¤
            - å·²è‡ªåŠ¨å»é‡
            - åªå‘é€ä¸€æ¬¡é€šçŸ¥

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥å‘Šè­¦æ˜¯å¦å·²å¤„ç†
            2. ç¡®è®¤é—®é¢˜æ˜¯å¦å·²è§£å†³
            3. æ‰‹åŠ¨è§£å†³å‘Šè­¦
          alert_duplicate: true
          duplicate_count: "{{ $value }}"
          auto_dedup: true
          runbook_url: "https://your-wiki.com/runbooks/alert-duplicate"

      # å‘Šè­¦é¢‘ç‡å¼‚å¸¸æ£€æµ‹
      - alert: AlertFrequencyAnomaly
        expr: |
          abs(rate(ALERTS{}[5m]) - avg_over_time(rate(ALERTS{}[1h])[5m:5m]))
          / stddev_over_time(rate(ALERTS{}[1h])[5m:5m]) > 3
        for: 10m
        labels:
          severity: warning
          priority: P2
          category: alerting
          component: deduplication
          subcategory: anomaly
        annotations:
          summary: "âš ï¸ æ£€æµ‹åˆ°å‘Šè­¦é¢‘ç‡å¼‚å¸¸ - å½“å‰é€Ÿç‡ {{ $value }} å€æ ‡å‡†å·®"
          description: |
            **å½“å‰å‘Šè­¦é€Ÿç‡**: {{ $value }}
            **åŸºå‡†é€Ÿç‡**: {{ $value }}
            **æ ‡å‡†å·®**: {{ $value }}

            **å¼‚å¸¸ä¿¡æ¯**:
            - å‘Šè­¦é¢‘ç‡å¼‚å¸¸æ³¢åŠ¨
            - å¯èƒ½æ˜¯ç³»ç»Ÿæ€§é—®é¢˜
            - å»ºè®®æ·±å…¥åˆ†æ

            **å¤„ç†æ­¥éª¤**:
            1. åˆ†æå‘Šè­¦é¢‘ç‡å˜åŒ–
            2. è¯†åˆ«å¼‚å¸¸å‘Šè­¦
            3. ä¼˜åŒ–å‘Šè­¦è§„åˆ™
          alert_anomaly: true
          anomaly_score: "{{ $value }}"
          runbook_url: "https://your-wiki.com/runbooks/alert-frequency-anomaly"

      # å‘Šè­¦ä¼˜å…ˆçº§è‡ªåŠ¨è°ƒæ•´
      - alert: AlertPriorityAutoAdjusted
        expr: |
          count(ALERTS{severity="warning", alertname=~".*Warning.*"}) by (instance) > 10
        for: 15m
        labels:
          severity: warning
          priority: P2
          category: alerting
          component: deduplication
          subcategory: priority
        annotations:
          summary: "âš ï¸ å®ä¾‹ {{ $labels.instance }} å‘Šè­¦è¿‡å¤šï¼Œè‡ªåŠ¨è°ƒæ•´å‘Šè­¦ä¼˜å…ˆçº§"
          description: |
            **å®ä¾‹**: {{ $labels.instance }}
            **å‘Šè­¦æ•°é‡**: {{ $value }}
            **è°ƒæ•´ç­–ç•¥**: é™ä½ä½ä¼˜å…ˆçº§å‘Šè­¦é¢‘ç‡

            **è°ƒæ•´ä¿¡æ¯**:
            - Warning çº§åˆ«å‘Šè­¦è¿‡å¤š
            - è‡ªåŠ¨é™ä½é€šçŸ¥é¢‘ç‡
            - åªå‘é€ Critical çº§åˆ«å‘Šè­¦

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥å®ä¾‹çŠ¶æ€
            2. ä¼˜åŒ–å‘Šè­¦è§„åˆ™
            3. è§£å†³æ ¹å› é—®é¢˜
          priority_adjusted: true
          adjustment_strategy: reduce_notification_frequency
          runbook_url: "https://your-wiki.com/runbooks/alert-priority-adjustment"

      # å‘Šè­¦æŠ‘åˆ¶è§„åˆ™è§¦å‘
      - alert: AlertSuppressionTriggered
        expr: |
          count(ALERTS{suppressed="true"}) > 0
        for: 1m
        labels:
          severity: info
          priority: P3
          category: alerting
          component: deduplication
          subcategory: suppression
        annotations:
          summary: "â„¹ï¸ å‘Šè­¦æŠ‘åˆ¶è§„åˆ™å·²è§¦å‘ - {{ $value }} æ¡å‘Šè­¦è¢«æŠ‘åˆ¶"
          description: |
            **æŠ‘åˆ¶å‘Šè­¦æ•°é‡**: {{ $value }}
            **æŠ‘åˆ¶è§„åˆ™**: è‡ªåŠ¨æŠ‘åˆ¶

            **æŠ‘åˆ¶ä¿¡æ¯**:
            - æ ¹å› å‘Šè­¦å·²è§¦å‘
            - ç›¸å…³å‘Šè­¦è¢«æŠ‘åˆ¶
            - å‡å°‘å‘Šè­¦å™ªéŸ³

            **å¤„ç†æ­¥éª¤**:
            1. æŸ¥çœ‹æ ¹å› å‘Šè­¦
            2. è§£å†³æ ¹å› é—®é¢˜
            3. è¢«æŠ‘åˆ¶å‘Šè­¦è‡ªåŠ¨æ¢å¤
          alert_suppressed: true
          suppressed_count: "{{ $value }}"
          runbook_url: "https://your-wiki.com/runbooks/alert-suppression"

      # å‘Šè­¦æ¢å¤è‡ªåŠ¨ç¡®è®¤
      - alert: AlertAutoResolved
        expr: |
          count(ALERTS{alertstate="firing"}) < count(ALERTS{alertstate="firing"} offset 5m)
        for: 1m
        labels:
          severity: info
          priority: P3
          category: alerting
          component: deduplication
          subcategory: resolution
        annotations:
          summary: "â„¹ï¸ å‘Šè­¦è‡ªåŠ¨æ¢å¤ - {{ $value }} æ¡å‘Šè­¦å·²è§£å†³"
          description: |
            **æ¢å¤å‘Šè­¦æ•°é‡**: {{ $value }}
            **æ¢å¤æ—¶é—´**: {{ $value }}

            **æ¢å¤ä¿¡æ¯**:
            - å‘Šè­¦å·²è‡ªåŠ¨æ¢å¤
            - å‘é€æ¢å¤é€šçŸ¥
            - æ›´æ–°å‘Šè­¦çŠ¶æ€

            **å¤„ç†æ­¥éª¤**:
            1. ç¡®è®¤é—®é¢˜å·²è§£å†³
            2. éªŒè¯ç³»ç»Ÿæ­£å¸¸è¿è¡Œ
            3. è®°å½•é—®é¢˜å¤„ç†è¿‡ç¨‹
          alert_resolved: true
          resolved_count: "{{ $value }}"
          auto_confirmation: true
          runbook_url: "https://your-wiki.com/runbooks/auto-resolution"

# ===================================================================
# æ ¹å› åˆ†æå‘Šè­¦è§„åˆ™
# ç”¨é€”: ä¸“é—¨æ ‡æ³¨å“ªäº›å‘Šè­¦æ˜¯æ ¹å› ï¼Œå¸®åŠ©å¿«é€Ÿå®šä½é—®é¢˜
# ===================================================================

  - name: root-cause-analysis-alerts
    interval: 30s
    rules:

      # æ ¹å› åˆ†æï¼šæ ¸å¿ƒäº¤æ¢æœºæ•…éšœ
      - alert: RootCauseCoreSwitchDown
        expr: |
          up{job="snmp-exporter", device_tier="core"} == 0
        for: 2m
        labels:
          severity: critical
          priority: P0
          category: root-cause
          component: switch
          root_cause: true
        annotations:
          summary: "ğŸ”´ã€æ ¹å› ã€‘æ ¸å¿ƒäº¤æ¢æœº {{ $labels.instance }} æ•…éšœ"
          description: |
            **æ ¸å¿ƒäº¤æ¢æœº**: {{ $labels.instance }}
            **å‚å•†**: {{ $labels.vendor }}
            **å‹å·**: {{ $labels.model }}

            **æ ¹å› åˆ†æ**:
            - è¿™æ˜¯æ ¹å› å‘Šè­¦
            - å½±å“èŒƒå›´ï¼š{{ $labels.affected_devices }} å°è®¾å¤‡
            - å½±å“ç”¨æˆ·ï¼š{{ $labels.affected_users }} äºº

            **å½±å“é“¾è·¯**:
            {{ $labels.topology_chain }}

            **å¤„ç†æ­¥éª¤**:
            1. ç«‹å³æ£€æŸ¥æ ¸å¿ƒäº¤æ¢æœºçŠ¶æ€
            2. æŸ¥çœ‹æ‹“æ‰‘å›¾ç¡®è®¤å½±å“èŒƒå›´
            3. è”ç³»ç½‘ç»œå›¢é˜Ÿç´§æ€¥å¤„ç†

            **è¢«æŠ‘åˆ¶çš„å‘Šè­¦**:
            - æ¥å…¥äº¤æ¢æœºå‘Šè­¦ï¼ˆ{{ $labels.suppressed_switches }} æ¡ï¼‰
            - æœåŠ¡å™¨å‘Šè­¦ï¼ˆ{{ $labels.suppressed_servers }} æ¡ï¼‰
            - ç½‘ç»œå»¶è¿Ÿå‘Šè­¦ï¼ˆ{{ $labels.suppressed_network }} æ¡ï¼‰
          root_cause: true
          affected_devices: "{{ $labels.affected_devices }}"
          topology_chain: "{{ $labels.topology_chain }}"
          suppressed_switches: "{{ $labels.suppressed_switches }}"
          suppressed_servers: "{{ $labels.suppressed_servers }}"
          suppressed_network: "{{ $labels.suppressed_network }}"
          runbook_url: "https://your-wiki.com/runbooks/root-cause-core-switch-down"

      # æ ¹å› åˆ†æï¼šæœåŠ¡å™¨ç¡¬ä»¶æ•…éšœ
      - alert: RootCauseHardwareFailure
        expr: |
          redfish_system_health_status != 1
        for: 2m
        labels:
          severity: critical
          priority: P0
          category: root-cause
          component: hardware
          root_cause: true
        annotations:
          summary: "ğŸ”´ã€æ ¹å› ã€‘æœåŠ¡å™¨ {{ $labels.instance }} ç¡¬ä»¶æ•…éšœ"
          description: |
            **æœåŠ¡å™¨**: {{ $labels.instance }}
            **å‚å•†**: {{ $labels.vendor }}
            **å‹å·**: {{ $labels.model }}
            **åºåˆ—å·**: {{ $labels.serial_number }}

            **æ ¹å› åˆ†æ**:
            - è¿™æ˜¯æ ¹å› å‘Šè­¦
            - æ•…éšœç»„ä»¶ï¼š{{ $labels.failed_component }}
            - å½±å“ï¼š{{ $labels.impact }}

            **å½±å“é“¾è·¯**:
            {{ $labels.impact_chain }}

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥ç¡¬ä»¶çŠ¶æ€
            2. è¿ç§»è™šæ‹Ÿæœºï¼ˆå¦‚éœ€è¦ï¼‰
            3. æ›´æ¢æ•…éšœç¡¬ä»¶

            **è¢«æŠ‘åˆ¶çš„å‘Šè­¦**:
            - CPU æ¸©åº¦å‘Šè­¦ï¼ˆ{{ $labels.suppressed_cpu }} æ¡ï¼‰
            - æ€§èƒ½å‘Šè­¦ï¼ˆ{{ $labels.suppressed_performance }} æ¡ï¼‰
          root_cause: true
          failed_component: "{{ $labels.failed_component }}"
          impact: "{{ $labels.impact }}"
          impact_chain: "{{ $labels.impact_chain }}"
          suppressed_cpu: "{{ $labels.suppressed_cpu }}"
          suppressed_performance: "{{ $labels.suppressed_performance }}"
          runbook_url: "https://your-wiki.com/runbooks/root-cause-hardware-failure"

      # æ ¹å› åˆ†æï¼šVictoriaMetrics å®•æœº
      - alert: RootCauseVictoriaMetricsDown
        expr: |
          up{job="victoriametrics"} == 0
        for: 2m
        labels:
          severity: critical
          priority: P0
          category: root-cause
          component: monitoring
          root_cause: true
        annotations:
          summary: "ğŸ”´ã€æ ¹å› ã€‘VictoriaMetrics æ—¶åºæ•°æ®åº“å®•æœº"
          description: |
            **æ ¹å› åˆ†æ**:
            - è¿™æ˜¯æ ¹å› å‘Šè­¦
            - å½±å“ï¼šæ‰€æœ‰ç›‘æ§æ•°æ®æ— æ³•å­˜å‚¨å’ŒæŸ¥è¯¢
            - å½±å“èŒƒå›´ï¼šæ•´ä¸ªç›‘æ§ç³»ç»Ÿ

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥æ•°æ®åº“è¿›ç¨‹çŠ¶æ€
            2. æ£€æŸ¥ç£ç›˜ç©ºé—´
            3. é‡å¯æœåŠ¡

            **è¢«æŠ‘åˆ¶çš„å‘Šè­¦**:
            - æ‰€æœ‰å‘Šè­¦ï¼ˆ{{ $labels.suppressed_alerts }} æ¡ï¼‰
          root_cause: true
          scope: "entire-monitoring-system"
          suppressed_alerts: "{{ $labels.suppressed_alerts }}"
          runbook_url: "https://your-wiki.com/runbooks/root-cause-victoriametrics-down"

      # æ ¹å› åˆ†æï¼švmagent å®•æœº
      - alert: RootCauseVMAgentDown
        expr: |
          up{job="vmagent"} == 0
        for: 2m
        labels:
          severity: critical
          priority: P0
          category: root-cause
          component: monitoring
          root_cause: true
        annotations:
          summary: "ğŸ”´ã€æ ¹å› ã€‘vmagent é‡‡é›†æœåŠ¡å®•æœº"
          description: |
            **æ ¹å› åˆ†æ**:
            - è¿™æ˜¯æ ¹å› å‘Šè­¦
            - å½±å“ï¼šæ‰€æœ‰ç›‘æ§æ•°æ®æ— æ³•é‡‡é›†
            - å½±å“èŒƒå›´ï¼šæ‰€æœ‰é‡‡é›†ç›®æ ‡

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥ vmagent è¿›ç¨‹çŠ¶æ€
            2. æ£€æŸ¥é…ç½®æ–‡ä»¶
            3. é‡å¯æœåŠ¡

            **è¢«æŠ‘åˆ¶çš„å‘Šè­¦**:
            - é‡‡é›†ç›®æ ‡å®•æœºå‘Šè­¦ï¼ˆ{{ $labels.suppressed_targets }} æ¡ï¼‰
          root_cause: true
          scope: "all-collection-targets"
          suppressed_targets: "{{ $labels.suppressed_targets }}"
          runbook_url: "https://your-wiki.com/runbooks/root-cause-vmagent-down"

      # æ ¹å› åˆ†æï¼šæ•°æ®ä¸­å¿ƒåœç”µ
      - alert: RootCauseDatacenterPowerLoss
        expr: |
          count(up{job="snmp-exporter", datacenter=~".*"} == 0) by (datacenter)
          / count(up{job="snmp-exporter", datacenter=~".*"}) by (datacenter) > 0.8
        for: 5m
        labels:
          severity: critical
          priority: P0
          category: root-cause
          component: infrastructure
          root_cause: true
        annotations:
          summary: "ğŸ”´ã€æ ¹å› ã€‘æ•°æ®ä¸­å¿ƒ {{ $labels.datacenter }} åœç”µ"
          description: |
            **æ•°æ®ä¸­å¿ƒ**: {{ $labels.datacenter }}

            **æ ¹å› åˆ†æ**:
            - è¿™æ˜¯æ ¹å› å‘Šè­¦
            - å½±å“ï¼š{{ $value | humanizePercentage }} è®¾å¤‡ç¦»çº¿
            - å½±å“èŒƒå›´ï¼šæ•´ä¸ªæ•°æ®ä¸­å¿ƒ

            **å¤„ç†æ­¥éª¤**:
            1. ç¡®è®¤åœç”µåŸå› 
            2. å¯åŠ¨å¤‡ç”¨ç”µæº
            3. é€šçŸ¥æ•°æ®ä¸­å¿ƒå›¢é˜Ÿ

            **è¢«æŠ‘åˆ¶çš„å‘Šè­¦**:
            - æ‰€æœ‰è®¾å¤‡å‘Šè­¦ï¼ˆ{{ $labels.suppressed_alerts }} æ¡ï¼‰
          root_cause: true
          scope: "entire-datacenter"
          affected_devices: "{{ $labels.affected_devices }}"
          suppressed_alerts: "{{ $labels.suppressed_alerts }}"
          runbook_url: "https://your-wiki.com/runbooks/root-cause-datacenter-power-loss"

      # æ ¹å› åˆ†æï¼šç½‘ç»œåˆ†åŒº
      - alert: RootCauseNetworkPartition
        expr: |
          count(up{job="snmp-exporter"} == 0) by (network_segment) > 0
          and count(up{job="snmp-exporter"} == 0) by (network_segment)
          / count(up{job="snmp-exporter"}) by (network_segment) > 0.5
        for: 5m
        labels:
          severity: critical
          priority: P0
          category: root-cause
          component: network
          root_cause: true
        annotations:
          summary: "ğŸ”´ã€æ ¹å› ã€‘ç½‘ç»œåˆ†åŒº {{ $labels.network_segment }} æ£€æµ‹åˆ°ç½‘ç»œåˆ†åŒº"
          description: |
            **ç½‘ç»œåˆ†åŒº**: {{ $labels.network_segment }}

            **æ ¹å› åˆ†æ**:
            - è¿™æ˜¯æ ¹å› å‘Šè­¦
            - å½±å“ï¼š{{ $value | humanizePercentage }} è®¾å¤‡æ— æ³•è®¿é—®
            - å¯èƒ½åŸå› ï¼šæ ¸å¿ƒäº¤æ¢æœºæ•…éšœã€å…‰çº¤ä¸­æ–­

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥æ ¸å¿ƒäº¤æ¢æœºçŠ¶æ€
            2. æ£€æŸ¥å…‰çº¤è¿æ¥
            3. è”ç³»ç½‘ç»œå›¢é˜Ÿ

            **è¢«æŠ‘åˆ¶çš„å‘Šè­¦**:
            - è®¾å¤‡å®•æœºå‘Šè­¦ï¼ˆ{{ $labels.suppressed_devices }} æ¡ï¼‰
            - ç½‘ç»œå»¶è¿Ÿå‘Šè­¦ï¼ˆ{{ $labels.suppressed_network }} æ¡ï¼‰
          root_cause: true
          possible_causes: "æ ¸å¿ƒäº¤æ¢æœºæ•…éšœã€å…‰çº¤ä¸­æ–­ã€è·¯ç”±é…ç½®é”™è¯¯"
          suppressed_devices: "{{ $labels.suppressed_devices }}"
          suppressed_network: "{{ $labels.suppressed_network }}"
          runbook_url: "https://your-wiki.com/runbooks/root-cause-network-partition"

      # æ ¹å› åˆ†æï¼šå­˜å‚¨è·¯å¾„æ•…éšœ
      - alert: RootCauseStoragePathDown
        expr: |
          vsphere_storage_path_state != 2
        for: 2m
        labels:
          severity: critical
          priority: P0
          category: root-cause
          component: storage
          root_cause: true
        annotations:
          summary: "ğŸ”´ã€æ ¹å› ã€‘å­˜å‚¨è·¯å¾„ {{ $labels.storage_path }} æ•…éšœ"
          description: |
            **å­˜å‚¨è·¯å¾„**: {{ $labels.storage_path }}
            **ESXi ä¸»æœº**: {{ $labels.esxhostname }}

            **æ ¹å› åˆ†æ**:
            - è¿™æ˜¯æ ¹å› å‘Šè­¦
            - å½±å“ï¼š{{ $labels.affected_vms }} å°è™šæ‹Ÿæœºç£ç›˜ IO å¼‚å¸¸
            - å¯èƒ½åŸå› ï¼šå­˜å‚¨é˜µåˆ—æ•…éšœã€å…‰çº¤ä¸­æ–­

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥å­˜å‚¨é˜µåˆ—çŠ¶æ€
            2. æ£€æŸ¥å…‰çº¤è¿æ¥
            3. è¿ç§»è™šæ‹Ÿæœºåˆ°å…¶ä»–å­˜å‚¨

            **è¢«æŠ‘åˆ¶çš„å‘Šè­¦**:
            - VM ç£ç›˜ IO å‘Šè­¦ï¼ˆ{{ $labels.suppressed_vms }} æ¡ï¼‰
            - VM ç£ç›˜å»¶è¿Ÿå‘Šè­¦ï¼ˆ{{ $labels.suppressed_latency }} æ¡ï¼‰
          root_cause: true
          affected_vms: "{{ $labels.affected_vms }}"
          possible_causes: "å­˜å‚¨é˜µåˆ—æ•…éšœã€å…‰çº¤ä¸­æ–­ã€é…ç½®é”™è¯¯"
          suppressed_vms: "{{ $labels.suppressed_vms }}"
          suppressed_latency: "{{ $labels.suppressed_latency }}"
          runbook_url: "https://your-wiki.com/runbooks/root-cause-storage-path-down"

      # æ ¹å› åˆ†æï¼šæ•°æ®åº“ä¸»åº“æ•…éšœ
      - alert: RootCauseDatabaseMasterDown
        expr: |
          up{job="mysql", role="master"} == 0
          and on(service_group) (
            up{job="mysql", role="slave"} == 1
          )
        for: 2m
        labels:
          severity: critical
          priority: P0
          category: root-cause
          component: database
          root_cause: true
        annotations:
          summary: "ğŸ”´ã€æ ¹å› ã€‘æ•°æ®åº“ä¸»åº“ {{ $labels.instance }} æ•…éšœ"
          description: |
            **æ•°æ®åº“**: {{ $labels.instance }}
            **æœåŠ¡ç»„**: {{ $labels.service_group }}

            **æ ¹å› åˆ†æ**:
            - è¿™æ˜¯æ ¹å› å‘Šè­¦
            - å½±å“ï¼šæ‰€æœ‰ä¾èµ–è¯¥æ•°æ®åº“çš„åº”ç”¨
            - è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼šå·²è§¦å‘

            **å¤„ç†æ­¥éª¤**:
            1. ç¡®è®¤ä»åº“å·²æå‡ä¸ºä¸»åº“
            2. æ£€æŸ¥ä¸»åº“æ•…éšœåŸå› 
            3. ä¿®å¤ä¸»åº“åé‡æ–°é…ç½®ä¸»ä»å¤åˆ¶

            **è¢«æŠ‘åˆ¶çš„å‘Šè­¦**:
            - åº”ç”¨æœåŠ¡å‘Šè­¦ï¼ˆ{{ $labels.suppressed_apps }} æ¡ï¼‰
          root_cause: true
          service_group: "{{ $labels.service_group }}"
          auto_failover: true
          new_master: "{{ $labels.new_master }}"
          suppressed_apps: "{{ $labels.suppressed_apps }}"
          runbook_url: "https://your-wiki.com/runbooks/root-cause-database-master-down"

      # æ ¹å› åˆ†æï¼šDNS æœåŠ¡å™¨æ•…éšœ
      - alert: RootCauseDNSDown
        expr: |
          probe_dns_lookup_success == 0
          and on(dns_group) (
            count(probe_dns_lookup_success) by (dns_group) > 1
          )
        for: 5m
        labels:
          severity: critical
          priority: P0
          category: root-cause
          component: dns
          root_cause: true
        annotations:
          summary: "ğŸ”´ã€æ ¹å› ã€‘DNS æœåŠ¡å™¨ {{ $labels.instance }} æ•…éšœ"
          description: |
            **DNS æœåŠ¡å™¨**: {{ $labels.instance }}
            **DNS ç»„**: {{ $labels.dns_group }}

            **æ ¹å› åˆ†æ**:
            - è¿™æ˜¯æ ¹å› å‘Šè­¦
            - å½±å“ï¼šæ‰€æœ‰ä¾èµ–è¯¥ DNS çš„æœåŠ¡
            - è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼šå·²è§¦å‘

            **å¤„ç†æ­¥éª¤**:
            1. ç¡®è®¤ DNS åˆ‡æ¢å·²æ‰§è¡Œ
            2. æ£€æŸ¥ä¸» DNS æœåŠ¡å™¨çŠ¶æ€
            3. ä¿®å¤ä¸» DNS åæ‰‹åŠ¨åˆ‡æ¢å›ä¸» DNS

            **è¢«æŠ‘åˆ¶çš„å‘Šè­¦**:
            - ç½‘ç«™ä¸å¯è¾¾å‘Šè­¦ï¼ˆ{{ $labels.suppressed_websites }} æ¡ï¼‰
            - æœåŠ¡è¿æ¥å¤±è´¥å‘Šè­¦ï¼ˆ{{ $labels.suppressed_services }} æ¡ï¼‰
          root_cause: true
          dns_group: "{{ $labels.dns_group }}"
          auto_failover: true
          backup_dns: "{{ $labels.backup_dns }}"
          suppressed_websites: "{{ $labels.suppressed_websites }}"
          suppressed_services: "{{ $labels.suppressed_services }}"
          runbook_url: "https://your-wiki.com/runbooks/root-cause-dns-down"

      # æ ¹å› åˆ†æï¼šäº¤æ¢æœºç«¯å£é£æš´
      - alert: RootCauseSwitchPortStorm
        expr: |
          rate(ifHCInOctets[5m]) * 8 / ifHighSpeed > 0.9
          and rate(ifHCOutOctets[5m]) * 8 / ifHighSpeed > 0.9
        for: 5m
        labels:
          severity: critical
          priority: P0
          category: root-cause
          component: switch
          root_cause: true
        annotations:
          summary: "ğŸ”´ã€æ ¹å› ã€‘äº¤æ¢æœº {{ $labels.instance }} ç«¯å£ {{ $labels.ifDescr }} æ£€æµ‹åˆ°æµé‡é£æš´"
          description: |
            **äº¤æ¢æœº**: {{ $labels.instance }}
            **ç«¯å£**: {{ $labels.ifDescr }}

            **æ ¹å› åˆ†æ**:
            - è¿™æ˜¯æ ¹å› å‘Šè­¦
            - å½±å“ï¼š{{ $labels.affected_devices }} å°è®¾å¤‡ç½‘ç»œå¼‚å¸¸
            - å¯èƒ½åŸå› ï¼šç¯è·¯ã€å¹¿æ’­é£æš´ã€DDoS æ”»å‡»

            **å¤„ç†æ­¥éª¤**:
            1. æŸ¥çœ‹æ‹“æ‰‘å›¾ç¡®è®¤ç¯è·¯
            2. å…³é—­é£æš´ç«¯å£
            3. æ£€æŸ¥ç½‘ç»œé…ç½®

            **è¢«æŠ‘åˆ¶çš„å‘Šè­¦**:
            - ç½‘ç»œå»¶è¿Ÿå‘Šè­¦ï¼ˆ{{ $labels.suppressed_latency }} æ¡ï¼‰
            - ä¸¢åŒ…ç‡å‘Šè­¦ï¼ˆ{{ $labels.suppressed_packetloss }} æ¡ï¼‰
            - CPU è¿‡é«˜å‘Šè­¦ï¼ˆ{{ $labels.suppressed_cpu }} æ¡ï¼‰
          root_cause: true
          affected_devices: "{{ $labels.affected_devices }}"
          possible_causes: "ç¯è·¯ã€å¹¿æ’­é£æš´ã€DDoS æ”»å‡»"
          suppressed_latency: "{{ $labels.suppressed_latency }}"
          suppressed_packetloss: "{{ $labels.suppressed_packetloss }}"
          suppressed_cpu: "{{ $labels.suppressed_cpu }}"
          runbook_url: "https://your-wiki.com/runbooks/root-cause-switch-port-storm"

groups:
  - name: monitoring-system-alerts
    interval: 30s
    rules:

      # ===== æ ¸å¿ƒç»„ä»¶å®•æœºå‘Šè­¦ =====

      # VictoriaMetrics æœåŠ¡å®•æœº
      - alert: VictoriaMetricsDown
        expr: up{job="victoriametrics"} == 0
        for: 2m
        labels:
          severity: critical
          priority: P0
          category: monitoring
          component: database
        annotations:
          summary: "ğŸ”´ VictoriaMetrics æ—¶åºæ•°æ®åº“å®•æœº"
          description: |
            **å½±å“**: ç›‘æ§ç³»ç»Ÿæ— æ³•å­˜å‚¨æŒ‡æ ‡æ•°æ®ï¼Œæ‰€æœ‰ç›‘æ§å°†ä¸­æ–­

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥å®¹å™¨çŠ¶æ€: `docker ps | grep victoriametrics`
            2. æŸ¥çœ‹æ—¥å¿—: `docker logs victoriametrics`
            3. æ£€æŸ¥ç£ç›˜ç©ºé—´
            4. é‡å¯æœåŠ¡: `docker-compose restart victoriametrics`
          runbook_url: "https://your-wiki.com/runbooks/victoriametrics-down"

      # vmagent æœåŠ¡å®•æœº
      - alert: VMAgentDown
        expr: up{job="vmagent"} == 0
        for: 2m
        labels:
          severity: critical
          priority: P0
          category: monitoring
          component: collector
        annotations:
          summary: "ğŸ”´ vmagent é‡‡é›†æœåŠ¡å®•æœº"
          description: |
            **å½±å“**: ç›‘æ§æ•°æ®æ— æ³•é‡‡é›†ï¼Œæ‰€æœ‰æŒ‡æ ‡å°†åœæ­¢æ›´æ–°

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥å®¹å™¨çŠ¶æ€: `docker ps | grep vmagent`
            2. æŸ¥çœ‹æ—¥å¿—: `docker logs vmagent`
            3. æ£€æŸ¥é…ç½®æ–‡ä»¶: `config/vmagent/prometheus.yml`
            4. é‡å¯æœåŠ¡: `docker-compose restart vmagent`
          runbook_url: "https://your-wiki.com/runbooks/vmagent-down"

      # vmalert æœåŠ¡å®•æœº
      - alert: VMAlertDown
        expr: up{job="vmalert"} == 0
        for: 2m
        labels:
          severity: critical
          priority: P0
          category: monitoring
          component: alerting
        annotations:
          summary: "ğŸ”´ vmalert å‘Šè­¦æœåŠ¡å®•æœº"
          description: |
            **å½±å“**: å‘Šè­¦è§„åˆ™æ— æ³•è¯„ä¼°ï¼Œæ— æ³•å‘é€æ–°çš„å‘Šè­¦é€šçŸ¥

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥å®¹å™¨çŠ¶æ€: `docker ps | grep vmalert`
            2. æŸ¥çœ‹æ—¥å¿—: `docker logs vmalert`
            3. æ£€æŸ¥å‘Šè­¦è§„åˆ™æ–‡ä»¶: `config/vmalert/alerts/*.yml`
            4. é‡å¯æœåŠ¡: `docker-compose restart vmalert`
          runbook_url: "https://your-wiki.com/runbooks/vmalert-down"

      # Alertmanager æœåŠ¡å®•æœº
      - alert: AlertmanagerDown
        expr: up{job="alertmanager"} == 0
        for: 2m
        labels:
          severity: critical
          priority: P0
          category: monitoring
          component: notification
        annotations:
          summary: "ğŸ”´ Alertmanager å‘Šè­¦ç®¡ç†æœåŠ¡å®•æœº"
          description: |
            **å½±å“**: å‘Šè­¦é€šçŸ¥æ— æ³•å‘é€ï¼Œè¿ç»´äººå‘˜æ”¶ä¸åˆ°å‘Šè­¦

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥å®¹å™¨çŠ¶æ€: `docker ps | grep alertmanager`
            2. æŸ¥çœ‹æ—¥å¿—: `docker logs alertmanager`
            3. æ£€æŸ¥é…ç½®: `config/alertmanager/alertmanager.yml`
            4. é‡å¯æœåŠ¡: `docker-compose restart alertmanager`
          runbook_url: "https://your-wiki.com/runbooks/alertmanager-down"

      # ===== é‡‡é›†ç›®æ ‡å®•æœºå‘Šè­¦ =====

      # é€šç”¨é‡‡é›†ç›®æ ‡å®•æœº
      - alert: TargetDown
        expr: up == 0
        for: 5m
        labels:
          severity: warning
          priority: P2
          category: monitoring
          component: target
        annotations:
          summary: "âš ï¸ ç›‘æ§ç›®æ ‡ {{ $labels.instance }} æ— æ³•è®¿é—®"
          description: |
            **ç›®æ ‡**: {{ $labels.instance }}
            **Job**: {{ $labels.job }}

            **å¯èƒ½åŸå› **:
            - Exporter æœåŠ¡å®•æœº
            - ç½‘ç»œä¸å¯è¾¾
            - é˜²ç«å¢™é˜»æ­¢

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥ç›®æ ‡æœåŠ¡çŠ¶æ€
            2. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
            3. æŸ¥çœ‹ vmagent æ—¥å¿—
          runbook_url: "https://your-wiki.com/runbooks/target-down"

      # ===== å­˜å‚¨å’Œæ€§èƒ½å‘Šè­¦ =====

      # VictoriaMetrics å­˜å‚¨ç©ºé—´ä¸è¶³ - Warning
      - alert: VMStorageLowSpaceWarning
        expr: (vm_free_disk_space_bytes / (vm_free_disk_space_bytes + vm_data_size_bytes)) * 100 < 20
        for: 5m
        labels:
          severity: warning
          priority: P2
          category: monitoring
          component: storage
        annotations:
          summary: "âš ï¸ VictoriaMetrics å­˜å‚¨ç©ºé—´ä¸è¶³"
          description: |
            **å‰©ä½™ç©ºé—´**: {{ $value | humanizePercentage }}

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥ç£ç›˜ä½¿ç”¨: `df -h`
            2. æ¸…ç†æ—§æ•°æ®æˆ–æ‰©å®¹ç£ç›˜
            3. è°ƒæ•´æ•°æ®ä¿ç•™æœŸ: `--retentionPeriod`
          runbook_url: "https://your-wiki.com/runbooks/vm-storage-low"

      # VictoriaMetrics å­˜å‚¨ç©ºé—´ä¸è¶³ - Critical
      - alert: VMStorageLowSpaceCritical
        expr: (vm_free_disk_space_bytes / (vm_free_disk_space_bytes + vm_data_size_bytes)) * 100 < 10
        for: 2m
        labels:
          severity: critical
          priority: P0
          category: monitoring
          component: storage
        annotations:
          summary: "ğŸ”´ VictoriaMetrics å­˜å‚¨ç©ºé—´ä¸¥é‡ä¸è¶³"
          description: |
            **ç´§æ€¥**: å‰©ä½™ç©ºé—´ä»… {{ $value | humanizePercentage }}
            **é£é™©**: å¯èƒ½å¯¼è‡´æ•°æ®å†™å…¥å¤±è´¥

            **ç«‹å³è¡ŒåŠ¨**:
            1. ç«‹å³æ‰©å®¹ç£ç›˜
            2. ç´§æ€¥æ¸…ç†æ—§æ•°æ®
            3. åœæ­¢ä½ä¼˜å…ˆçº§é‡‡é›†ä»»åŠ¡
          runbook_url: "https://your-wiki.com/runbooks/vm-storage-low"

      # vmagent é‡‡é›†ç¼“å†²åŒºæ»¡ï¼ˆä¸¢å¤±æ•°æ®ï¼‰
      - alert: VMAgentBufferFull
        expr: increase(vmagent_remotewrite_dropped_rows_total[5m]) > 0
        for: 2m
        labels:
          severity: warning
          priority: P2
          category: monitoring
          component: collector
        annotations:
          summary: "âš ï¸ vmagent ä¸¢å¼ƒé‡‡é›†æ•°æ®"
          description: |
            **ä¸¢å¼ƒæ•°æ®**: è¿‘ 5 åˆ†é’Ÿä¸¢å¼ƒ {{ $value }} æ¡è®°å½•

            **å¯èƒ½åŸå› **:
            - VictoriaMetrics å†™å…¥é€Ÿåº¦è·Ÿä¸ä¸Š
            - ç½‘ç»œå»¶è¿Ÿè¿‡é«˜
            - é‡‡é›†é¢‘ç‡è¿‡é«˜

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥ VictoriaMetrics æ€§èƒ½
            2. å¢åŠ  vmagent ç¼“å†²åŒº: `-remoteWrite.maxDiskUsagePerURL`
            3. é™ä½é‡‡é›†é¢‘ç‡
          runbook_url: "https://your-wiki.com/runbooks/vmagent-buffer-full"

      # vmalert è§„åˆ™è¯„ä¼°å¤±è´¥
      - alert: VMAlertRuleErrors
        expr: increase(vmalert_alerting_rules_error_total[5m]) > 0
        for: 2m
        labels:
          severity: warning
          priority: P2
          category: monitoring
          component: alerting
        annotations:
          summary: "âš ï¸ vmalert å‘Šè­¦è§„åˆ™è¯„ä¼°å¤±è´¥"
          description: |
            **å¤±è´¥æ¬¡æ•°**: è¿‘ 5 åˆ†é’Ÿæœ‰ {{ $value }} æ¬¡è¯„ä¼°å¤±è´¥

            **å¯èƒ½åŸå› **:
            - å‘Šè­¦è§„åˆ™è¯­æ³•é”™è¯¯
            - VictoriaMetrics æŸ¥è¯¢è¶…æ—¶
            - æŒ‡æ ‡æ•°æ®ä¸å­˜åœ¨

            **å¤„ç†æ­¥éª¤**:
            1. æŸ¥çœ‹ vmalert æ—¥å¿—: `docker logs vmalert`
            2. æ£€æŸ¥å‘Šè­¦è§„åˆ™æ–‡ä»¶è¯­æ³•
            3. æµ‹è¯• PromQL è¡¨è¾¾å¼
          runbook_url: "https://your-wiki.com/runbooks/vmalert-rule-errors"

      # Alertmanager é€šçŸ¥å‘é€å¤±è´¥
      - alert: AlertmanagerNotificationsFailed
        expr: increase(alertmanager_notifications_failed_total[5m]) > 0
        for: 2m
        labels:
          severity: warning
          priority: P2
          category: monitoring
          component: notification
        annotations:
          summary: "âš ï¸ Alertmanager å‘Šè­¦é€šçŸ¥å‘é€å¤±è´¥"
          description: |
            **å¤±è´¥æ¬¡æ•°**: è¿‘ 5 åˆ†é’Ÿæœ‰ {{ $value }} æ¬¡é€šçŸ¥å¤±è´¥

            **å¯èƒ½åŸå› **:
            - é‚®ä»¶æœåŠ¡å™¨ä¸å¯è¾¾
            - Webhook åœ°å€é”™è¯¯
            - è®¤è¯ä¿¡æ¯è¿‡æœŸ

            **å¤„ç†æ­¥éª¤**:
            1. æŸ¥çœ‹ Alertmanager æ—¥å¿—: `docker logs alertmanager`
            2. æ£€æŸ¥æ¥æ”¶å™¨é…ç½®
            3. æµ‹è¯•é€šçŸ¥æ¸ é“è¿é€šæ€§
          runbook_url: "https://your-wiki.com/runbooks/alertmanager-notifications-failed"

# ===================================================================
# å‘Šè­¦è§„åˆ™è¯´æ˜:
#
# 1. ç›‘æ§ç³»ç»Ÿå‘Šè­¦ä¼˜å…ˆçº§:
#    - æ‰€æœ‰æ ¸å¿ƒç»„ä»¶å®•æœº: P0ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
#    - å­˜å‚¨ç©ºé—´ä¸è¶³ Critical: P0
#    - å…¶ä»–æ€§èƒ½é—®é¢˜: P2
#
# 2. å‘Šè­¦æŠ‘åˆ¶:
#    - VictoriaMetrics å®•æœºæ—¶ï¼ŒæŠ‘åˆ¶æ‰€æœ‰å…¶ä»–ç›‘æ§å‘Šè­¦
#    - vmagent å®•æœºæ—¶ï¼ŒæŠ‘åˆ¶ TargetDown å‘Šè­¦
#
# 3. è‡ªæ„ˆèƒ½åŠ›:
#    - å»ºè®®é…ç½® Docker restart policy
#    - å»ºè®®é…ç½®ç£ç›˜ç©ºé—´ç›‘æ§å’Œè‡ªåŠ¨æ¸…ç†
#
# æ›´å¤šæ–‡æ¡£: docs/MONITORING-SYSTEM-GUIDE.md
# ===================================================================

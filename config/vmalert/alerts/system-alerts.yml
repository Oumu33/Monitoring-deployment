# ===================================================================
# ç›‘æ§ç³»ç»Ÿè‡ªèº«å¥åº·å‘Šè­¦
# ç”¨é€”: ç›‘æ§ VictoriaMetrics ç”Ÿæ€ç»„ä»¶çš„å¥åº·çŠ¶æ€
# ===================================================================

groups:
  - name: monitoring-system-alerts
    interval: 30s
    rules:

      # ===== æ ¸å¿ƒç»„ä»¶å®•æœºå‘Šè­¦ =====

      # VictoriaMetrics æœåŠ¡å®•æœº
      - alert: VictoriaMetricsDown
        expr: up{job="victoriametrics"} == 0
        for: 2m
        labels:
          severity: critical
          priority: P0
          category: monitoring
          component: database
        annotations:
          summary: "ğŸ”´ VictoriaMetrics æ—¶åºæ•°æ®åº“å®•æœº"
          description: |
            **å½±å“**: ç›‘æ§ç³»ç»Ÿæ— æ³•å­˜å‚¨æŒ‡æ ‡æ•°æ®ï¼Œæ‰€æœ‰ç›‘æ§å°†ä¸­æ–­

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥å®¹å™¨çŠ¶æ€: `docker ps | grep victoriametrics`
            2. æŸ¥çœ‹æ—¥å¿—: `docker logs victoriametrics`
            3. æ£€æŸ¥ç£ç›˜ç©ºé—´
            4. é‡å¯æœåŠ¡: `docker-compose restart victoriametrics`
          runbook_url: "https://your-wiki.com/runbooks/victoriametrics-down"

      # vmagent æœåŠ¡å®•æœº
      - alert: VMAgentDown
        expr: up{job="vmagent"} == 0
        for: 2m
        labels:
          severity: critical
          priority: P0
          category: monitoring
          component: collector
        annotations:
          summary: "ğŸ”´ vmagent é‡‡é›†æœåŠ¡å®•æœº"
          description: |
            **å½±å“**: ç›‘æ§æ•°æ®æ— æ³•é‡‡é›†ï¼Œæ‰€æœ‰æŒ‡æ ‡å°†åœæ­¢æ›´æ–°

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥å®¹å™¨çŠ¶æ€: `docker ps | grep vmagent`
            2. æŸ¥çœ‹æ—¥å¿—: `docker logs vmagent`
            3. æ£€æŸ¥é…ç½®æ–‡ä»¶: `config/vmagent/prometheus.yml`
            4. é‡å¯æœåŠ¡: `docker-compose restart vmagent`
          runbook_url: "https://your-wiki.com/runbooks/vmagent-down"

      # vmalert æœåŠ¡å®•æœº
      - alert: VMAlertDown
        expr: up{job="vmalert"} == 0
        for: 2m
        labels:
          severity: critical
          priority: P0
          category: monitoring
          component: alerting
        annotations:
          summary: "ğŸ”´ vmalert å‘Šè­¦æœåŠ¡å®•æœº"
          description: |
            **å½±å“**: å‘Šè­¦è§„åˆ™æ— æ³•è¯„ä¼°ï¼Œæ— æ³•å‘é€æ–°çš„å‘Šè­¦é€šçŸ¥

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥å®¹å™¨çŠ¶æ€: `docker ps | grep vmalert`
            2. æŸ¥çœ‹æ—¥å¿—: `docker logs vmalert`
            3. æ£€æŸ¥å‘Šè­¦è§„åˆ™æ–‡ä»¶: `config/vmalert/alerts/*.yml`
            4. é‡å¯æœåŠ¡: `docker-compose restart vmalert`
          runbook_url: "https://your-wiki.com/runbooks/vmalert-down"

      # Alertmanager æœåŠ¡å®•æœº
      - alert: AlertmanagerDown
        expr: up{job="alertmanager"} == 0
        for: 2m
        labels:
          severity: critical
          priority: P0
          category: monitoring
          component: notification
        annotations:
          summary: "ğŸ”´ Alertmanager å‘Šè­¦ç®¡ç†æœåŠ¡å®•æœº"
          description: |
            **å½±å“**: å‘Šè­¦é€šçŸ¥æ— æ³•å‘é€ï¼Œè¿ç»´äººå‘˜æ”¶ä¸åˆ°å‘Šè­¦

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥å®¹å™¨çŠ¶æ€: `docker ps | grep alertmanager`
            2. æŸ¥çœ‹æ—¥å¿—: `docker logs alertmanager`
            3. æ£€æŸ¥é…ç½®: `config/alertmanager/alertmanager.yml`
            4. é‡å¯æœåŠ¡: `docker-compose restart alertmanager`
          runbook_url: "https://your-wiki.com/runbooks/alertmanager-down"

      # ===== é‡‡é›†ç›®æ ‡å®•æœºå‘Šè­¦ =====

      # é€šç”¨é‡‡é›†ç›®æ ‡å®•æœº
      - alert: TargetDown
        expr: up == 0
        for: 5m
        labels:
          severity: warning
          priority: P2
          category: monitoring
          component: target
        annotations:
          summary: "âš ï¸ ç›‘æ§ç›®æ ‡ {{ $labels.instance }} æ— æ³•è®¿é—®"
          description: |
            **ç›®æ ‡**: {{ $labels.instance }}
            **Job**: {{ $labels.job }}

            **å¯èƒ½åŸå› **:
            - Exporter æœåŠ¡å®•æœº
            - ç½‘ç»œä¸å¯è¾¾
            - é˜²ç«å¢™é˜»æ­¢

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥ç›®æ ‡æœåŠ¡çŠ¶æ€
            2. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
            3. æŸ¥çœ‹ vmagent æ—¥å¿—
          runbook_url: "https://your-wiki.com/runbooks/target-down"

      # ===== å­˜å‚¨å’Œæ€§èƒ½å‘Šè­¦ =====

      # VictoriaMetrics å­˜å‚¨ç©ºé—´ä¸è¶³ - Warning
      - alert: VMStorageLowSpaceWarning
        expr: (vm_free_disk_space_bytes / (vm_free_disk_space_bytes + vm_data_size_bytes)) * 100 < 20
        for: 5m
        labels:
          severity: warning
          priority: P2
          category: monitoring
          component: storage
        annotations:
          summary: "âš ï¸ VictoriaMetrics å­˜å‚¨ç©ºé—´ä¸è¶³"
          description: |
            **å‰©ä½™ç©ºé—´**: {{ $value | humanizePercentage }}

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥ç£ç›˜ä½¿ç”¨: `df -h`
            2. æ¸…ç†æ—§æ•°æ®æˆ–æ‰©å®¹ç£ç›˜
            3. è°ƒæ•´æ•°æ®ä¿ç•™æœŸ: `--retentionPeriod`
          runbook_url: "https://your-wiki.com/runbooks/vm-storage-low"

      # VictoriaMetrics å­˜å‚¨ç©ºé—´ä¸è¶³ - Critical
      - alert: VMStorageLowSpaceCritical
        expr: (vm_free_disk_space_bytes / (vm_free_disk_space_bytes + vm_data_size_bytes)) * 100 < 10
        for: 2m
        labels:
          severity: critical
          priority: P0
          category: monitoring
          component: storage
        annotations:
          summary: "ğŸ”´ VictoriaMetrics å­˜å‚¨ç©ºé—´ä¸¥é‡ä¸è¶³"
          description: |
            **ç´§æ€¥**: å‰©ä½™ç©ºé—´ä»… {{ $value | humanizePercentage }}
            **é£é™©**: å¯èƒ½å¯¼è‡´æ•°æ®å†™å…¥å¤±è´¥

            **ç«‹å³è¡ŒåŠ¨**:
            1. ç«‹å³æ‰©å®¹ç£ç›˜
            2. ç´§æ€¥æ¸…ç†æ—§æ•°æ®
            3. åœæ­¢ä½ä¼˜å…ˆçº§é‡‡é›†ä»»åŠ¡
          runbook_url: "https://your-wiki.com/runbooks/vm-storage-low"

      # vmagent é‡‡é›†ç¼“å†²åŒºæ»¡ï¼ˆä¸¢å¤±æ•°æ®ï¼‰
      - alert: VMAgentBufferFull
        expr: increase(vmagent_remotewrite_dropped_rows_total[5m]) > 0
        for: 2m
        labels:
          severity: warning
          priority: P2
          category: monitoring
          component: collector
        annotations:
          summary: "âš ï¸ vmagent ä¸¢å¼ƒé‡‡é›†æ•°æ®"
          description: |
            **ä¸¢å¼ƒæ•°æ®**: è¿‘ 5 åˆ†é’Ÿä¸¢å¼ƒ {{ $value }} æ¡è®°å½•

            **å¯èƒ½åŸå› **:
            - VictoriaMetrics å†™å…¥é€Ÿåº¦è·Ÿä¸ä¸Š
            - ç½‘ç»œå»¶è¿Ÿè¿‡é«˜
            - é‡‡é›†é¢‘ç‡è¿‡é«˜

            **å¤„ç†æ­¥éª¤**:
            1. æ£€æŸ¥ VictoriaMetrics æ€§èƒ½
            2. å¢åŠ  vmagent ç¼“å†²åŒº: `-remoteWrite.maxDiskUsagePerURL`
            3. é™ä½é‡‡é›†é¢‘ç‡
          runbook_url: "https://your-wiki.com/runbooks/vmagent-buffer-full"

      # vmalert è§„åˆ™è¯„ä¼°å¤±è´¥
      - alert: VMAlertRuleErrors
        expr: increase(vmalert_alerting_rules_error_total[5m]) > 0
        for: 2m
        labels:
          severity: warning
          priority: P2
          category: monitoring
          component: alerting
        annotations:
          summary: "âš ï¸ vmalert å‘Šè­¦è§„åˆ™è¯„ä¼°å¤±è´¥"
          description: |
            **å¤±è´¥æ¬¡æ•°**: è¿‘ 5 åˆ†é’Ÿæœ‰ {{ $value }} æ¬¡è¯„ä¼°å¤±è´¥

            **å¯èƒ½åŸå› **:
            - å‘Šè­¦è§„åˆ™è¯­æ³•é”™è¯¯
            - VictoriaMetrics æŸ¥è¯¢è¶…æ—¶
            - æŒ‡æ ‡æ•°æ®ä¸å­˜åœ¨

            **å¤„ç†æ­¥éª¤**:
            1. æŸ¥çœ‹ vmalert æ—¥å¿—: `docker logs vmalert`
            2. æ£€æŸ¥å‘Šè­¦è§„åˆ™æ–‡ä»¶è¯­æ³•
            3. æµ‹è¯• PromQL è¡¨è¾¾å¼
          runbook_url: "https://your-wiki.com/runbooks/vmalert-rule-errors"

      # Alertmanager é€šçŸ¥å‘é€å¤±è´¥
      - alert: AlertmanagerNotificationsFailed
        expr: increase(alertmanager_notifications_failed_total[5m]) > 0
        for: 2m
        labels:
          severity: warning
          priority: P2
          category: monitoring
          component: notification
        annotations:
          summary: "âš ï¸ Alertmanager å‘Šè­¦é€šçŸ¥å‘é€å¤±è´¥"
          description: |
            **å¤±è´¥æ¬¡æ•°**: è¿‘ 5 åˆ†é’Ÿæœ‰ {{ $value }} æ¬¡é€šçŸ¥å¤±è´¥

            **å¯èƒ½åŸå› **:
            - é‚®ä»¶æœåŠ¡å™¨ä¸å¯è¾¾
            - Webhook åœ°å€é”™è¯¯
            - è®¤è¯ä¿¡æ¯è¿‡æœŸ

            **å¤„ç†æ­¥éª¤**:
            1. æŸ¥çœ‹ Alertmanager æ—¥å¿—: `docker logs alertmanager`
            2. æ£€æŸ¥æ¥æ”¶å™¨é…ç½®
            3. æµ‹è¯•é€šçŸ¥æ¸ é“è¿é€šæ€§
          runbook_url: "https://your-wiki.com/runbooks/alertmanager-notifications-failed"

# ===================================================================
# å‘Šè­¦è§„åˆ™è¯´æ˜:
#
# 1. ç›‘æ§ç³»ç»Ÿå‘Šè­¦ä¼˜å…ˆçº§:
#    - æ‰€æœ‰æ ¸å¿ƒç»„ä»¶å®•æœº: P0ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
#    - å­˜å‚¨ç©ºé—´ä¸è¶³ Critical: P0
#    - å…¶ä»–æ€§èƒ½é—®é¢˜: P2
#
# 2. å‘Šè­¦æŠ‘åˆ¶:
#    - VictoriaMetrics å®•æœºæ—¶ï¼ŒæŠ‘åˆ¶æ‰€æœ‰å…¶ä»–ç›‘æ§å‘Šè­¦
#    - vmagent å®•æœºæ—¶ï¼ŒæŠ‘åˆ¶ TargetDown å‘Šè­¦
#
# 3. è‡ªæ„ˆèƒ½åŠ›:
#    - å»ºè®®é…ç½® Docker restart policy
#    - å»ºè®®é…ç½®ç£ç›˜ç©ºé—´ç›‘æ§å’Œè‡ªåŠ¨æ¸…ç†
#
# æ›´å¤šæ–‡æ¡£: docs/MONITORING-SYSTEM-GUIDE.md
# ===================================================================

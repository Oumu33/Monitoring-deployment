# ===================================================================
# å¤šä¸»æœºéƒ¨ç½²é…ç½®ç¤ºä¾‹
# ç”¨é€”ï¼šå±•ç¤ºå¦‚ä½•åœ¨å¤šå°ä¸»æœºä¸Šéƒ¨ç½²ç»„ä»¶ï¼Œä»¥åŠé…ç½®æŒ‡å‘é—®é¢˜
# ===================================================================

# åœºæ™¯ï¼š3 å°ä¸»æœº
#   - Server-1 (192.168.1.10): VictoriaMetrics + Grafanaï¼ˆæ ¸å¿ƒç»„ä»¶ï¼‰
#   - Server-2 (192.168.1.20): vmagent + Node Exporterï¼ˆç›‘æ§é‡‡é›†ï¼‰
#   - Server-3 (192.168.1.30): Loki + Promtailï¼ˆæ—¥å¿—ç»„ä»¶ï¼‰

# ===================================================================
# Server-1 (192.168.1.10) - æ ¸å¿ƒç»„ä»¶
# ===================================================================
# æ–‡ä»¶: server-1/docker-compose.yml

version: '3.8'

services:
  victoriametrics:
    image: victoriametrics/victoria-metrics:latest
    container_name: victoriametrics
    ports:
      - "8428:8428"
    volumes:
      - vmdata:/storage
    command:
      - "--storageDataPath=/storage"
      - "--httpListenAddr=:8428"
      - "--retentionPeriod=12"
      - "--httpListenAddr=0.0.0.0:8428"  # ç›‘å¬æ‰€æœ‰ç½‘å¡ï¼Œå…è®¸å…¶ä»–ä¸»æœºè®¿é—®
    restart: unless-stopped
    networks:
      - monitoring

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    depends_on:
      - victoriametrics
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning
      - ./config/grafana/dashboards:/var/lib/grafana/dashboards
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_INSTALL_PLUGINS=grafana-clock-panel
    restart: unless-stopped
    networks:
      - monitoring

volumes:
  vmdata:
  grafana-data:

networks:
  monitoring:
    driver: bridge

# ===================================================================
# Server-2 (192.168.1.20) - ç›‘æ§é‡‡é›†ç»„ä»¶
# ===================================================================
# æ–‡ä»¶: server-2/docker-compose.yml

version: '3.8'

services:
  vmagent:
    image: victoriametrics/vmagent:latest
    container_name: vmagent
    ports:
      - "8429:8429"
    volumes:
      - ./config/vmagent/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./config/vmagent/targets:/etc/prometheus/targets
      - vmagentdata:/vmagentdata
    command:
      - "--promscrape.config=/etc/prometheus/prometheus.yml"
      # ğŸ”‘ å…³é”®é…ç½®ï¼šæŒ‡å‘ Server-1 çš„ VictoriaMetrics
      - "--remoteWrite.url=http://192.168.1.10:8428/api/v1/write"
    restart: unless-stopped
    networks:
      - monitoring

  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    ports:
      - "9100:9100"
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--path.rootfs=/rootfs'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    restart: unless-stopped
    networks:
      - monitoring

volumes:
  vmagentdata:

networks:
  monitoring:
    driver: bridge

# ===================================================================
# Server-3 (192.168.1.30) - æ—¥å¿—ç»„ä»¶
# ===================================================================
# æ–‡ä»¶: server-3/docker-compose.yml

version: '3.8'

services:
  loki:
    image: grafana/loki:latest
    container_name: loki
    ports:
      - "3100:3100"
    volumes:
      - ./config/loki/loki.yml:/etc/loki/local-config.yaml
      - lokidata:/loki
    command:
      - "-config.file=/etc/loki/local-config.yaml"
      - "--httpListenAddr=0.0.0.0:3100"  # ç›‘å¬æ‰€æœ‰ç½‘å¡
    restart: unless-stopped
    networks:
      - monitoring

  promtail:
    image: grafana/promtail:latest
    container_name: promtail
    depends_on:
      - loki
    volumes:
      - ./config/promtail/promtail.yml:/etc/promtail/config.yml
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    command:
      - "-config.file=/etc/promtail/config.yml"
    restart: unless-stopped
    networks:
      - monitoring

volumes:
  lokidata:

networks:
  monitoring:
    driver: bridge

# ===================================================================
# é…ç½®æ–‡ä»¶ç¤ºä¾‹
# ===================================================================

# Server-2 çš„ vmagent é…ç½® (config/vmagent/prometheus.yml)
global:
  scrape_interval: 60s
  evaluation_interval: 60s

scrape_configs:
  # Node Exporter - æœ¬æœº
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['192.168.1.20:9100']  # ä½¿ç”¨æœ¬æœº IPï¼Œä¸è¦ç”¨ localhost
        labels:
          instance: 'server-2'
          env: 'production'

  # è¿œç¨‹æœåŠ¡å™¨ç›‘æ§
  - job_name: 'remote-servers'
    static_configs:
      - targets: ['192.168.1.100:9100', '192.168.1.101:9100']  # ä½¿ç”¨å®é™… IP
        labels:
          env: 'production'

# Server-2 çš„ Promtail é…ç½® (config/promtail/promtail.yml)
server:
  http_listen_port: 9080

clients:
  # ğŸ”‘ å…³é”®é…ç½®ï¼šæŒ‡å‘ Server-3 çš„ Loki
  - url: http://192.168.1.30:3100/loki/api/v1/push

scrape_configs:
  - job_name: syslog
    syslog:
      listen_address: 0.0.0.0:1514
      labels:
        job: "syslog"
        __path__: /var/log/**/*.log

# Server-1 çš„ Grafana é…ç½® (config/grafana/provisioning/datasources/victoriametrics.yml)
apiVersion: 1

datasources:
  - name: VictoriaMetrics
    type: prometheus
    access: proxy
    url: http://victoriametrics:8428
    isDefault: true

  - name: Loki
    type: loki
    access: proxy
    url: http://192.168.1.30:3100  # ğŸ”‘ å…³é”®é…ç½®ï¼šæŒ‡å‘ Server-3 çš„ Loki

# ===================================================================
# éƒ¨ç½²æ­¥éª¤
# ===================================================================

# 1. åœ¨ Server-1 ä¸Šå¯åŠ¨æ ¸å¿ƒç»„ä»¶
cd server-1
docker-compose up -d

# 2. åœ¨ Server-2 ä¸Šå¯åŠ¨ç›‘æ§é‡‡é›†ç»„ä»¶
cd server-2
docker-compose up -d

# 3. åœ¨ Server-3 ä¸Šå¯åŠ¨æ—¥å¿—ç»„ä»¶
cd server-3
docker-compose up -d

# 4. éªŒè¯è¿æ¥
# åœ¨ Server-2 ä¸Šæµ‹è¯•è¿æ¥åˆ° Server-1
curl http://192.168.1.10:8428/health

# åœ¨ Server-3 ä¸Šæµ‹è¯•è¿æ¥åˆ° Server-1
curl http://192.168.1.10:8428/health

# 5. è®¿é—® Grafana
# http://192.168.1.10:3000

# ===================================================================
# é…ç½®æŒ‡å‘è¯´æ˜
# ===================================================================

# 1. å®¹å™¨å vs IP åœ°å€
#    - å•æœºéƒ¨ç½²ï¼šä½¿ç”¨å®¹å™¨åï¼ˆå¦‚ victoriametrics:8428ï¼‰
#    - å¤šæœºéƒ¨ç½²ï¼šä½¿ç”¨ IP åœ°å€ï¼ˆå¦‚ 192.168.1.10:8428ï¼‰

# 2. ç›‘å¬åœ°å€é…ç½®
#    - é»˜è®¤ï¼šåªç›‘å¬ localhostï¼ˆ127.0.0.1ï¼‰
#    - å¤šæœºéƒ¨ç½²ï¼šéœ€è¦ç›‘å¬ 0.0.0.0ï¼ˆæ‰€æœ‰ç½‘å¡ï¼‰
#    - ç¤ºä¾‹ï¼š--httpListenAddr=0.0.0.0:8428

# 3. ç½‘ç»œé…ç½®
#    - ç¡®ä¿ä¸»æœºä¹‹é—´ç½‘ç»œäº’é€š
#    - æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
#    - ä½¿ç”¨ ping æˆ– telnet æµ‹è¯•è¿é€šæ€§

# 4. ç¯å¢ƒå˜é‡é…ç½®
#    - å¯ä»¥ä½¿ç”¨ .env æ–‡ä»¶é…ç½® IP åœ°å€
#    - ç¤ºä¾‹ï¼šVM_SERVER_IP=192.168.1.10
#    - åœ¨ docker-compose.yml ä¸­å¼•ç”¨ï¼š${VM_SERVER_IP}

# ===================================================================
# ç½‘ç»œé…ç½®ç¤ºä¾‹
# ===================================================================

# ä½¿ç”¨ .env æ–‡ä»¶é…ç½® IP åœ°å€
# æ–‡ä»¶: .env.multihost

# Server-1 é…ç½®
VM_SERVER_IP=192.168.1.10
LOKI_SERVER_IP=192.168.1.30

# åœ¨ docker-compose.yml ä¸­ä½¿ç”¨å¼•ç”¨
# vmagent:
#   command:
#     - "--remoteWrite.url=http://${VM_SERVER_IP}:8428/api/v1/write"

# ===================================================================